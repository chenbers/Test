<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
	            xmlns:ui="http://java.sun.com/jsf/facelets"
	            xmlns:h="http://java.sun.com/jsf/html" 
	            xmlns:rich="http://richfaces.org/rich"
	            xmlns:a4j="http://richfaces.org/a4j"
	            xmlns:c="http://java.sun.com/jstl/core"
	            xmlns:f="http://java.sun.com/jsf/core"
	            xmlns:t="http://myfaces.apache.org/tomahawk"
	            xmlns:pretty="http://ocpsoft.com/prettyfaces">
	            
 	<t:saveState value="#{bean}"/>
	            
     <h:form id="redFlagsTableForm">
    <rich:jQuery selector="document" query="ready(function(){initializeTable()})" />
    <a4j:queue requestDelay="500"/>
    <div class="datagrid_panel" style="width:925px; overflow: auto">
        <rich:dataTable value="#{tableData}" id="items" var="item" rowKeyVar="index" styleClass="datagrid" 
        				rowClasses="tableOdd,tableEven" cellspacing="1" rows="#{numRowsPerPg}" width="100%">

            <!-- Data -->
            <rich:column id="mapColumn">
                <h:graphicImage value="/images/ico_map.png" id="mapIcon" styleClass="clickable-map-icon" >
                    <rich:componentControl for="eventLocationModal" event="onclick" disableDefault="true" operation="show">
                        <f:param name="lat" value="#{item.redFlag.event.latitude}" />
                        <f:param name="lng" value="#{item.redFlag.event.longitude}" />
                  		<f:param name="zonePoints" value="#{item.zone.pointsString}" />
                  		<f:param name="noteID" value="#{item.redFlag.event.noteID}" />
                    </rich:componentControl>
                </h:graphicImage>
                <rich:toolTip id="addressToolTip" mode="ajax">
                	<div id="address">
	                    <h:outputText rendered="#{item.zone eq null}" value="#{item.redFlag.event.latLng}" converter="#{latLngAddressConverter}" />
	                    <h:outputText rendered="#{item.zone ne null}" value="#{item.zone.name}" />
                    </div>
                </rich:toolTip>
                
                	<div id="#{item.redFlag.event.noteID}" style="display: none;">
                	<h:panelGrid columns="2" styleClass="google_popup" width="230" rowClasses="google_popups_rows" headerClass="google_popups_header">
						<f:facet name="header">
                            <pretty:link mappingId="driverPerformance">
                                <f:param value="#{item.redFlag.event.driver.driverID}"/>
                                #{item.driverName}
                            </pretty:link>
						</f:facet>
						<h:outputText rendered="#{item.zone ne null}" value="#{messages.zones_zone}"/>
						<h:outputText rendered="#{item.zone ne null}" value="#{item.zone.name}" />
						
						<h:outputText value="#{messages.notes_redflags_date}"/>
						<h:outputText value="#{item.date}" />
                		
                		<h:outputText value="#{messages.notes_redflags_detail}"/>
						<h:outputText value="#{item.detail}" />
                	</h:panelGrid>
                	</div>
                	
              
            </rich:column>
            <rich:column rendered="#{tableColumns['level'].visible}" sortBy="#{item.redFlag.level}">
                <f:facet name="header">
                    <h:outputText value="#{messages.notes_redflags_level}" />
                </f:facet>
                <ui:param name="descriptionKey" value="redFlag_#{item.description}"/>
                <h:outputText styleClass="ls_tab_#{item.redFlag.level}" value="#{messages[descriptionKey]}" />
            </rich:column>
            <rich:column rendered="#{tableColumns['alerts'].visible}" sortBy="#{item.redFlag.alert}">
                <f:facet name="header">
                    <h:outputText value="#{messages.notes_redflags_alerts}" />
                </f:facet>
                <h:outputText value="#{(item.redFlag.alert) ? messages.yes : messages.no }" />
            </rich:column>
            <rich:column id="time" rendered="#{tableColumns['date'].visible}" sortBy="#{item.redFlag.event.time}" sortOrder="DESCENDING">
                <f:facet name="header">
                    <h:outputText value="#{messages.notes_redflags_date}" />
                </f:facet>
                <h:outputText value="#{item.date}" />
            </rich:column>
            <rich:column rendered="#{tableColumns['group'].visible}" sortBy="#{item.group}">
                <f:facet name="header">
                    <h:outputText value="#{messages.notes_redflags_group}" />
                </f:facet>
                <h:outputText value="#{item.group}" />
            </rich:column>
            <rich:column rendered="#{tableColumns['driver'].visible}" sortBy="#{item.driverName}">
                <f:facet name="header">
                    <h:outputText value="#{messages.notes_redflags_driver}" />
                </f:facet>
                <pretty:link mappingId="driverPerformance" rendered="#{item.driverName ne 'Unknown Driver'}">
                	<f:param value="#{item.redFlag.event.driver.driverID}"/>
                                #{item.driverName}
                </pretty:link>
                <h:outputText value="#{messages.unknown_driver}" 
                	rendered="#{item.driverName eq 'Unknown Driver'}"/>
            </rich:column>
            <rich:column rendered="#{tableColumns['vehicle'].visible}" sortBy="#{item.vehicleName}">
                <f:facet name="header">
                    <h:outputText value="#{messages.notes_redflags_vehicle}" />
                </f:facet>
                <pretty:link mappingId="vehiclePerformance">
                    <f:param value="#{item.redFlag.event.vehicle.vehicleID}"/>
                    #{item.vehicleName}
                </pretty:link>
            </rich:column>
            <rich:column rendered="#{tableColumns['category'].visible}" sortBy="#{item.category}">
                <f:facet name="header">
                    <h:outputText value="#{messages.notes_redflags_category}" />
                </f:facet>
                <ui:param name="categoryKey" value="redflags_cat#{item.category}"/>
                <h:outputFormat value="#{messages[categoryKey]}" >
                	<f:param value="#{messages[item.eventType]}"/>
                </h:outputFormat>
            </rich:column>
            <rich:column rendered="#{tableColumns['detail'].visible}" sortBy="#{item.detail}" >
                <f:facet name="header">
                    <h:outputText value="#{messages.notes_redflags_detail}" />
                </f:facet>
                <h:outputText value="#{item.detail}" />
            </rich:column>
            <rich:column rendered="#{tableColumns['clear'].visible}" >
                <f:facet name="header">
                    <h:outputText value="" />
                </f:facet>
                 
 								<a4j:commandLink id="redFlagsTableClear" rendered="#{item.redFlag.event.forgiven == 0}" 
 										title="#{messages.notes_redflags_clear}" 
 										oncomplete="javascript:Richfaces.showModalPanel('clearRedFlagPanel');" 
 										reRender="clearItemForm:clearItem" >
									<h:outputText value="#{messages.notes_redflags_clear}" />
									<f:setPropertyActionListener target="#{bean.clearItem}" value="#{item}" />
								</a4j:commandLink>
 								<a4j:commandLink id="redFlagsTable_excluded" rendered="#{item.redFlag.event.forgiven == 1}" title="#{messages.driverReports_exclude}" action="#{redFlagsBean.includeEventAction}" 
 												reRender="#{clearRerender}" ajaxSingle="true"  oncomplete="initializeTable()">
									<h:outputText value="#{messages.driverReports_include}" />
									<f:setPropertyActionListener target="#{bean.clearItem}" value="#{item}" id="include"/>
								</a4j:commandLink>
			</rich:column>
        </rich:dataTable>

        

    </div>
    
    <rich:datascroller id="bottomScroller" for="items" 
            immediate="true" scrollerListener="#{redFlagsBean.scrollerListener}" 
            reRender="items,header" oncomplete="initializeTable();" 
            page="#{page}" styleClass="datascroller" renderIfSinglePage="false"/>
    </h:form>

    <rich:modalPanel id="clearRedFlagPanel" headerClass="popupHeader" controlsClass="popupControls" width="500" height="50" autosized="true" resizeable="false" zindex="2000"
        onshow="document.getElementById('clearItemForm:redFlagsTableYes').focus();">
        <f:facet name="header">
            <h:outputText value="#{messages.notes_redflags_clearTitle}" />
        </f:facet>
        <f:facet name="controls">
            <h:graphicImage value="/images/modal_close.png" style="cursor:pointer" onclick="Richfaces.hideModalPanel('clearRedFlagPanel')" />
        </f:facet>

        <h:panelGroup layout="block" styleClass="popupsubtitle">
            <h:outputText value="#{messages.notes_redflags_clearInst}" />
        </h:panelGroup>

        <a4j:form id="clearItemForm">
            <h:panelGroup layout="block" styleClass="popupcontent" id="clearItem">
                <h:outputText value="#{redFlagsBean.clearItem.detail}" />
                <br />
                <h:outputText value="#{redFlagsBean.clearItem.date}" />
            </h:panelGroup>

            <div class="popupactions">
            <button type="submit" class="left" onclick="Richfaces.hideModalPanel('clearRedFlagPanel'); return false;"><span class="no"><h:outputText
                value="#{messages.button_no}" /></span></button>
            <a4j:commandButton id="redFlagsTableYes" action="#{redFlagsBean.excludeEventAction}" oncomplete="Richfaces.hideModalPanel('clearRedFlagPanel'); initializeTable()"
                onkeypress="if (event &amp;&amp; event.keyCode == 13) return false; return true;" reRender="#{clearRerender}" styleClass="left"
                eventsQueue="redFlagsTableForm" >
                <span class="yes"> <h:outputText value="#{messages.button_yes}" /> </span>
            </a4j:commandButton></div>

        </a4j:form>

    </rich:modalPanel>


    <!-- START LOCATION MODAL -->
    <rich:modalPanel id="eventLocationModal" width="540" height="450" headerClass="popupHeader" onshow="initializeMap(event.parameters.lat, event.parameters.lng, event.parameters.zonePoints, event.parameters.noteID);" onhide="GUnload()">
        <f:facet name="header">
            <h:outputText id="mapModalHeader" value="Event Location" />
        </f:facet>
        <f:facet name="controls">
            <h:graphicImage value="/images/modal_close.png" style="cursor:pointer" onclick="Richfaces.hideModalPanel('eventLocationModal')" />
        </f:facet>

        <div class="eventmap-border">
        	<div id="address-canvas" style="width: 522px; height: 355px; border: 0"></div>
        </div>

        <div class="popupactions"><a4j:commandButton id="redFlagsTableClose" value="#{messages.button_close}" onclick="Richfaces.hideModalPanel('eventLocationModal')" styleClass="left">
            <span class="edit"> <h:outputText value="#{messages.button_close}" /></span>
        </a4j:commandButton></div>
    </rich:modalPanel>
    <!-- END LOCATION MODAL -->

</ui:composition>
<ui:composition xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:ui="http://java.sun.com/jsf/facelets"
  	xmlns:h="http://java.sun.com/jsf/html" 
  	xmlns:f="http://java.sun.com/jsf/core" 
  	xmlns:a4j="http://richfaces.org/a4j"
  	xmlns:rich="http://richfaces.org/rich"
  	xmlns:security="http://pro.tiwi.com/jsf/security"
    xmlns:pretty="http://ocpsoft.com/prettyfaces">
    
<a4j:loadScript src="/js/jsTree/jquery.tree.js"/>

<style type="text/css">


#tree_link:hover {
	background: url("#{request.contextPath}/images/tree_button_pressed.gif") no-repeat center center;
}
#tree_link{
	background: url("#{request.contextPath}/images/tree_button_unpressed.gif") no-repeat center center;
	height: 38px;
	float: right;
	padding: 0 25px 0 0;
}



.tree ul ins {
	height: 18px;
}

.tree li {
	padding: 0px 5px 2px 15px;
}

.tree_back { float:left; margin:0; border:1px solid green; font-family:Verdana; font-size:10px; background:white; padding: 10px 0; width: 100% }
.recent_back { margin:0; padding-bottom:5px;border-top:1px solid green; border-right:1px solid green;border-left:1px solid green;font-family:Verdana; font-size:10px; background:white; width: 100%}
.recent_back li a:active,.recent_back li a:link,.recent_back li a:hover,.recent_back li a:visited
	{
	color: #333;
	text-decoration: none;
}

.selectedNavigationTreeNode {
	font-weight: bold;
}

.dropBox{
	display: none;
	z-index:100;
	position: absolute;
	left:421px;
	top:130px;
}
</style>

<script type="text/javascript">

var timeout    = 1000;
var closetimer = 0;

	jQuery(function(){
		getNavigationTreeData();
	jQuery("#tree_link").click(function(){
		jQuery(".dropBox").css("display","block");
	});
	
	jQuery("#navigationTree").bind("mouseleave",navigationTree_timer);

	jQuery("#navigationTree").bind("mouseover",navigationTree_canceltimer);
	
});

	function buildNavigationTree(dataFromServer){
		jQuery("#navigationTree").tree({
			ui : {
				theme_name : "classic"
			},
			
			types : {

				"default" : {
					draggable	: false,
					deletable : false,
					renameable : false,
					creatable : false
				},
				"fleet" : {
					icon : { 
						image : "#{request.contextPath}/images/ico_truck.png"
					}
				},
				"group" : {
					icon : { 
						image : "#{request.contextPath}/images/ico_trucks.png"
					}
				},
				"team" : {
					icon : { 
						image : "#{request.contextPath}/images/ico_team.png"
					}
				}
			},
			callback : {
				onchange : function (NODE, TREE_OBJ) {
//					var groupID = jQuery(NODE).attr("groupid");
				
					document.location.href = jQuery(NODE).children("a:eq(0)").attr("href");

				}	
			},
			data : { 
					type : "json",
					opts : {
						static :dataFromServer.navigationTree
				}
			}
		}
	);	
	}

	function navigationTree_close(){
		jQuery(".dropBox").css("display","none");
	}

	function navigationTree_timer(){
	  closetimer = window.setTimeout(navigationTree_close, timeout);
	}

	function navigationTree_canceltimer()
	{  if(closetimer)
	   {  window.clearTimeout(closetimer);
	      closetimer = null;
	   }
    }
</script>
 	
 <!--<div id="tree_nav"><a id="tree_link" href="#"></a></div>-->
 
 <div id="navigationTreeBox" class="dropBox">
 
 <rich:panel id="recents" styleClass="recent_back" rendered="#{treeNavigationBean.renderRecentNodes}">
 <h:form>
 <p style="text-indent:5px">#{messages.navigation_recents}</p>
 <rich:dataList type="none" value="#{treeNavigationBean.recentNodes}" 
 		var="recent" rendered="#{treeNavigationBean.renderRecentNodes}">
               <pretty:link id="#{context}-dashboard-recents" mappingId="dashboard" title="#{recent.fullPath}">
                  <h:outputText value="#{recent.data.title}"/>
                  <f:param value="#{recent.attributes['groupid']}"/>
               </pretty:link>
 </rich:dataList>
 </h:form>
 </rich:panel>
<div id="navigationTree" class="tree_back">
</div>
</div>		
<div class="main_nav">
	<div class="main_nav-right"></div>
	<div class="main_nav-left"></div>
	<div class="main_nav-bg">
 <!-- check in with roles stuff -->   
	<h:form id="navigation" > 
		<ul>
		
			<li class="current">
                <pretty:link id="#{context}-navigationInitDashboard" mappingId="init-dashboard"><span style="padding: 0 5px 0 0; width: 65px">#{messages.navigation_home}<span onclick="return false;" id="tree_link"></span></span></pretty:link>
 			</li>
			<li class="#{reportsSelected}">
                <pretty:link id="#{context}-navigationReports" mappingId="reports"><span>#{messages.navigation_reports}</span></pretty:link>
			</li>
			<li class="#{notificationsSelected}">
                <pretty:link id="#{context}-navigationNotifications" mappingId="notifications"><span>#{messages.navigation_notifications}</span></pretty:link>
			</li>
			<security:authorize ifAnyGranted="ROLE_ADMIN, ROLE_LIVEFLEETACCESS">
    			<li class="#{liveFleetSelected}">
                    <pretty:link id="#{context}-navigationLiveFleet" mappingId="liveFleet"><span>#{messages.navigation_liveFleet}</span></pretty:link>
    			</li>
			</security:authorize>
			<security:authorize ifAnyGranted="ROLE_ADMIN">
				<li class="#{adminSelected}">
                    <pretty:link id="#{context}-navigationAdmin" mappingId="admin"><span>#{messages.navigation_admin}</span></pretty:link>
				</li>
			</security:authorize>
			<security:authorize ifAnyGranted="ROLE_ADMIN_SUBSET">
<!--			<ui:param name="firstAccessPoint" value="#{myAccountBean.user.accessPoints[0].siteAccessPoint}"/>
			<ui:param name="defaultPage" value="#{myAccountBean.user.accessPoints[0].siteAccessPoint.messageKey}"/>
-->			
			<ui:param name="firstAccessPoint" value="#{myAccountBean.user.accessPoints[0].accessPtID}"/>
			<ui:param name="defaultPage" value="#{siteAccessPoints.accessPointsMap[firstAccessPoint].msgKey}"/>
			
				<li class="#{adminSelected}">
                    <pretty:link id="#{context}-navigationAdminSubset" mappingId="admin#{defaultPage}"><span>#{messages.navigation_admin}</span></pretty:link>
				</li>
			</security:authorize>
			<li style="float:right">
				<table width="250" border="0" cellspacing="0" cellpadding="0" id="menu_search_box">
				  <tr>
					<td class="left">
						<h:graphicImage value="/images/search_box_left.png" />
					</td>
					<td width="105" height="100" class="middle">
                      <!-- What the? I thought the same thing. This hidden field is needed for the enter key to work in IE -->
                      <h:inputText id="#{context}-hiddenField" value="hiddenField" style="display:none"/>
					  <h:inputText id="#{context}-redirectSearch" value="#{searchCoordinationBean.searchFor}" styleClass="text" size="15"/>
					</td>
                    <td class="middle">
                      <h:selectOneMenu id="#{context}-navigationRedirectTo" value="#{searchCoordinationBean.navigation}" styleClass="text" >
                        <f:selectItem itemLabel="#{messages.navigation_searchDrivers}" itemValue="1"/>                         
                                      <f:selectItem itemLabel="#{messages.navigation_searchDevices}" itemValue="4"/>  
                                      <f:selectItem itemLabel="#{messages.navigation_searchIdlings}" itemValue="3"/>
                        <f:selectItem itemLabel="#{messages.navigation_searchVehicles}" itemValue="2"/>             
                      </h:selectOneMenu>
                    </td>
					<td class="middle" width="25" align="center">
                       
						<h:commandButton action="#{searchCoordinationBean.navigationAction}" id="#{context}-navigation_search_button"
										title="#{messages.navigation_searchToolTip}" image="/images/ico_search.gif"
										style="vertical-align:middle;margin-left:10px">
						</h:commandButton>
					
<!--						<input type="image" src="#{facesContext.externalContext.request.contextPath}/images/ico_search.gif" value="Find" -->
<!--                          title="#{messages.navigation_searchToolTip}"/>-->
					</td>
					<td class="right">
						<h:graphicImage value="/images/search_box_right.png" />
					</td>
				  </tr>
			  </table>
			  
			 
			  
			</li>	
		</ul>
		<a4j:jsFunction id="getNavigationTreeData" ajaxSingle="true" name="getNavigationTreeData" limitToList="true"
				data="#{treeNavigationBean.navigationTree}" oncomplete="buildNavigationTree(data)"/>
		</h:form>
	</div>
</div>
</ui:composition>

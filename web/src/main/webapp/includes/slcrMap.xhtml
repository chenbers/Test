<ui:composition 
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:f="http://java.sun.com/jsf/core"
  	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:h="http://java.sun.com/jsf/html">
	
	<script src="#{facesContext.externalContext.request.contextPath}/js/speedByStreet.js"  type="text/javascript">	
	</script>
	<script src="#{facesContext.externalContext.request.contextPath}/js/markermanager.js"  type="text/javascript">	
	</script>
	<div class="">
		<div id="map-canvas" style="#{mapwidth};#{mapheight};border:0"></div>
		<script  type="text/javascript">
			if (GBrowserIsCompatible()) {
				map = new GMap2(document.getElementById("map-canvas"));
				map.setCenter(new GLatLng(#{mapxcenter},#{mapycenter}), 10);
				map.addControl(new GLargeMapControl());
				map.addControl(new GMapTypeControl());
				map.addControl(new GOverviewMapControl()); 
				map.setMapType(G_NORMAL_MAP);					
		       	map.enableScrollWheelZoom();
        		map.enableGoogleBar();
        				       
		          var gLatLngArray;
		          var polyline;
		          var hipoly;
		          var seg;
     	GEvent.addListener(map, "click", function(overlay, point) {

        if (overlay) {
          
          	var segment = whichSegment(overlay);
          	if (segment != null){
          	
 				selectSegment(segment.id);
 			}	
          } else {
          
            reverseGeocode(point.y,point.x,"");
            
	      }
        });
        
 				<ui:repeat value="#{speedLimitChangeRequests.changeRequests}" var="changeRequestBean">
				
			        // Do polyline for segment    
			        gLatLngArray = new Array();
			         
			         <ui:repeat value="#{changeRequestBean.streetSegment}" var="point">
				           var lat = #{point.x};
				           var lng = #{point.y};
				           gLatLngArray.push(new GLatLng(lat,lng));
				  	 </ui:repeat>
			         
			         polyline = new GPolyline(gLatLngArray, "#666666", 10);
			         hipoly = new GPolyline(gLatLngArray, "#ff0000", 10);
			         seg = new StreetSegment();
			         
			         seg.initialize(#{changeRequestBean.linkId},"#{changeRequestBean.address}","#{changeRequestBean.zipCode}",
			         #{changeRequestBean.category},#{changeRequestBean.speedLimit},polyline,hipoly);
			         streetSegments.push(seg);
			        
			     	 map.addOverlay(seg.hipoly);
			     	 seg.hipoly.hide();
			         map.addOverlay(seg.polyline);
			        
			  	</ui:repeat>
  						
      }
      function reverseGeocode(lat,lng, fullAddress) {
      
      	alert("reverse geocode");
      	document.forms.segment[lat].value = lat;
      	document.forms.segment[lon].value = lon;
     
      	
      }
	</script> 
 	</div>	

	<a4j:form id="segment">
		<h:inputHidden id="lat" value="#{speedLimitChangeRequests.lat}" />
		<h:inputHidden id="lon" value="#{speedLimitChangeRequests.lon}" />
		<a4j:jsFunction name="addRequest" reRender="map-canvas" />
	</a4j:form>
</ui:composition>	
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:security="http://pro.tiwi.com/jsf/security">

	<h:panelGroup id="#{context}-mapPanel">
		
			<div class="add_section_title">#{messages.group_default_view}</div>
			<div style="width: 100%; height: 100%">
			<ui:fragment rendered="#{not readOnly}">
				<table width="100%" border="0" cellpadding="4" cellspacing="0">
					<tr>
						<td width="100">#{messages.group_find_address}</td>
						<td width="200">
							<input type="text" size="42" id="#{context}-addressTextBox" value="" tabindex="6"/>
						</td>
						<td width="50" align="left">
							<a4j:commandButton  id="#{context}-groupMapViewSearch" immediate="true" tabindex="7" 
								onclick="showAddress(document.getElementById('#{context}-addressTextBox').value);" 
								styleClass="left">
								<span class="search">
									#{messages.group_locate}
								</span>
							</a4j:commandButton>
						</td>
					</tr>
				</table>
			</ui:fragment>
			<table style="width: 100%" cellpadding="4" border="0" align="center">
				<tbody>
					<tr>
						<td style="font-weight: bold" width="100"></td>
					</tr>
					<tr>
						<td><h:panelGroup styleClass="map-border" layout="block">
							<div id="#{context}map-canvas"
								style="width: 500px; height: 500px; border: 0"></div>
							</h:panelGroup> 
							<script type="text/javascript">
							function showAddress(address) {
								  
								  var geocoder = new GClientGeocoder();
								  var zoomLookup = new Array(2,4,6,10,12,13,16,16,17);
								  geocoder.getLocations(address,
									    function(response) {
									      if(response.Status.code!=200){
									        alert('"' + address + '" not found');
									      } else {
									        var place = response.Placemark[0];
									        var accuracy = place.AddressDetails.Accuracy;
									        var point = new GLatLng(place.Point.coordinates[1],place.Point.coordinates[0]);
									        map.setCenter(point, zoomLookup[accuracy]);
											var marker = new GMarker(point);
											map.addOverlay(marker);
											marker.openInfoWindowHtml(address);
									      }
									    }
								    );
																		  
							}
							
							function clearMap(){
								portalmap.reinit();
								GUnload();
								map = null;
							}			    
							
							function initMap(){			    
								if (GBrowserIsCompatible()) {
									if (map == null) {
		 								portalmap.init(false, '#{context}map-canvas');
			 							map = portalmap.getMap();
			 							initLayers();
									}
									map.setCenter(new GLatLng(#{latValue},#{longValue}),#{zoomLevel});
						
									GEvent.addListener(map, "moveend", function() {
										  var center = map.getCenter();
										  var zoom = map.getZoom();
										  updateMapValues(center.lat(),center.lng(),zoom);
									});
									<h:outputText rendered="#{readOnly}">
										map.disableDragging();
										map.disableScrollWheelZoom();
										map.disableDoubleClickZoom();
									</h:outputText>
									<h:outputText rendered="#{not readOnly}">
										map.addControl(new GLargeMapControl());
									</h:outputText>
								}
							}
                            function updateMapValues(lat,lng,zoom){
            					
								var latField = document.getElementById('#{formName}:#{context}-latvalue');
								var longField = document.getElementById('#{formName}:#{context}-longvalue');
								var zoomField = document.getElementById('#{formName}:#{context}-zoomlevel');
				
								latField.value = lat;
								longField.value = lng;
								zoomField.value = zoom;
                                
							};
						</script> 
						<h:inputHidden id="#{context}-latvalue" value="#{latValue}" />
						<h:inputHidden id="#{context}-longvalue" value="#{longValue}" />
						<h:inputHidden id="#{context}-zoomlevel" value="#{zoomLevel}" />
						</td>
			
					</tr>
					<tr>
						<td></td>
					</tr>
				</tbody>

			</table>
			</div>
	
	</h:panelGroup>
</ui:composition>
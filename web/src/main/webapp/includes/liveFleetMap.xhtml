<ui:composition 
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:f="http://java.sun.com/jsf/core"
  	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:t="http://myfaces.apache.org/tomahawk"
    xmlns:pretty="http://ocpsoft.com/prettyfaces">
	
	<t:saveState value="#{driverLocationBean.driverLastLocationBeans}"/>
	<t:saveState value="#{driverLocationBean.legendIcons}"/>
	<t:saveState value="#{driverLocationBean.mapIconMap}"/>
	
    <ui:param name="detailImage" value="#{maximized ? '/images/ico_minimize.png': '/images/ico_expand.png'}"/>
    <ui:param name="detailTitle" value="#{maximized ? messages.restore : messages.maximize}"/>
  
	<script src="#{facesContext.externalContext.request.contextPath}/js/liveFleetMap.js"  type="text/javascript"></script>
	<script type="text/javascript">
		function bodyUnload()
		{
			GUnload();
		}
		
		function bodyLoad()
		{
			initMap(#{navigationBean.group.mapLat},#{navigationBean.group.mapLng},5);
 			addMarkers();
	    	centerMap();
		}
		function refreshMap()
		{
			mapNeedsInit = false;
			map.clearOverlays();
			addMarkers();
		}
	</script>
	<rich:panel id="scripts">
		<script type="text/javascript">
			function addMarkers()
			{
				<ui:repeat value="#{driverLocationBean.driverLastLocationBeans}" var="driverLastLocationBean">
					var latlng = new GLatLng(#{driverLastLocationBean.lastLocation.lat}, #{driverLastLocationBean.lastLocation.lng});
					var marker = createMarker(latlng, "#{driverLastLocationBean.driver.driverID}",
	        		 							"#{driverLocationBean.mapIconMap.icons[driverLastLocationBean.iconKey]}");
					map.addOverlay(marker);
				</ui:repeat>
			}
		</script>
		
      	<!-- BEGIN GOOGLE MAP POPUPS -->
      	<h:form>
      	<rich:panel id="mapPopups">
      		<ui:repeat value="#{driverLocationBean.driverLastLocationBeans}" var="driverLocation">		
      			<ui:include src="../includes/driverBubble.xhtml">
      	            <ui:param name="hiddenDivID" value="#{driverLocation.driver.driverID}" />
      	            <ui:param name="driver" value="#{driverLocation.driver}" />
      	        	<ui:param name="vehicle" value="#{driverLocation.vehicle}" />
      	        	<ui:param name="bean" value="#{driverLocationBean}" />
      	        	<ui:param name="targetDriverID" value="#{driverLocationBean.selectedDriverID}" />
      	        	<ui:param name="messagePriPhone" value="#{messages.livefleet_priPhone}" />
      	        	<ui:param name="messageSecPhone" value="#{messages.livefleet_secPhone}" />
      	        	<ui:param name="messageVehicle" value="#{messages.livefleet_vehicle}" />
      	        	<ui:param name="targetVehicleID" value="#{driverLocationBean.selectedVehicleID}" />
      	        	<ui:param name="messageVehicleType" value="#{messages.livefleet_vehicleType}" />
      	        	<ui:param name="messageLastUpdated" value="#{messages.livefleet_updated}" />
      	        	<ui:param name="vehicleTime" value="#{driverLocation.time}" />
      	        	<ui:param name="messageAddress" value="#{messages.livefleet_address}" />
      	        	<ui:param name="vehicleAddress" value="#{driverLocation.address}" />
      			</ui:include>
      		</ui:repeat>
      	</rich:panel>
      	</h:form>
      	<!-- END GOOGLE MAP POPUPS -->
	</rich:panel>
	<div class="">
			<div class="panel_nw">
				<div class="panel_title">
					<span class="map">#{messages.livefleet}</span>
					<span class="panel_links">
					<a4j:form id="refresh">
                        <a4j:status id="refresh_ajax_status">
                           <f:facet name="start">
                              <h:outputText>
                                          <img
                                              src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif"
                                             align="top" />&#160;</h:outputText>
                           </f:facet>
                        </a4j:status>
   						<a4j:commandButton image="/images/ico_refresh.png" immediate="true"
   							reRender="scripts" oncomplete="refreshMap()" title="#{messages.refresh}"  alt="#{messages.refresh}"
   							value="#{messages.refresh}">
   						</a4j:commandButton>
                     
                         <!-- If the details parameter is not there, do not show the details image link -->
                         <ui:fragment rendered="#{detailLink ne null}">
                            <rich:spacer width="5px"></rich:spacer>
                            <h:outputLink value="#{detailLink}" title="#{detailTitle}" >
                               <h:graphicImage value="#{detailImage}" />
                            </h:outputLink>
                         </ui:fragment>
                         
					</a4j:form>
					</span>
				</div>
			</div>
			<div class="panel_w">
				
			 	 <rich:panel  id="map">
					<div class="panel_content">
						<h:form name="maplinks2"> <div id="map-canvas" style="#{mapwidth};#{mapheight};border:0"></div></h:form>
 					</div>
				 </rich:panel>
			</div>		
																		
			<div class="panel_sw">
				<div class="panel_statusbar"></div>
			</div>
   </div>	
   <div class="spacer"></div>		
   <div>
   		<div class="panel_nw">
   			<div class="panel_title">
   				<span class="legend">#{messages.livefleet_legend_header}</span>
   				<span class="panel_links"></span>
   			</div>
   		</div>	
      	<div class="panel_w">
      		<div class="panel_content">
      		  
      		  <rich:dataGrid value="#{driverLocationBean.legendIcons}" var="icon" styleClass="carlegend" columnClasses="carlegend" rowClasses="carlegend"
      		  			rendered="#{driverLocationBean.teamLevel}" columns="3" border="0" cellpadding="5" cellspacing="5">
      		  			
      			  	<div onclick="showInfoWindow('#{icon.entityID}', new GLatLng(#{icon.lat},#{icon.lng}))" style="cursor: pointer;">
      				  	<img src="#{icon.iconURL}" style="vertical-align:middle"/> 
      				  	<h:outputText value="#{icon.caption}" style="margin-left:5px" /></div>
      			  	
      		</rich:dataGrid>
      		  <rich:dataGrid value="#{driverLocationBean.legendIcons}" var="icon" styleClass="carlegend" columnClasses="carlegend" rowClasses="carlegend"
      		  		rendered="#{!driverLocationBean.teamLevel}"  columns="3" border="0" cellpadding="5" cellspacing="5">
      		  		<img src="#{icon.iconURL}" style="vertical-align:middle"/> 
      			  	<h:outputText value="#{icon.caption}" style="margin-left:5px"></h:outputText>
      		  </rich:dataGrid>
      		  <div style="clear:both"/>
      		</div>
      	</div>
   
      	<div class="panel_sw">
      		<div class="panel_statusbar"></div>
      	</div>
   </div>
			
</ui:composition>	

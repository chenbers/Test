<ui:composition 
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:f="http://java.sun.com/jsf/core"
  	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:t="http://myfaces.apache.org/tomahawk">
	
	<t:saveState value="#{driverLocationBean.driverLastLocationBeans}"/>
	<t:saveState value="#{driverLocationBean.legendIcons}"/>
	<t:saveState value="#{driverLocationBean.mapIconMap}"/>
	
        <c:choose>
          <c:when test="#{flyOutImage == 'ico_minimize.png'}">
            <c:set var="flyoutTitle" value="#{messages.flyout_restore}" />
          </c:when>
          <c:otherwise>
            <c:set var="flyoutTitle" value="#{messages.flyout_maximize}" />
          </c:otherwise>
        </c:choose>  
  
		<script src="#{facesContext.externalContext.request.contextPath}/js/liveFleetMap.js"  type="text/javascript"></script>
		<script type="text/javascript">
			function bodyUnload()
			{
				GUnload();
			}
			
			function bodyLoad()
			{
				initMap(#{navigationBean.group.mapLat},#{navigationBean.group.mapLng},5);
	 			addMarkers();
		    	centerMap();
			}
			function refreshMap()
			{
				mapNeedsInit = true;
				map.clearOverlays();
				bodyLoad();
			}
		</script>
		<rich:panel id="scripts">
		<script type="text/javascript">
			function addMarkers()
			{
				<ui:repeat value="#{driverLocationBean.driverLastLocationBeans}" var="driverLastLocationBean">
					var latlng = new GLatLng(#{driverLastLocationBean.lastLocation.lat}, #{driverLastLocationBean.lastLocation.lng});
					var marker = createMarker(latlng, "#{driverLastLocationBean.driver.driverID}",
	        		 							"#{driverLocationBean.mapIconMap.icons[driverLastLocationBean.iconKey]}");
					map.addOverlay(marker)
					//mgr.addMarker(marker,0);
				</ui:repeat>
			}
		</script>
		
	<!-- BEGIN GOOGLE MAP POPUPS -->
	<h:form>
	<rich:panel id="mapPopups">
		<ui:repeat value="#{driverLocationBean.driverLastLocationBeans}" var="driverLocation">		
			<ui:include src="../includes/driverBubble.xhtml">
	            <ui:param name="hiddenDivID" value="#{driverLocation.driver.driverID}" />
	            <ui:param name="driver" value="#{driverLocation.driver}" />
	        	<ui:param name="vehicle" value="#{driverLocation.vehicle}" />
	        	<ui:param name="bean" value="#{driverLocationBean}" />
	        	<ui:param name="targetDriverID" value="#{driverLocationBean.selectedDriverID}" />
	        	<ui:param name="messagePriPhone" value="#{messages.livefleet_priPhone}" />
	        	<ui:param name="messageSecPhone" value="#{messages.livefleet_secPhone}" />
	        	<ui:param name="messageVehicle" value="#{messages.livefleet_vehicle}" />
	        	<ui:param name="targetVehicleID" value="#{driverLocationBean.selectedVehicleID}" />
	        	<ui:param name="messageVehicleType" value="#{messages.livefleet_vehicleType}" />
	        	<ui:param name="messageLastUpdated" value="#{messages.livefleet_updated}" />
	        	<ui:param name="vehicleTime" value="#{driverLocation.time}" />
	        	<ui:param name="messageAddress" value="#{messages.livefleet_address}" />
	        	<ui:param name="vehicleAddress" value="#{driverLocation.address}" />
			</ui:include>
		</ui:repeat>
	</rich:panel>
	</h:form>
	<!-- END GOOGLE MAP POPUPS -->
		</rich:panel>
		<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="map">#{messages.livefleet}</span>
						<span class="panel_links">
						<a4j:form id="refresh">
						<a4j:commandButton image="/images/ico_refresh.png" immediate="true"
							reRender="scripts" oncomplete="refreshMap()" title="#{messages.refresh}" alt="#{messages.refresh}"
							value="#{messages.refresh}">
						</a4j:commandButton>
						<rich:spacer width="2" />
			   			<h:commandLink action="#{flyOutBean.flyNavRuleAction}" rendered="#{!driverLocationBean.teamLevel}">
			   				<img src="#{facesContext.externalContext.request.contextPath}/images/#{flyOutImage}" border="0" title="#{flyoutTitle}" />
			   				<f:setPropertyActionListener value="#{flyNavRule}" target="#{flyOutBean.navigationRule}" />
			   				<f:setPropertyActionListener value="#{flySelectedTab}" target="#{flyOutBean.selectedTab}" />
			   			</h:commandLink>
						</a4j:form>
						</span>
					</div>
				</div>
				<div class="panel_w">
					
				 	 <rich:panel  id="map">
						<div class="panel_content">
								<h:form name="maplinks2"> <div id="map-canvas" style="#{mapwidth};#{mapheight};border:0"></div></h:form>
	 					</div>
 					 </rich:panel>
 				</div>		
																					
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>	
				
				<div class="spacer"></div>		
				<div class="">
					<div class="panel_nw">
						<div class="panel_title">
							<span class="legend">#{messages.livefleet_legend_header}</span>
							<span class="panel_links"></span>
						</div>
					</div>	
	 				<div class="panel_w">
						<div class="panel_content">
						  
						  <rich:dataList value="#{driverLocationBean.legendIcons}" var="icon" styleClass="legend" 
						  			rendered="#{driverLocationBean.teamLevel}">
							  	<div onclick="showInfoWindow('#{icon.entityID}', new GLatLng(#{icon.lat},#{icon.lng}))" style="cursor: pointer;">
		 						  	<img src="#{icon.iconURL}" style="vertical-align:middle"/> 
								  	<h:outputText value="#{icon.caption}" style="margin-left:5px" /></div>
							  	
						</rich:dataList>
						  <rich:dataList value="#{driverLocationBean.legendIcons}" var="icon" styleClass="legend" 
						  		rendered="#{!driverLocationBean.teamLevel}">
						  		<img src="#{icon.iconURL}" style="vertical-align:middle"/> 
							  	<h:outputText value="#{icon.caption}" style="margin-left:5px"></h:outputText>
						  </rich:dataList>
						  <div style="clear:both"/>
	  					</div>
					</div>
	
					<div class="panel_sw">
						<div class="panel_statusbar"></div>
					</div>
					</div>
			
</ui:composition>	

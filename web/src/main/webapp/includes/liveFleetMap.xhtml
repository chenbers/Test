<ui:composition 
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:f="http://java.sun.com/jsf/core"
  	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:t="http://myfaces.apache.org/tomahawk"
    xmlns:pretty="http://ocpsoft.com/prettyfaces">
	
	<t:saveState value="#{driverLocationBean.driverLocations}"/>
	<t:saveState value="#{driverLocationBean.legendIcons}"/>
	<t:saveState value="#{driverLocationBean.mapIconMap}"/>
	<t:saveState value="#{driverLocationBean.driverLocationsMap}"/>
	<t:saveState value="#{driverLocationBean.selectedDriverID}"/>
	
    <ui:param name="detailImage" value="#{maximized ? '/images/ico_minimize.png': '/images/ico_expand.png'}"/>
    <ui:param name="detailTitle" value="#{maximized ? messages.restore : messages.maximize}"/>
     
    <a4j:loadScript src="/js/mapBubble.js"/>
	
    <a4j:loadScript src="http://gmaps-utility-library.googlecode.com/svn/trunk/markerclusterer/1.0/src/markerclusterer_packed.js"/>
    <a4j:loadScript src="http://gmaps-utility-library.googlecode.com/svn/trunk/progressbarcontrol/1.0/src/progressbarcontrol_packed.js"/>
    
 	<ui:include src="/includes/WMSMapLayers.xhtml"/>	
  
	<script type="text/javascript">

	  	var map;
	  	var markerClusterer;
		var markers = [];
	  	var mapNeedsInit = true;
	  	var overviewMapControl;
	    var baseIcon = new GIcon();
		baseIcon.iconSize = new GSize(25, 30);
		baseIcon.iconAnchor = new GPoint(6, 20);
		baseIcon.infoWindowAnchor = new GPoint(5, 1);
		baseIcon.shadow=null;

	  	function initMap(lat,lng,zoom)
	  	{
			if (GBrowserIsCompatible()) {
				
				if(mapNeedsInit == true)
				{
			 		map = new GMap2(document.getElementById("map-canvas"));
			 		mapNeedsInit = false;
				}
			    addLayers();

			    map.addControl(new GLargeMapControl());
			    map.addControl(new GScaleControl());
			    map.addControl(new GMenuMapTypeControl(true));

				map.setCenter(new GLatLng(lat, lng));
			    map.enableScrollWheelZoom();

				addListeners();
				
		 		overviewMapControl = new GOverviewMapControl();
		 		map.addControl(overviewMapControl); 
				bounds = new GLatLngBounds();
			    overviewMapControl.hide();
	    		geocoder =new GClientGeocoder();
			}
		}
	  	function centerMap() 
	  	{
	  		map.setZoom(map.getBoundsZoomLevel(bounds)-1);
		    map.setCenter(bounds.getCenter());
		}
	       
		// Creates a marker whose info window displays the link tot the driver corresponding
	   // to the given index.

		function selectMarker(lat,lng)
		{
			
			map.panTo(new GLatLng(lat, lng));
		}
		
		function bodyUnload()
		{
			GUnload();
		}
		
		function bodyLoad()
		{
			initMap(#{navigationBean.group.mapLat},#{navigationBean.group.mapLng},5);
 			addMarkers();
	    	centerMap();
	    	defaultAddressElement = "liveFleetMapForm:bubbleAddress";
			bubbleElement = "driverBubble";
			errorMessage = "#{messages.sbs_badLatLng}"
			addressLookupAddressFormat = #{driverLocationBean.addressFormat};	    	
		}
		function refreshMap()
		{
			mapNeedsInit = false;
			map.clearOverlays();
			addMarkers();
		}
		function setZoneName(zoneName) {	
			document.getByElementId('dispatchForm:foundZoneName').value = zoneName;
		}
	</script>
	<rich:panel id="scripts">
		<script type="text/javascript">
			function addMarkers()
			{
				var progress = 0;
				var progressBar = new ProgressbarControl(map);
				if (markerClusterer != null) {
			          markerClusterer.clearMarkers();
			        }
		        
				markers = [];

				progressBar.start(#{fn:length(driverLocationBean.driverLocations)});
				<ui:repeat value="#{driverLocationBean.driverLocations}" var="driverLocation">
				
					var latlng = new GLatLng(#{driverLocation.loc.lat}, #{driverLocation.loc.lng});
					var marker = createMarker(	latlng, "#{driverLocation.driver.driverID}", null,
	        		 							"#{driverLocationBean.mapIconMap.icons[driverLocation.position]}",
	        		 							fillBubbleMarker);
				    bounds.extend(marker.getPoint());
					markers.push(marker);
					progressBar.updateLoader(progress++);
					
				</ui:repeat>
				markerClusterer = new MarkerClusterer(map,markers);
				progressBar.remove();
			}
		</script>
		
      	<!-- BEGIN GOOGLE MAP POPUPS -->
      	<h:form id="liveFleetMapForm">
      	<rich:panel id="mapPopups" rendered="#{driverLocationBean.selectedDriverID != null}">
			<ui:param name="driverLocation" value="#{driverLocationBean.driverLocationsMap[driverLocationBean.selectedDriverID]}"/>
      			<ui:include src="../includes/driverBubble.xhtml">
      	            <ui:param name="hiddenDivID" value="bubble" />
      	            <ui:param name="driver" value="#{driverLocation.driver}" />
      	        	<ui:param name="vehicle" value="#{driverLocation.vehicle}" />
      	        	<ui:param name="bean" value="#{driverLocationBean}" />
      	        	<ui:param name="targetDriverID" value="#{driverLocation.driver.driverID}" />
      	        	<ui:param name="messagePriPhone" value="#{messages.livefleet_priPhone}" />
      	        	<ui:param name="messageSecPhone" value="#{messages.livefleet_secPhone}" />
      	        	<ui:param name="messageVehicle" value="#{messages.livefleet_vehicle}" />
      	        	<ui:param name="targetVehicleID" value="#{driverLocation.vehicle.vehicleID}" />
      	        	<ui:param name="messageVehicleType" value="#{messages.livefleet_vehicleType}" />
      	        	<ui:param name="messageLastUpdated" value="#{messages.livefleet_updated}" />
      	        	<ui:param name="vehicleTime" value="#{driverLocation.time}" />
      	        	<ui:param name="messageAddress" value="#{messages.livefleet_address}" />
      	        	<ui:param name="vehicleAddress" value="#{driverLocation.addressStr}" />
      	        	<ui:param name="addressLookupAddressFormat" value="#{driverLocationBean.addressFormat}"/>
      			</ui:include>
      	</rich:panel>
      	</h:form>
      	<!-- END GOOGLE MAP POPUPS -->
	</rich:panel>
	<div class="">
			<div class="panel_nw">
				<div class="panel_title">
					<span class="map">#{messages.livefleet}</span>
					<span class="panel_links">
					<a4j:form id="refresh">
                        <a4j:status id="refresh_ajax_status">
                           <f:facet name="start">
                              <h:outputText>
                                          <img
                                              src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif"
                                             align="top" />&#160;</h:outputText>
                           </f:facet>
                        </a4j:status>
   						<a4j:commandButton id="#{context}-liveFleetMapRefresh" image="/images/ico_refresh.png" immediate="true"
   							reRender="scripts" oncomplete="refreshMap()" title="#{messages.refresh}"  alt="#{messages.refresh}"
   							value="#{messages.refresh}">
   						</a4j:commandButton>
                     
                         <!-- If the details parameter is not there, do not show the details image link -->
                         <ui:fragment rendered="#{detailLink ne null}">
                            <rich:spacer width="5px"></rich:spacer>
                            <h:outputLink id="#{context}-liveFleetMapRestore" value="#{detailLink}" title="#{detailTitle}" >
                               <h:graphicImage value="#{detailImage}" />
                            </h:outputLink>
                         </ui:fragment>
                         
					</a4j:form>
					<a4j:form id="dispatchForm">
								<h:inputHidden id="foundZoneName" value="#{addressBean.zoneName}"/>					
					</a4j:form>
					</span>
				</div>
			</div>
			<div class="panel_w">
				
			 	 <rich:panel  id="map">
					<div class="panel_content">
						<h:form name="maplinks2"> <div id="map-canvas" style="#{mapwidth};#{mapheight};border:0"></div></h:form>
 					</div>
				 </rich:panel>
			</div>		
																		
			<div class="panel_sw">
				<div class="panel_statusbar"></div>
			</div>
   </div>	
   <div class="spacer"></div>		
   <div>
   		<div class="panel_nw">
   			<div class="panel_title">
   				<span class="legend">#{messages.livefleet_legend_header}</span>
   				<span class="panel_links"></span>
   			</div>
   		</div>	
      	<div class="panel_w">
      		<div class="panel_content">
      		  
      		  <rich:dataGrid value="#{driverLocationBean.legendIcons}" var="icon" styleClass="carlegend" columnClasses="carlegend" rowClasses="carlegend"
      		  			rendered="#{driverLocationBean.teamLevel}" columns="3" border="0" cellpadding="5" cellspacing="5">
      		  			
      			  	<div onclick="fillBubbleMap(#{icon.entityID})" style="cursor: pointer;">
      				  	<img src="#{icon.iconURL}" style="vertical-align:middle"/> 
      				  	<h:outputText value="#{icon.caption}" style="margin-left:5px" /></div>
      			  	
      		</rich:dataGrid>
      		  <rich:dataGrid value="#{driverLocationBean.legendIcons}" var="icon" styleClass="carlegend" columnClasses="carlegend" rowClasses="carlegend"
      		  		rendered="#{!driverLocationBean.teamLevel}"  columns="3" border="0" cellpadding="5" cellspacing="5">
      		  		<img src="#{icon.iconURL}" style="vertical-align:middle"/> 
      			  	<h:outputText value="#{icon.caption}" style="margin-left:5px"></h:outputText>
      		  </rich:dataGrid>
      		  <div style="clear:both"/>
      		</div>
      	</div>
   
      	<div class="panel_sw">
      		<div class="panel_statusbar"></div>
      	</div>
   </div>
	<a4j:form id="bubbleForm">
		<a4j:jsFunction name="fillBubbleMarker" reRender="mapPopups" oncomplete="getAddressForCurrentMarker()">
			<a4j:actionparam name="driverId" assignTo="#{driverLocationBean.selectedDriverID}"/>
			<a4j:actionparam name="subId" />
		</a4j:jsFunction>
		<a4j:jsFunction name="fillBubbleMap" reRender="mapPopups" 
			oncomplete="getAddressForPosition(#{driverLocationBean.driverLocationsMap[driverLocationBean.selectedDriverID].loc.lat},
								#{driverLocationBean.driverLocationsMap[driverLocationBean.selectedDriverID].loc.lng})">
			<a4j:actionparam name="driverId" assignTo="#{driverLocationBean.selectedDriverID}"/>
		</a4j:jsFunction>
		<a4j:jsFunction name="lkFrZn" action="#{addressBean.lookForZone}" oncomplete="setZoneName('#{addressBean.zoneName}')" reRender="dispatchForm:foundZoneName">
			<a4j:actionparam name="latitude" assignTo="#{addressBean.zoneLat}"/>
			<a4j:actionparam name="longitude" assignTo="#{addressBean.zoneLng}"/>
			<a4j:actionparam name="elemIndex" assignTo="#{addressBean.elemIndex}"/>
		</a4j:jsFunction>
		
	</a4j:form>	
			
</ui:composition>	

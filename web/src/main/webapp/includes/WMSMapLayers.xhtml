<ui:composition 
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:f="http://java.sun.com/jsf/core"
  	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	xmlns:t="http://myfaces.apache.org/tomahawk"
    xmlns:pretty="http://ocpsoft.com/prettyfaces">
    
    
    <a4j:loadScript src="/js/wms236.js"/>
	<script type="text/javascript">

	//<![CDATA[
	var currentLatLng;
	function showFeatureInfo(data) {
		var infoWindowHtml = "<div class='infoWindow'><table class='google_popup'>";
		jQuery.each(data.items[0], function(name, value) {
			infoWindowHtml += "<tr class='google_popups_rows'><td>" + name + ":</td><td> " + value + "</td></tr>";
		});
        infoWindowHtml += "</table></div>";
  		map.openInfoWindow(currentLatLng, infoWindowHtml);
	}

	function get_place(latlng) {
		currentLatLng = latlng;
		var zm = map.getZoom(); 
		if(zm < 8) {
			zm=8;
			}

		var proj = map.getCurrentMapType().getProjection();
		var pt = proj.fromLatLngToPixel(latlng,zm);

		var tile_coord_x = Math.floor(pt.x/256);
		var tile_coord_y = Math.floor(pt.y/256);
		var a = new GPoint(tile_coord_x,tile_coord_y);
		var lULP = new GPoint(a.x*256,(a.y+1)*256);
		var lLRP = new GPoint((a.x+1)*256,a.y*256);

		var lUL = G_NORMAL_MAP.getProjection().fromPixelToLatLng(lULP,zm,false);
		var lLR = G_NORMAL_MAP.getProjection().fromPixelToLatLng(lLRP,zm,false);

		var lBbox=lUL.x+","+lUL.y+","+lLR.x+","+lLR.y;

		var local_x = pt.x % 256;
		var local_y = pt.y % 256;

		var coords = '&x='+local_x+'&y='+local_y; 

		//alert(lBbox);
		
	    var featureInfoURL =  "http://"+host+":"+port+url+"&service=WMS&version=1.1.0&request=GetFeatureInfo&layers=";
	    featureInfoURL +=wmsLayer;
	    featureInfoURL +="&query_layers=";
	    featureInfoURL +=wmsLayer;
	    featureInfoURL +="&styles="

		featureInfoURL += '&bbox=' + lBbox;
		featureInfoURL += '&srs=EPSG%3A4326';
		featureInfoURL += coords;
		featureInfoURL += '&feature_count=1&height=256&width=512&info_format=text/html&callback=?';
		jQuery.getJSON(featureInfoURL, showFeatureInfo);
		 
	}
	function addListeners(){
        // add listener for queryable WMS Layer
        GEvent.addListener(map, 'click', function(overlay,latlng) {

        	if (!overlay && respondToClick){
			
        		get_place(latlng);
        	}
        });
        GEvent.addListener(map, 'maptypechanged', function(){
        	
        	respondToClick = false;
        	for(var i = 0;i < queryableLayers.length; i++){
        		
        		if(map.getCurrentMapType() == queryableLayers[i]){
        			respondToClick = true;
        			return;
        		}
        	}
        });
	}

	function isQueryable(){
		
		return 	wmsLayer && (wmsLayer.length != 0);
	}


	//]]>
	var respondToClick = false;
	 <ui:fragment rendered="#{(accountOptionsBean.mapServerConfiguration.host ne null) and (fn:length(accountOptionsBean.mapServerConfiguration.host) gt 0)}">
		//Assumes map is defined elsewhere
		var host = "#{accountOptionsBean.mapServerConfiguration.host}";
		var port = "#{accountOptionsBean.mapServerConfiguration.port}";
		var url = "#{accountOptionsBean.mapServerConfiguration.url}";
		var proxy = "#{accountOptionsBean.mapServerConfiguration.proxy}";
		var wmsLayer = "#{accountOptionsBean.mapServerConfiguration.wmsLayer}";
		var queryableLayers = [];

		
		function addLayers(){

			<ui:repeat value="#{accountOptionsBean.mapServerConfiguration.layersList}" var="layer">

			//<![CDATA[
				// Street Map
				var streetsHyb = new GTileLayer(new GCopyrightCollection(''),1,17);
					streetsHyb.myLayers="#{layer.layer}";
					streetsHyb.myFormat="image/png";
					streetsHyb.myBaseURL="http://" + host +":"+port+url;
					streetsHyb.getTileUrl=CustomGetTileUrl;

				var layer1=[G_NORMAL_MAP.getTileLayers()[0],streetsHyb];

				var custommap1 = new GMapType(layer1, G_NORMAL_MAP.getProjection(), "#{layer.name} Map", G_SATELLITE_MAP);
				map.addMapType(custommap1);

				if (isQueryable()){
					
					queryableLayers.push(custommap1);
				}

				// Satellite map
				var streetsHyb = new GTileLayer(new GCopyrightCollection(''),1,17);
					streetsHyb.myLayers="#{layer.layer}";
					streetsHyb.myFormat="image/png";
					streetsHyb.myBaseURL="http://" + host +":"+port+url;
					streetsHyb.getTileUrl=CustomGetTileUrl;

				var layer1=[G_SATELLITE_MAP.getTileLayers()[0],streetsHyb];

				var custommap1 = new GMapType(layer1, G_NORMAL_MAP.getProjection(), "#{layer.name} Sat", G_SATELLITE_MAP);
				map.addMapType(custommap1);
				
				if (isQueryable()){
					
					queryableLayers.push(custommap1);
				}
				//]]>
			</ui:repeat>

		}		
		</ui:fragment>
		<ui:fragment rendered="#{(accountOptionsBean.mapServerConfiguration.host eq null) or (fn:length(accountOptionsBean.mapServerConfiguration.host) == 0)}">
			function addLayers(){};
		</ui:fragment>
		
	</script>
</ui:composition>
<html         xmlns="http://www.w3.org/1999/xhtml"
              xmlns:ui="http://java.sun.com/jsf/facelets"
              xmlns:h="http://java.sun.com/jsf/html"
              xmlns:rich="http://richfaces.org/rich"
              xmlns:a4j="http://richfaces.org/a4j"
              xmlns:f="http://java.sun.com/jsf/core"
              xmlns:c="http://java.sun.com/jstl/core"
              xmlns:security="http://pro.tiwi.com/jsf/security"
  			  xmlns:t="http://myfaces.apache.org/tomahawk">
              
<ui:composition>
		<t:saveState value="#{speedLimitChangeRequests}"/>

    <table width="920" border="1" cellspacing="0" cellpadding="0" align="center" style="margin: 0 auto 0 auto;">
      <tr>
       <td valign="top">
          <!-- START PANEL -->
          <div class="">

 			<div class="panel_w">

				<div class="panel_content">
 		<rich:panel id="map-data">
     <a4j:form id="speedLimitChangeRequestTable">
          <ul id="grid_nav" style="margin: 0;">
            <li class="l"><a4j:commandButton action="#{speedLimitChangeRequests.delete}" reRender="map-data" styleClass="left" onclick=""><span class="delete"><h:outputText value="#{messages.button_delete}" /></span></a4j:commandButton></li>
            <li class="l"><a4j:commandButton styleClass="left" action="#{speedLimitChangeRequests.deleteAll}" reRender="map-data" onclick=""><span class="delete"><h:outputText value="Clear All" /></span></a4j:commandButton></li>
            <li class="l">
              <table border="0" cellspacing="0" cellpadding="4" id="grid_nav_search_box">
                <tr>
         		<td><h:outputText value="#{messages.button_search}" /></td>
         		<td><h:inputText size="40" name="address" id="address" class="text" onkeypress="if (event &amp;&amp; event.keyCode == 13) { document.getElementById('speedLimitChangeRequestTable:searchButton').onclick(); return false; } return true;"/></td>
                 </tr>
              </table>
            </li>
  		<li class="l"><a4j:commandButton styleClass="left" onclick="showLocation(document.getElementById('speedLimitChangeRequestTable:address').value);"><span class="search"><h:outputText value="Find Address" /></span></a4j:commandButton></li>
            <li class="l"><a4j:commandButton styleClass="left" onclick="Richfaces.showModalPanel('saveSlcrPanel')"><span class="edit"><h:outputText value="Submit Request" /></span></a4j:commandButton></li>
            </ul>
 				<div class="spacer"></div>			
			 	<table>
				  <tr style=" width : 100%">
			    	<td  valign="top" width="50%">
		<div class="datagrid"><!-- Start Speed Limit Changer Request table --> 
		
		<rich:dataTable value="#{speedLimitChangeRequests.changeRequests}" id="items"
			var="item" styleClass="datagrid" rowkey="row" rowkeyVar="rowVar"
			rowClasses="trendTableOdd,trendTableEven" cellspacing="1" rows="100"
			width="50%" onRowClick="selectSegment(#{item.linkId})" 
						onRowMouseOver="hoverSegment(#{item.linkId},this)" 
						onRowMouseOut="hoverDeselectAllSegments(this)" >
			<f:facet name="caption" style="text-align:center"><h:outputText value="#{speedLimitChangeRequests.caption}" id="caption" style="text-align:center"/></f:facet>
		<c:if test="#{speedLimitChangeRequests.renderTable}">
			<!-- Data -->
              <rich:column>
                <f:facet name="header">
                  <h:outputText value=" " />
                </f:facet>
                <h:selectBooleanCheckbox value="#{item.selected}" id="c" onclick="check = true"/>
              </rich:column>
 					<rich:column sortBy="#{item.address}" width="38" height="27" >
						<f:facet name="header">
							<h:outputText value="#{messages.sbs_address}" />
						</f:facet>
						<h:outputText value="#{item.address}"/>

					</rich:column>
					<rich:column width="20">
						<f:facet name="header">
							<h:outputText value="#{messages.sbs_mph}" />
						</f:facet>
						<h:outputText value="#{item.speedLimit}"/>

					</rich:column>
					<rich:column width="20">
						<f:facet name="header">
							<h:outputText value="#{messages.sbs_newmph}" />
						</f:facet>
						<h:inputText value="#{item.newSpeedLimit}" required="true" size="3" onclick="check = true" onkeyup="validate(this,0,199)" id="s"/>

					</rich:column>
					<rich:column width="68">
						<f:facet name="header">
							<h:outputText value="#{messages.sbs_comment}" />
						</f:facet>
						<h:inputText value="#{item.comment}" size="10" id="t" onclick="check = true"/>
						
						
						</rich:column>
</c:if>
					</rich:dataTable>



</div>

			
			
			          <!-- END PANEL -->
					 </td>
					    <td width="5" valign="top">
					    
							<!-- START PANEL -->
									
								<!-- START FLEET MAP PANEL -->
	<div class="">
		<div id="map-sbs" style="height:400px;width:400px;border:0"></div>
		<script  type="text/javascript">
			if (GBrowserIsCompatible()) {
			
	        		var opts = { onMarkersSetCallback: processMarkers, resultList : G_GOOGLEBAR_RESULT_LIST_SUPPRESS, showOnLoad: true};
					mapsbs = new GMap2(document.getElementById("map-sbs"), {googleBarOptions: opts});
					mapsbs.setCenter(new GLatLng(#{speedLimitChangeRequests.maplat},#{speedLimitChangeRequests.maplng}), #{speedLimitChangeRequests.mapzoom});
					mapsbs.addControl(new GLargeMapControl());
					mapsbs.addControl(new GMapTypeControl());
					mapsbs.addControl(new GOverviewMapControl()); 
					mapsbs.setMapType(G_NORMAL_MAP);					
			       	mapsbs.enableScrollWheelZoom();
	        		mapsbs.enableGoogleBar();
	        		geocoder =new GClientGeocoder();
	        				       
			     	GEvent.addListener(mapsbs, "click", function(overlay, point) {
			
			        if (overlay) {
			          
			          	var segment = whichSegment(overlay);
			          	if (segment != null){
			          	
			 				selectSegment(segment.id);
			 			}	
			          } else {
			          
			            reverseGeocode(point.y,point.x,"");
			            
				      }
			        });
  						
			       	GEvent.addListener(mapsbs, "singlerightclick", function(point, source, overlay) {
			          if (overlay) {
			          	var segment = whichSegment(overlay);
			          	if (segment != null){
			          	
			          		var point = segment.polyline.getVertex(0);
			          	
							openPanoramaBubblePolyline(point);
			 			}	
			          }
			        });
	          var gLatLngArray;
	          var polyline;
	          var seg;
			  var bcolor;
			  var count = 0;
			  var row;
			  
			    bcolor = '#EBFFCA';
				streetSegments = new Array();
				 mapsbs.clearOverlays();
		         mapsbs.setCenter(new GLatLng(#{speedLimitChangeRequests.maplat},#{speedLimitChangeRequests.maplng}),16);
		        
		         <ui:repeat value="#{speedLimitChangeRequests.changeRequests}" var="changeRequest">
		         
		         	if(bcolor == '#EBFFCA'){
		         	
		         		bcolor = '#ffffff';
		         	}
		         	else {
		         	
		         		bcolor = '#EBFFCA';
		         	}
		         	
			         // Do polyline for segment    
			         gLatLngArray = new Array();
			         <ui:repeat value="#{changeRequest.streetSegment}" var="point">
				           var lat = #{point.x};
				           var lng = #{point.y};
				           gLatLngArray.push(new GLatLng(lat,lng));
				  	 </ui:repeat>
			         
			         polyline = new GPolyline(gLatLngArray, "#666666", 10);
			         
			     	GEvent.addListener(polyline, "mouseover", function() {
			     	
			          	var segment = whichSegment(this);
			          	if (segment != null){
			          	
			          		mapsbs.getDragObject().setDraggableCursor("pointer");
			 				hoverSegment(segment.id);
			 			}
			
			 		});	
			     	GEvent.addListener(polyline, "mouseout", function() {
			     	
			 				hoverDeselectAllSegments();
			 				mapsbs.getDragObject().setDraggableCursor("default"); 
			 		});	

			         seg = new StreetSegment();
			         
			         row = document.getElementById('speedLimitChangeRequestTable:items:'+count+':c').parentNode.parentNode;
			         seg.initialize(#{changeRequest.linkId},polyline, bcolor, row);
			         streetSegments.push(seg);
			        
			         mapsbs.addOverlay(seg.polyline);
			         
			         count++;
			         
		         </ui:repeat>
		 }
    </script> 
 	</div>	

							<!-- END PANEL -->
							</td>
					</tr>
			    </table>
</a4j:form>
</rich:panel>
				</div>
			</div>
          </div>
           <div class="panel_sw">
              <div class="panel_statusbar"></div>
            </div>
          </td>
		</tr>
    </table>


	<a4j:form id="segment">
		<a4j:jsFunction name="addSegment" action="#{speedLimitChangeRequests.addChangeRequest}" reRender="map-data" >
			<a4j:actionparam name="lat" assignTo="#{speedLimitChangeRequests.lat}"/>
			<a4j:actionparam name="lng" assignTo="#{speedLimitChangeRequests.lng}"/>
			<a4j:actionparam name="address" assignTo="#{speedLimitChangeRequests.address}"/>
			<a4j:actionparam name="zoom" assignTo="#{speedLimitChangeRequests.mapzoom}"/>
		</a4j:jsFunction>
	</a4j:form>	

	<a4j:form id="segment1">
		<a4j:jsFunction name="addSegmentWithoutRerendering" action="#{speedLimitChangeRequests.addChangeRequest}">
			<a4j:actionparam name="lat" assignTo="#{speedLimitChangeRequests.lat}"/>
			<a4j:actionparam name="lng" assignTo="#{speedLimitChangeRequests.lng}"/>
			<a4j:actionparam name="address" assignTo="#{speedLimitChangeRequests.address}"/>
			<a4j:actionparam name="zoom" assignTo="#{speedLimitChangeRequests.mapzoom}"/>
		</a4j:jsFunction>
	</a4j:form>	
	<a4j:form id="reset">
		<a4j:jsFunction name="reset" action="#{speedLimitChangeRequests.resetAction}" reRender="map-data">
		</a4j:jsFunction>
	</a4j:form>	
	
	<rich:modalPanel id="saveSlcrPanel" headerClass="popupHeader" controlsClass="popupControls" autosized="true">
      <f:facet name="header">
        <h:outputText value="#{messages.sbs_header}" />
      </f:facet>
      <f:facet name="controls">
        <h:graphicImage value="/images/modal_close.png" style="cursor:pointer" onclick="Richfaces.hideModalPanel('saveSlcrPanel')" />
      </f:facet>
      <rich:panel id="reRender">
 	<div><h:outputText value="#{speedLimitChangeRequests.message}" /></div>
  <a4j:form id="emailForm">
   <c:if test="#{!speedLimitChangeRequests.requestSent}">
    <h:inputText style="width:230px;margin:10px" id="email" label="#{messages.sbs_emailAddress}" value="#{speedLimitChangeRequests.emailAddress}" required="true" validator="#{speedLimitChangeRequests.validateEmail}"></h:inputText>
    <div>
      <rich:message for="email">
        <f:facet name="errorMarker">
          <h:graphicImage value="/images/icon_msg_err_small.png" />
        </f:facet>
      </rich:message>
    </div>
    <div class="popupactions">
      <button value="submit" class="left" onclick="Richfaces.hideModalPanel('saveSlcrPanel'); return false;"><span class="cancel"><h:outputText value="#{messages.button_cancel}" /></span></button>
      <a4j:commandButton reRender="reRender" action="#{speedLimitChangeRequests.saveRequestsAction}" styleClass="left" onclick=""><span class="retrieve_password"><h:outputText value="#{messages.sbs_submit}" /></span></a4j:commandButton>
 	</div>
   </c:if>
   <c:if test="#{speedLimitChangeRequests.requestSent}">
      <div class="popupactions">
      	<a4j:commandButton reRender="map-data,reRender" action="#{speedLimitChangeRequests.resetAction}" styleClass="left" onclick="Richfaces.hideModalPanel('saveSlcrPanel');"><span class="ok"><h:outputText value="#{messages.button_ok}" /></span></a4j:commandButton>
 	  </div>
   </c:if> 
  </a4j:form>
   
  </rich:panel>

	</rich:modalPanel>

</ui:composition>	
</html>

<ui:composition 
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:pretty="http://ocpsoft.com/prettyfaces">
 	
	<style>
	.clear: after {
	  content: ". ";
	  display: block;
	  height: 0;
	  font-size: 0;
	  clear: both;
	  visibility: hidden;
	}
	.clear {
	  zoom: 1;
	}			
	
	.trips_markerLabel  {
	  color: black;
	  text-align: center;
	  font-size:12px
	}
	.trips_color {
		color: black;
		width:14px;
		height:13px;
		vertical-align:middle;
		padding-top:2px;
		border:1px solid black; 
		font: 12px bold Arial, sans-serif;
	}
	</style>
	
	<a4j:loadScript src="#{googleMapURLBean.mapUrl}&amp;hl=#{localeBean.locale.language}" />
	<a4j:loadScript src="/js/json.js"/>
	<a4j:loadScript src="/js/arrowedPolyline.js"/>
	<a4j:loadScript src="/js/labeledMarker.js"/>
	<a4j:loadScript src="/js/markerClustererWithMergedMarkerSets.js"/>
	<a4j:loadScript src="/js/teamTrips.js"/>
	
	
	<script type="text/javascript">
	
	var icons = [	"#{request.contextPath}/images/green_circle.png",
					"#{request.contextPath}/images/yellow_circle.png", 
					"#{request.contextPath}/images/red_circle.png", 
					"#{request.contextPath}/images/ico_violation.png", 
					"#{request.contextPath}/images/teamIdle2.png",
					"#{request.contextPath}/images/ico_tampering.png",
					"#{request.contextPath}/images/x.gif"
				];
	var colors = [#{messages.teamColors}];
	var labels = [#{messages.teamLabels}];
	
	function initTeamTripsMap() {
		
		if (GBrowserIsCompatible()) {					
			GUnload();
			map = new GMap2(document.getElementById("map-canvas"));						
			map.addControl(new GLargeMapControl());
			map.addControl(new GMapTypeControl());
			map.addControl(new GOverviewMapControl()); 
			map.setMapType(G_NORMAL_MAP);
			map.setCenter(new GLatLng(#{teamCommonBean.group.mapLat},#{teamCommonBean.group.mapLng}), #{teamCommonBean.group.mapZoom});

			initTeamTripsClusters(map,icons);
		}
	}
	var dayClickFunction = function(event){
	   	resetTripsForSelectedDrivers();
	};
		
	function onTripTabSelectionComplete(){		
		initTeamTripsMap();
		resetTripsForSelectedDrivers();
		initTripTimeFrameChangeListener();
	}

	function initTripTimeFrameChangeListener() {		
		Team.disableTimeFrame("#timeFrameForm\\:timeFrameMonth");
		Team.disableTimeFrame("#timeFrameForm\\:timeFrameYear");
		Team.getSelectedTab()
		.bind('timeFrameChange', function(){
			resetTripsForSelectedDrivers();
			Team.disableTimeFrame("#timeFrameForm\\:timeFrameMonth");
			Team.disableTimeFrame("#timeFrameForm\\:timeFrameYear");
		});
	}
		
 </script>
    <rich:tab id="teamTrips" ontableave=""  oncomplete="onTripTabSelectionComplete();" >
   	
	 <a4j:queue name="tripsQueue"/>    
	 <f:facet name="label">
	 	<h:panelGroup>
	 		<h:graphicImage value="/images/ico_map.png" /><rich:spacer width="10"/>Trips
	 	</h:panelGroup>
	 </f:facet>
	 	
   	<!-- Trips Map -->
 <a4j:region id="teamTripsRegion" renderRegionOnly="true" >	       
   	<div class="section">
	         <div id="driverTable" 	style="float:left; width:25%;height: 500px; border: 0;">
	        	<h:form id="tripsTableForm">
	         	<rich:dataTable	value="#{teamTripsBean.driversTrips}" 
					       		id="driversTrips" 
					       		var="driverTrips"
					       		rowKeyVar="index"
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="25"
								columnsWidth="90px,85%,50px"
								width="100%">
				<rich:column>
                <a4j:outputPanel id="hideShow" ajaxRendered="true" >
                
                <h:selectBooleanCheckbox id="checkDriver" value="#{driverTrips.driverSelected}" >
                  <a4j:support event="onclick" status="teamStatus" eventsQueue="tripsQueue" 
                  				action="#{driverTrips.selectivelyLoadTrips}" data="#{driverTrips}" 
                  				oncomplete="processDriverTrips(#{index},data)" ajaxSingle="true">
                   </a4j:support>
                  				
                </h:selectBooleanCheckbox>
                </a4j:outputPanel>
              </rich:column>
												
				<rich:column style="text-align:left;">
					<f:facet name="header">
						<h:outputText value="#{messages.teamPage_driverHeader}"/>
					</f:facet>
     				 <pretty:link id="teamTrips-driverPerformance" mappingId="driverPerformance" >
        				 <f:param value="#{driverTrips.driverID}"/>
 						 <h:outputText value="#{driverTrips.driverName}"/>
     				</pretty:link>
 				</rich:column>
				<rich:column>
					<div style="background-color:#{teamTripsBean.colors[index]};" class="trips_color">
					#{teamTripsBean.labels[index]}
					</div>
				</rich:column>
				</rich:dataTable>
				<rich:datascroller 	align="left" for="driversTrips" status="teamStatus" action="#{teamTripsBean.reset}" oncomplete="resetTrips();" 
            		 				styleClass="dataScrollerSmall" renderIfSinglePage="false" id="driverTableScroller" width="98%"
            		 				eventsQueue="tripsQueue"/>
            		 
		<a4j:jsFunction id="getLatestTrips" ajaxSingle="true" status="teamStatus" name="getLatestTrips" action="#{teamTripsBean.reloadTrips}" data="#{teamTripsBean.selectedDriversTrips}" 
				eventsQueue="tripsQueue" oncomplete="redisplayAllTrips(data)"/>
				
		<a4j:jsFunction id="getTripBubbleData" ajaxSingle="true" status="teamStatus" name="getTripBubbleData" action="#{teamTripsBean.createEventBubbleData}" reRender="teamBubbleForm" data="#{teamTripsBean.eventData}" 
						eventsQueue="tripsQueue" oncomplete="getAddressForBubble(data)">
				<a4j:actionparam id="eventID" name="eventID" assignTo="#{teamTripsBean.eventData.eventID}"/>
		</a4j:jsFunction>
 						
		<a4j:jsFunction id="getEventData" ajaxSingle="true" status="teamStatus" name="getEventData" action="#{teamTripsBean.createClusterBubbleData}" 
				eventsQueue="tripsQueue" oncomplete="addAddressesToClusterBubble()" reRender="clusterBubbleForm">
						<a4j:actionparam name="clusterEventIDs" assignTo="#{teamTripsBean.clusterEventIDs}"/>
		</a4j:jsFunction>
 	</h:form>	
 				         
	         </div>  
			 <div id="map-canvas" style="float:right; width: 74%; height: 500px; border: 0"></div>
			 <div style="clear:both"></div>
	       </div>
				<h:form id="teamBubbleForm" >
				<div id="bubbleElement" style="display:none" >
					<h:panelGrid columns="2" styleClass="google_popup" width="250" rowClasses="google_popups_rows" headerClass="google_popups_header">
					<f:facet name="header">
						<h:outputText id="bubbleTitle" value="#{teamTripsBean.eventData.eventName}"/>
					</f:facet>
					<h:outputText>#{messages.team_driver}:</h:outputText>
				    <pretty:link id="teamBubbleDriver" mappingId="driverPerformance">
	                     <h:outputText value="#{teamTripsBean.eventData.driverName}"/>
	                     <f:param value="#{teamTripsBean.eventData.driverID}"/>
	                </pretty:link>
			
	                <h:outputText>Time:</h:outputText>
					<h:outputText id="teamBubbleTime" value="#{teamTripsBean.eventData.timeString}"/>
					<h:outputText>#{messages.livefleet_address}:</h:outputText>
					<h:outputText id="teamBubbleAddress"/>
					</h:panelGrid>
					<h:panelGrid columns="1" styleClass="google_popup" width="250" rowClasses="google_popups_rows" headerClass="google_popups_header">
					<h:outputText id="teamBubbleDescription" value="#{teamTripsBean.eventData.eventDescription}"/>
					</h:panelGrid>
				</div>
				</h:form>
	<div id="clusterBubbleTable" style="display:none">
		<h:form id="clusterBubbleForm">
			<rich:dataTable	value="#{teamTripsBean.clusterBubbleEvents}" 
					       		id="clusterEvents" 
					       		var="clusterEvent"
					       		rowKeyVar="index"
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="25"
								columnsWidth="80px,80px,80px,150px"
								width="100%">
								
				<rich:column style="text-align:left;">
					<f:facet name="header">
						<h:outputText value="#{messages.teamPage_driverHeader}"/>
					</f:facet>
				    <pretty:link id="teamClusterBubbleDriverLink" mappingId="driverPerformance">
	                     <h:outputText value="#{clusterEvent.driverName}"/>
	                     <f:param value="#{clusterEvent.driverID}"/>
	                </pretty:link>
 				</rich:column>
				<rich:column>
					<f:facet name="header">
						<h:outputText value="#{messages.teamPage_eventType}"/>
					</f:facet>
					<h:outputText value="#{clusterEvent.eventName}"/>
				</rich:column>
				<rich:column>
					<f:facet name="header">
						<h:outputText value="#{messages.teamPage_eventTime}"/>
					</f:facet>
					<h:outputText value="#{clusterEvent.timeString}"/>
				</rich:column>
				<rich:column>
					<f:facet name="header">
						<h:outputText value="#{messages.teamPage_eventAddress}"/>
					</f:facet>
					<h:inputHidden id="lat" value="#{clusterEvent.lat}"/>
					<h:inputHidden id="lng" value="#{clusterEvent.lng}"/>
					<h:outputText id ="clusterEventAddress"/>
				</rich:column>
			</rich:dataTable>
		</h:form>  
	</div>
</a4j:region>
	     
    <!-- End Trips Map -->
    </rich:tab>
 </ui:composition>
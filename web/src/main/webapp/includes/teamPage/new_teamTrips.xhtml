<ui:composition 
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:t="http://myfaces.apache.org/tomahawk">
	
	<t:saveState  value="#{teamTripsBean}"/>
	<a4j:loadScript src="#{googleMapURLBean.mapUrl}&amp;hl=#{localeBean.locale.language}" />
	<script src="#{facesContext.externalContext.request.contextPath}/js/arrowedPolyline.js" type="text/javascript"></script>	
	
	<script type="text/javascript">
	var tripMap = new Object();
	function orderOfCreation(marker,b) 
	{
	      return 1;
	}	
	
    function createMarker(point, iconImage) 
    {
    	var markerIcon;
    	var marker;
    	var baseIcon = new GIcon();
    	baseIcon.iconSize = new GSize(21, 20);
    	baseIcon.iconAnchor = new GPoint(6, 20);
    	baseIcon.infoWindowAnchor = new GPoint(5, 1);

		//Use passed in image.
    	if(iconImage != null)
    	{
			markerIcon = new GIcon(baseIcon);
       	    markerIcon.image = iconImage;
       	 	markerOptions = { icon:markerIcon,zIndexProcess:orderOfCreation  };
       	 	marker = new GMarker(point, markerOptions);
    	}
    	//Use default GoogleMap marker image.
    	else
    	{
	      	markerIcon = new GIcon();
			marker = new GMarker(point);
    	}

        bounds.extend(marker.getPoint());

    	return marker;
    }
	
	</script>
	
	<rich:panel id="drawTeamTrips">
 <script type="text/javascript">
 function drawTrips(colorIndex,driver){
		bounds = map.getBounds();
		var colors= ["#820f00","#ff4a12","#943bc5","#74c6f1","#586b7a","#3e4f4f","#abc507","#eab239","#588e03",
					 "#8a8c81","#8173b1","#f99b49","#c6064f","#c4bdd9","#c8a77b"];
			var marker;
			var startlatlng;
			var endlatlng;

			if ( map == null ) {
				return;
			}
//			map.clearOverlays();
			
				for(var j=0;j&lt;driver.trips.length; j++){
					var tripRoute = driver.trips[j].route;
					for(var k=0; k&lt;tripRoute.length; k++){
						bounds.extend(new GLatLng(tripRoute[k].lat,tripRoute[k].lng));
					}
				}
//			}
			map.setZoom(map.getBoundsZoomLevel(bounds));
//			for(var i=0; i&lt;driversTrips.length; i++){
//				var trip = driversTrips[i];
				for(var j=0;j&lt;driver.trips.length; j++){
// BDCCArrowedPolyline(points, color, weight, opacity, opts, gapPx, headLength, headColor, headWeight, headOpacity)
					var tripRoute = driver.trips[j].route;
					var latLngArray = new Array();
					for(var k=0; k&lt;tripRoute.length; k++){
						latLngArray.push(new GLatLng(tripRoute[k].lat,tripRoute[k].lng));
					}
					var endlatlng = new GLatLng(driver.trips[j].routeLastStep.lat, driver.trips[j].routeLastStep.lng);
					latLngArray.push(endlatlng);
					
					var arrowPolyline = new BDCCArrowedPolyline(latLngArray,colors[colorIndex], 4, 0.9,{geodesic:true}, 
							100, 16,colors[colorIndex],1,0.9);
					map.addOverlay(arrowPolyline);
				
					//Start of trip marker
					startlatlng = new GLatLng(driver.trips[j].beginningPoint.lat, driver.trips[j].beginningPoint.lng);
					marker = createMarker(startlatlng,"#{facesContext.externalContext.request.contextPath}/images/ico_start.png");
					map.addOverlay(marker);
					//End of trip marker

					if (driver.trips[j].inProgress)
					{
						marker = createMarker(endlatlng, "#{facesContext.externalContext.request.contextPath}/images/ico_inprogress_trip.png");
					}
					else
					{
						marker = createMarker(endlatlng,"#{facesContext.externalContext.request.contextPath}/images/ico_end_trip.png");
					}
					map.addOverlay(marker);
				}
//			}
				map.setCenter(bounds.getCenter());

					for(var k=0; k&lt;driver.violationEvents.length; k++){
						var violation = new GLatLng(driver.violationEvents[k].latitude, driver.violationEvents[k].longitude);
						map.addOverlay(createMarker(violation,"#{facesContext.externalContext.request.contextPath}/images/ico_violation.png"));
					}
					for(var k=0; k&lt;driver.idleEvents.length; k++){
						var idle = new GLatLng(driver.idleEvents[k].latitude,driver.idleEvents[k].longitude);
						map.addOverlay(createMarker(idle, "#{facesContext.externalContext.request.contextPath}/images/ico_idle.png"));
					}
					for(var k=0; k&lt;driver.tamperEvents.length; k++){
						var tamper = new GLatLng(driver.tamperEvents[k].latitude,driver.tamperEvents[k].longitude);
						map.addOverlay(createMarker(tamper, "#{facesContext.externalContext.request.contextPath}/images/ico_tampering.png"));
					}
				
		}
 </script>
</rich:panel>
	
    <rich:tab label="Trips" onClick="alert('trips')">
   	<!-- Trips Map -->
   	<div class="section">
	    <div class="panel_nw">    
	       <div class="panel_title">
	       <h:graphicImage value="/images/ico_map.png" />Trips
	       </div>
	    </div>
	    <div class="panel_w">
	       <div class="panel_content">
	       
	         <div id="driverTable" 	style="float:left; width:25%;height: 500px; border: 0;">
	        	<a4j:form id="tripsTableForm">
	        	<a4j:region id="teamTripsRegion">
	         	<rich:dataTable	value="#{teamTripsBean.drivers}" 
					       		id="driversTrips" 
					       		var="driver"
					       		rowKeyVar="index"
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="1"
								columnsWidth="5%,85%,10%"
								width="100%">
				<rich:column>
				<f:facet name="header">
				     #{messages.teamPage_hideShow}
                </f:facet>
                <h:selectBooleanCheckbox id="select" value="#{driver.selected}">
                  <a4j:support event="onclick" data="#{driver}"
                  				oncomplete="drawTrips(#{index},data)" limitToList="true" >
                   </a4j:support>
                  				
                </h:selectBooleanCheckbox>
              </rich:column>
												
				<rich:column>
					<f:facet name="header">
						#{messages.teamPage_driverHeader}
					</f:facet>
					#{driver.driver.person.fullName}
				</rich:column>
				<rich:column>
				<f:facet name="header">
				  <a4j:status layout="block">
                	<f:facet name="start">
                    	<h:graphicImage  value="/images/progress2.gif"/>
                	</f:facet>
            	</a4j:status>
				
				</f:facet>
				   <img src="#{teamTripsBean.icons[index].url}" alt="#{index}"/>
				</rich:column>
				</rich:dataTable>
				<rich:datascroller align="left" for="driversTrips" action="#{teamTripsBean.reset}" oncomplete="map.clearOverlays();" 
            		 styleClass="dataScrollerSmall" renderIfSinglePage="false" id="driverTableScroller" width="98%"
            		  limitToList="true"/>
            		 
				 </a4j:region>
 				</a4j:form>	
 				         
	         </div>  
	            
			 <div id="map-canvas" style="float:right; width: 74%; height: 500px; border: 0"></div>
			 <div style="clear:both"></div>
	       </div>
	    </div>
	    <div class="panel_sw">
	       <div class="panel_statusbar"/>
	   	</div>
   	</div>
    <!-- End Trips Map -->
    </rich:tab>
    <script>
    function colorRows(){
    		jQuery('#tripsTableForm\\:driversTrips tr').click(function(){

    			if(jQuery(this).hasClass('selected-row')){
							
							jQuery(this).removeClass('selected-row');
							jQuery(this).children().removeClass('selected-row');
						}
						else {
								
							jQuery(this).addClass('selected-row');
							jQuery(this).children().addClass('selected-row');
						}
		});
    }
    </script>
</ui:composition>
<ui:composition 
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:pretty="http://ocpsoft.com/prettyfaces">
	
	<a4j:loadScript src="#{googleMapURLBean.mapUrl}&amp;hl=#{localeBean.locale.language}" />	
	
	<script language="javascript" type="text/javascript">
		
    	function resetRadioButtons(rad) { 
    	    var id = rad.name.substring(rad.name.lastIndexOf(':'));
    	    var el = rad.form.elements;
           	
    		//<![CDATA[	
    	    for (var i = 0; i < el.length; i++) {
    	        if (el[i].name.substring(el[i].name.lastIndexOf(':')) == id) {
    	            el[i].checked = false;
    	        }
    	    }
    	    //]]>
           	
    	    rad.checked = true;
    	}   

        function getAddresses()
        {                    
	    	geocoder = new GClientGeocoder();

	    	jQuery('td[id$="address_column"]').each(function(n){

         		var lat = jQuery(this).find('*[id$="lat"]');
        		var lng = jQuery(this).find('*[id$="lng"]');
        		var address = jQuery(this).find('*[id$="address"]');     	       		
				
				reverseGeocodeTripAddress(new GLatLng(lat[0].value,lng[0].value),address[0]);	
	    	});                        
        }       

        function reverseGeocodeTripAddress(latlng, addressElement){
         	geocoder.getLocations(latlng, 
        			function(response){    			
    			        if (!response || response.Status.code != 200) {
  			         	  	addressElement.innerHTML = "No address found.";
    			        } 
    			        else {						
			             	addressElement.innerHTML = response.Placemark[0].address;
    			        }    			       
    		});
	    }   	 
    	    
    </script>
 
    <rich:tab id="teamStops" oncomplete="Team.tabChange();">
   	   
		<f:facet name="label">
	 		<h:panelGroup>
	 			<h:graphicImage value="/images/ico_map.png" /><rich:spacer width="10"/>Stops
			</h:panelGroup>
		</f:facet> 				
				
		<a4j:outputPanel id="stopsPanel" ajaxRendered="true" styleClass="section">
			
		<table>
		<tr>
		<td valign="top">
		    
   			<div class="section">
     	  		<h:form id="stopsTableForm">
     	  		
	 	        	<div id="stopsDriverTable" >
	        	
	 	        		<rich:dataTable	value="#{teamStopsBean.drivers}" 
					       		id="stopsDrivers" 
					       		var="drivers"
					       		rowKeyVar="index"
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="#{TeamStopsBean.driversPerPage}"
								columnsWidth="10px,120px,10px">
							<rich:column>     
								<a4j:region id="radioBut">   		 			               
               		 				<h:selectOneRadio id="stopsCheckDriver" immediate="true"
               		 					value="#{teamStopsBean.selectedDriverID}">
               		 					<f:selectItem itemValue="#{drivers.driverID}"/>
               		 					<a4j:support event="onclick" reRender="stopsPanel"
               		 						limitToList="true" oncomplete="resetRadioButtons(this);getAddresses();"/>                	 					                 						
                					</h:selectOneRadio>
                				</a4j:region>              		
              				</rich:column>
												
							<rich:column style="text-align:left;" sortBy="#{drivers.person.fullName}" sortOrder="ASCENDING">
								<f:facet name="header">
									<h:outputText value="#{messages.teamPage_driverHeader}"/>
								</f:facet>
     							<pretty:link id="teamTrips-driverPerformance" mappingId="driverPerformance" >
        							<f:param value="#{drivers.driverID}"/>
 									<h:outputText value="#{drivers.person.fullName}"/>
     							</pretty:link>
 							</rich:column>
 							
							<rich:column>
								<div style="position: relative; background-color:#{teamStopsBean.colors[index]}; border: 1px solid black; width: 16px;height: 16px">					
									<div class="trips_label" style="color:#{teamStopsBean.textColors[index]};">
										#{teamStopsBean.labels[index]}
									</div>
								</div>
							</rich:column> 							

						</rich:dataTable>
					
						<br></br>
						
						<rich:datascroller 	align="left" for="stopsDrivers" 							
            			 	styleClass="dataScrollerSmall" 
            			 	id="stopsDriverTableScroller" width="98%"/>            			
 				         
	         		</div>  
 				</h:form>	
			</div>
			
		</td>
		<td valign="top">
			
			<div class="section">
				<h:form id="stopsTripsTableForm">
					<div id="stopsTripsTable" >

	 	        		<rich:dataTable	value="#{teamStopsBean.driverStops}" 
					       		id="stopsTrips" 
					       		var="stops"					       
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="#{TeamStopsBean.driversPerPage}"
								columnsWidth="50px,150px,100px,100px,100px,100px,100px,100px,100px">
								
	                		<f:facet name="header">
	                    		<rich:columnGroup>
	                        		<rich:column rowspan="2">#{messages.team_round_trip}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_stop_location}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_arrive}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_depart}</rich:column>
	                        		<rich:column colspan="4">#{messages.team_time_at_stop}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_drive_time}</rich:column>	                        			
	                        		<rich:column breakBefore="true">#{messages.team_total}</rich:column>
	                        		<rich:column>#{messages.team_low_idle}</rich:column>
	                        		<rich:column>#{messages.team_high_idle}</rich:column>
	                        		<rich:column>#{messages.team_wait}</rich:column>	                        	                        			                        			                        		
	                    		</rich:columnGroup>	
	                		</f:facet>
	                		
	                		<rich:column>
	                			#{stops.roundTrip}
	                		</rich:column>
	                		
	                		<rich:column id="address_column">
	                			<h:inputHidden id="lat" value="#{stops.latitude}"/>
								<h:inputHidden id="lng" value="#{stops.longitude}"/>
 								<h:outputText id="address" />
	                		</rich:column>
	                		
	                		<rich:column>
	                			#{stops.arrive}
	                		</rich:column>	   
	                		
	                		<rich:column>
	                			#{stops.depart}
	                		</rich:column>
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stops.totalTimeAtStop != null}">
                    				<a4j:actionparam value="#{stops.totalTimeAtStop}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stops.totalTimeAtStop == null}"/>	                			                			
	                		</rich:column>
	                			         
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stops.lowIdle != null}">
                    				<a4j:actionparam value="#{stops.lowIdle}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stops.lowIdle == null}"/>	      	                			                			
	                		</rich:column>
	                			   
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stops.highIdle != null}">
                    				<a4j:actionparam value="#{stops.highIdle}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stops.highIdle == null}"/>	      	                			                			
	                		</rich:column>	    
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stops.wait != null}">
                    				<a4j:actionparam value="#{stops.wait}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stops.wait == null}"/>	      	                			                			
	                		</rich:column>	
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stops.driveTime != null}">
                    				<a4j:actionparam value="#{stops.driveTime}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stops.driveTime == null}"/>	      	                			                			
	                		</rich:column>	                		                		            		             		       		
						</rich:dataTable>
							<br></br>
						<rich:datascroller 	align="center" for="stopsTrips" 							
            			 	styleClass="dataScrollerSmall" 
            			 	id="stopsTripsTableScroller" width="50%">
            			</rich:datascroller>            			
 				          				             	  					         
	         		</div>  
	         	</h:form>
			</div>
			
		</td>
		</tr>
		
		<tr>
		<td>
			<rich:spacer id="filler" width="10px" height="10px">
			</rich:spacer>
		</td>
		<td>
			<div class="section">
				<h:form id="stopsTripsTableSummaryForm">
					<div id="stopsTripsTableSummary" >

	 	        		<rich:dataTable	value="#{teamStopsBean.driverStopsSummary}" 
					       		id="stopsTripsSummary" 
					       		var="stopsSummary"					       
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="#{TeamStopsBean.driversPerPage}"
								columnsWidth="50px,150px,100px,100px,100px,100px,100px,100px,100px">
								
	                		<f:facet name="header">
	                    		<rich:columnGroup>
	                        		<rich:column rowspan="2">#{messages.team_round_trip}</rich:column>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column colspan="4">#{messages.team_time_at_stop}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_drive_time}</rich:column>	                        			
	                        		<rich:column breakBefore="true">#{messages.team_total}</rich:column>
	                        		<rich:column>#{messages.team_low_idle}</rich:column>
	                        		<rich:column>#{messages.team_high_idle}</rich:column>
	                        		<rich:column>#{messages.team_wait}</rich:column>	                        	                        			                        			                        		
	                    		</rich:columnGroup>	
	                		</f:facet>
	                		
	                		<rich:column>
	                			#{stopsSummary.roundTrip}
	                		</rich:column>
	                		
	                		<rich:column id="address_column_sum">
	                			
	                		</rich:column>
	                		
	                		<rich:column>
	                			
	                		</rich:column>	   
	                		
	                		<rich:column>
	                			
	                		</rich:column>
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stopsSummary.totalTimeAtStop != null}">
                    				<a4j:actionparam value="#{stopsSummary.totalTimeAtStop}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stopsSummary.totalTimeAtStop == null}"/>	                			                			
	                		</rich:column>
	                			         
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stopsSummary.lowIdle != null}">
                    				<a4j:actionparam value="#{stopsSummary.lowIdle}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stopsSummary.lowIdle == null}"/>	      	                			                			
	                		</rich:column>
	                			   
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stopsSummary.highIdle != null}">
                    				<a4j:actionparam value="#{stopsSummary.highIdle}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stopsSummary.highIdle == null}"/>	      	                			                			
	                		</rich:column>	    
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stopsSummary.wait != null}">
                    				<a4j:actionparam value="#{stopsSummary.wait}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stopsSummary.wait == null}"/>	      	                			                			
	                		</rich:column>	
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stopsSummary.driveTime != null}">
                    				<a4j:actionparam value="#{stopsSummary.driveTime}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stopsSummary.driveTime == null}"/>	      	                			                			
	                		</rich:column>	                		                		            		             		       		
						</rich:dataTable>  			
 				          				             	  					         
	         		</div>  
	         	</h:form>
			</div>		
		</td>
		</tr>
		
		</table>						
	     
	    </a4j:outputPanel>	
	     
    	<script language="javascript" type="text/javascript">
    		jQuery(function(){
				getAddresses();
			});    				
    	</script>

    </rich:tab>
 </ui:composition>
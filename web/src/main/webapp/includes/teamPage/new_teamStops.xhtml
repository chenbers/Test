<ui:composition 
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:iwi="http://pro.tiwi.com/jsf"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:pretty="http://ocpsoft.com/prettyfaces">
	
	<a4j:loadScript src="#{googleMapURLBean.mapUrl}&amp;hl=#{localeBean.locale.language}" />	
	
	<script language="javascript" type="text/javascript">

		function onStopTabSelectionComplete(){								
			initStopTimeFrameChangeListener();
		}

		function initStopTimeFrameChangeListener() {
			Team.disableTimeFrame("#timeFrameForm\\:timeFrameWeek");		
			Team.disableTimeFrame("#timeFrameForm\\:timeFrameMonth");
			Team.disableTimeFrame("#timeFrameForm\\:timeFrameYear");
			Team.getSelectedTab().bind('timeFrameChange', function(){				
				Team.disableTimeFrame("#timeFrameForm\\:timeFrameWeek");
				Team.disableTimeFrame("#timeFrameForm\\:timeFrameMonth");
				Team.disableTimeFrame("#timeFrameForm\\:timeFrameYear");
			});
		}	

        function getAddresses()
        {              
	    	geocoder = new GClientGeocoder();

	    	jQuery('td[id$="address_column"]').each(function(n){

         		var lat = jQuery(this).find('*[id$="lat"]');
        		var lng = jQuery(this).find('*[id$="lng"]');
        		var address = jQuery(this).find('*[id$="address"]');  
//        		var indexAdd = jQuery(this).find('*[id$="indexAdd"]');        
				
				reverseGeocodeTripAddress(new GLatLng(lat[0].value,lng[0].value),address[0]);	
	    	});                        
        }       

        function reverseGeocodeTripAddress(latlng, addressElement){
         	geocoder.getLocations(latlng, 
        			function(response){    			
    			        if (!response || response.Status.code != 200) {
  			         	  	addressElement.innerHTML = "No address found.";
    			        } 
    			        else {						
			             	addressElement.innerHTML = response.Placemark[0].address;
    			        }     			       
//    			        setAddInBean(indexAdd,addressElement.innerHTML);   			           			       
    		});
	    }   	 

    </script>
 
    <rich:tab id="teamStops" oncomplete="Team.tabChange();">
   	   
	 	<ui:param name="context" value="teamStops" />   	   
   	   
		<f:facet name="label">
	 		<h:panelGroup>
	 			<h:graphicImage value="/images/ico_map.png" /><rich:spacer width="10"/>Stops
			</h:panelGroup>
		</f:facet> 				
				
		<a4j:outputPanel id="stopsPanel" ajaxRendered="true" styleClass="section">
		
		<rich:messages globalOnly="true" errorClass="error" fatalClass="error" warnClass="warning" infoClass="info" styleClass="msg" />		

		<h:form id="stopsReport">
			<ul id="grid_nav" style="margin: 0;">            							
     			<li class="r grid_icon">
     				<h:panelGroup id="#{context}_reportToolImageId">
						<h:graphicImage value="/images/ico_tools.png"/>
					</h:panelGroup>
				</li>
				<li class="r divider"><img src="#{facesContext.externalContext.request.contextPath}/images/grid_nav_divider.png" />
				</li>
			</ul>
			
            <ui:include src="/includes/reportsContextMenu.xhtml">	            
				<ui:param  name="emailModalPanelID" value="#{context}_reportEmailModal" />
				<ui:param  name="reportBean" value="#{teamStopsBean}"/>
				<ui:param  name="attachTo" value="#{context}_reportToolImageId"/>
				<ui:param  name="exportExcel" value="TRUE"/>
				<ui:param name="context" value="#{context}" />
			</ui:include>
			
			<h:outputText id="#{context}_email_modalPanel">
				<ui:include src="/includes/emailReportPopup.xhtml">	
					<ui:param  name="id" value="#{context}_reportEmailModal" />
					<ui:param  name="reportBean" value="#{teamStopsBean}"/>
					<ui:param name="context" value="#{context}" />
				</ui:include>
			</h:outputText>
		</h:form>

			
		<table>
		<tr>
		<td valign="top">
		    
   			<div class="section">
     	  		<h:form id="stopsTableForm">
     	  		
	 	        	<div id="stopsDriverTable" >
	        	
	 	        		<rich:dataTable	value="#{teamStopsBean.drivers}" 
					       		id="stopsDrivers" 
					       		var="drivers"
					       		rowKeyVar="index"
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="#{teamStopsBean.stopsPerPage}"
								columnsWidth="10px,120px,10px">
							<rich:column>     
								<a4j:region id="radioBut">   		 			               
               		 				<h:selectOneRadio id="stopsCheckDriver" immediate="true"
               		 					value="#{teamStopsBean.selectedDriverID}">
               		 					<f:selectItem itemValue="#{drivers.driverID}"/>
               		 					<a4j:support event="onclick" reRender="stopsPanel" oncomplete="getAddresses();initStopTimeFrameChangeListener();"/>                	 					                 						
                					</h:selectOneRadio>
                				</a4j:region>              		
              				</rich:column>
												
							<rich:column style="text-align:left;"> 
								<f:facet name="header">
									<h:outputText value="#{messages.teamPage_driverHeader}"/>
								</f:facet>
     							<pretty:link id="teamTrips-driverPerformance" mappingId="driverPerformance" >
        							<f:param value="#{drivers.driverID}"/>
 									<h:outputText value="#{drivers.person.fullName}"/>
     							</pretty:link>
 							</rich:column>
 							
							<rich:column>
								<div style="position: relative; background-color:#{teamStopsBean.colors[index]}; border: 1px solid black; width: 16px;height: 16px">					
									<div class="trips_label" style="color:#{teamStopsBean.textColors[index]};">
										#{teamStopsBean.labels[index]}
									</div>
								</div>
							</rich:column> 							

						</rich:dataTable>
					
						<br></br>
						
						<rich:datascroller 	align="left" for="stopsDrivers" 							
            			 	styleClass="dataScrollerSmall" 
            			 	id="stopsDriverTableScroller" width="98%"/>            			
 				         
	         		</div>  
 				</h:form>	
			</div>
			
		</td>
		<td valign="top">
			
			<div class="section">
				<h:form id="stopsTripsTableForm">
					<div id="stopsTripsTable" >
					
					
					<table>
					<tr>
					<td>
					
						 	<rich:dataTable	value="#{teamStopsBean.driverStart}"
						 		var="startStops"
					       		id="stopsDepart" 					       							       
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"								
								columnsWidth="50px,150px,100px,100px,100px,100px,100px,100px,100px">
								
	                		<f:facet name="header">
	                    		<rich:columnGroup>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column rowspan="2">Start Location</rich:column>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column rowspan="2">#{messages.team_depart}</rich:column>
	                        		<rich:column colspan="4">Time at Start</rich:column>
	                        		<rich:column rowspan="2"></rich:column>	                        			
	                        		<rich:column breakBefore="true">#{messages.team_total}</rich:column>
	                        		<rich:column>#{messages.team_low_idle}</rich:column>
	                        		<rich:column>#{messages.team_high_idle}</rich:column>
	                        		<rich:column>#{messages.team_wait}</rich:column>	                        	                        			                        			                        		
	                    		</rich:columnGroup>	
	                		</f:facet>

	                		
	                		<rich:column>
	                			
	                		</rich:column>
	                		
	                		<rich:column id="address_column">
	                			<h:inputHidden id="latStart" value="#{startStops.lat}"/>
								<h:inputHidden id="lngStart" value="#{startStops.lng}"/>								
 								<h:outputText id="addressStart"/>
	                		</rich:column>
	                		
	                		<rich:column>	                			
                            	<h:outputText value="#{startStops.arriveTime * 1000}">
                                	<f:convertDateTime pattern="#{messages.stopsDateTimeFormat}" timeZone="#{teamStopsBean.timeZone}" />
                            	</h:outputText>     	                			
	                		</rich:column>	   
	                		
	                		<rich:column>	                			
                            	<h:outputText value="#{startStops.departTime * 1000}">
                                	<f:convertDateTime pattern="#{messages.stopsDateTimeFormat}" timeZone="#{teamStopsBean.timeZone}" />
                            	</h:outputText>  	                			
	                		</rich:column>
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}">
                    				<a4j:actionparam value="#{startStops.departTime - startStops.arriveTime}" 
                    					converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			        			                			
	                		</rich:column>
	                			         
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{startStops.idleLo != null}">
                    				<a4j:actionparam value="#{startStops.idleLo}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{startStops.idleLo == null}"/>	      	                			                			
	                		</rich:column>
	                			   	                	
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{startStops.idleHi != null}">
                    				<a4j:actionparam value="#{startStops.idleHi}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{startStops.idleHi == null}"/>	      	                			                			
	                		</rich:column>	    
	                			                
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" >
                    				<a4j:actionparam value="#{startStops.departTime - startStops.arriveTime - startStops.idleHi - startStops.idleLo}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			     	                			                			
	                		</rich:column>	
	                			                	
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}">
                    				<a4j:actionparam value="#{startStops.driveTime}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			 	                			                			
	                		</rich:column>						
							</rich:dataTable>
					
					</td>
					</tr>
					<tr>
					<td>

	 	        		<rich:dataTable	value="#{teamStopsBean.driverStops}" 
					       		id="stopsTrips" 
					       		var="stops"					       
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="#{teamStopsBean.stopsPerPage}"
								columnsWidth="50px,150px,100px,100px,100px,100px,100px,100px,100px">
								
	                		<f:facet name="header">
	                    		<rich:columnGroup>
	                        		<rich:column rowspan="2">#{messages.team_zone_arrival}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_stop_location}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_arrive}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_depart}</rich:column>
	                        		<rich:column colspan="4">#{messages.team_time_at_stop}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_drive_time}</rich:column>	                        			
	                        		<rich:column breakBefore="true">#{messages.team_total}</rich:column>
	                        		<rich:column>#{messages.team_low_idle}</rich:column>
	                        		<rich:column>#{messages.team_high_idle}</rich:column>
	                        		<rich:column>#{messages.team_wait}</rich:column>	                        	                        			                        			                        		
	                    		</rich:columnGroup>	
	                		</f:facet>
	                		
	                		<rich:column>
	                			#{stops.zoneName}
	                		</rich:column>
	                		
	                		<rich:column id="address_column">
	                			<h:inputHidden id="lat" value="#{stops.lat}"/>
								<h:inputHidden id="lng" value="#{stops.lng}"/>								
 								<h:outputText id="address"/>
	                		</rich:column>
	                		
	                		<rich:column>	                			
                            	<h:outputText value="#{stops.arriveTime * 1000}">
                                	<f:convertDateTime pattern="#{messages.stopsDateTimeFormat}" timeZone="#{teamStopsBean.timeZone}" />
                            	</h:outputText>     	                			
	                		</rich:column>	   
	                		
	                		<rich:column>	                			
                            	<h:outputText value="#{stops.departTime * 1000}">
                                	<f:convertDateTime pattern="#{messages.stopsDateTimeFormat}" timeZone="#{teamStopsBean.timeZone}" />
                            	</h:outputText>  	                			
	                		</rich:column>
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}">
                    				<a4j:actionparam value="#{stops.departTime - stops.arriveTime}" 
                    					converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			        			                			
	                		</rich:column>
	                			         
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stops.idleLo != null}">
                    				<a4j:actionparam value="#{stops.idleLo}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stops.idleLo == null}"/>	      	                			                			
	                		</rich:column>
	                			   	                	
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" rendered="#{stops.idleHi != null}">
                    				<a4j:actionparam value="#{stops.idleHi}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			<h:outputText value="00:00:00" rendered="#{stops.idleHi == null}"/>	      	                			                			
	                		</rich:column>	    
	                			                
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" >
                    				<a4j:actionparam value="#{stops.departTime - stops.arriveTime - stops.idleHi - stops.idleLo}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			     	                			                			
	                		</rich:column>	
	                			                	
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}">
                    				<a4j:actionparam value="#{stops.driveTime}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			 	                			                			
	                		</rich:column>	                		                		            		             		       		
						</rich:dataTable>
							<br></br>
						<rich:datascroller 	align="center" for="stopsTrips" 							
            			 	styleClass="dataScrollerSmall" 
            			 	id="stopsTripsTableScroller" width="50%">
            			</rich:datascroller>
            			
            			
            			</td>
            			</tr>
            			</table>            			
 				          				             	  					         
	         		</div>  
	         	</h:form>
			</div>
			
		</td>
		</tr>
		
		<tr>
		<td>
			<rich:spacer id="filler" width="10px" height="10px">
			</rich:spacer>
		</td>
		<td>
			<div class="section">
				<h:form id="stopsTripsTableSummaryForm">
					<div id="stopsTripsTableSummary" >

	 	        		<rich:dataTable	value="#{teamStopsBean.driverStopsSummary}" 
					       		id="stopsTripsSummary" 
					       		var="stopsSummary"					       
								styleClass="datagrid" 
								rowClasses="tableOdd,tableEven"
								rows="#{teamStopsBean.stopsPerPage}"
								columnsWidth="50px,150px,100px,100px,100px,100px,100px,100px,100px">
								
	                		<f:facet name="header">
	                    		<rich:columnGroup>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column rowspan="2"></rich:column>
	                        		<rich:column colspan="4">#{messages.team_time_at_stop}</rich:column>
	                        		<rich:column rowspan="2">#{messages.team_drive_time}</rich:column>	                        			
	                        		<rich:column breakBefore="true">#{messages.team_total}</rich:column>
	                        		<rich:column>#{messages.team_low_idle}</rich:column>
	                        		<rich:column>#{messages.team_high_idle}</rich:column>
	                        		<rich:column>#{messages.team_wait}</rich:column>	                        	                        			                        			                        		
	                    		</rich:columnGroup>	
	                		</f:facet>
	                		
	                		<rich:column>
	                			
	                		</rich:column>
	                		
	                		<rich:column id="address_column_sum">
	                			
	                		</rich:column>
	                		
	                		<rich:column>
	                			
	                		</rich:column>	   
	                		
	                		<rich:column>
	                			
	                		</rich:column>
	                		
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}">
                    				<a4j:actionparam value="#{stopsSummary.departTime - stopsSummary.arriveTime}" 
                    					converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			        			                			
	                		</rich:column>
	                			         
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}">
                    				<a4j:actionparam value="#{stopsSummary.idleLo}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			    	                			                			
	                		</rich:column>
	                			   	                	
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}">
                    				<a4j:actionparam value="#{stopsSummary.idleHi}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			      	                			                			
	                		</rich:column>	    
	                			                
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}" >
                    				<a4j:actionparam value="#{stopsSummary.departTime - stopsSummary.arriveTime - stopsSummary.idleHi - stopsSummary.idleLo}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			     	                			                			
	                		</rich:column>	
	                			                	
	                		<rich:column>
                    			<h:outputFormat value="#{messages.reports_time}">
                    				<a4j:actionparam value="#{stopsSummary.driveTime}" converter="TimeToStringConverter"/>                    
                    			</h:outputFormat>										
                    			 	                			                			
	                		</rich:column>	      	                		            		             		       		
						</rich:dataTable>  			
 				          				             	  					         
	         		</div>  
	         	</h:form>
			</div>		
		</td>
		</tr>
		
		</table>						
	     
	    </a4j:outputPanel>
	    
		<a4j:form id="setAddressInBean">
			<a4j:jsFunction name="setAddInBean" action="#{teamStopsBean.addressFromClient}">
				<a4j:actionparam name="addressIndex" assignTo="#{teamStopsBean.addressIndex}"/>
				<a4j:actionparam name="addressToSet" assignTo="#{teamStopsBean.addressToSet}"/>
			</a4j:jsFunction>
		</a4j:form>	
	     
    	<script language="javascript" type="text/javascript">
    		jQuery(function(){
    			onStopTabSelectionComplete();
    			getAddresses();
			});    				
    	</script>

    </rich:tab>
 </ui:composition>
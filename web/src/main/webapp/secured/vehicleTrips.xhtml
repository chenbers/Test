<ui:composition template="/layout/layout.xhtml" 
				xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
	  			xmlns:h="http://java.sun.com/jsf/html" 
	  			xmlns:rich="http://richfaces.org/rich"
	  			xmlns:a4j="http://richfaces.org/a4j"
	  			xmlns:c="http://java.sun.com/jstl/core"
	  			xmlns:f="http://java.sun.com/jsf/core"
	  			>

	<ui:define name="scripts">
		<script src="#{facesContext.externalContext.request.contextPath}/js/FusionCharts.js" type="text/javascript"></script>	
		<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=#{gmBean.key}" type="text/javascript"></script>		
	</ui:define>

	<ui:param name="homeSelected" value="current" />
	
	<ui:define name="content">
<div id="wrapper">

<ul id="grid_nav">
	<li class="l grid_icon"><img src="images/ico_line.png" /></li>
	<li class="l grid_title">Vehicle Performance:&#160;<h:outputText>#{vehicleBean.vehicleName}</h:outputText></li>
	<li class="l divider"><img src="/images/grid_nav_divider.png" /></li>
</ul>
<div class="spacer"></div>
<table width="940" border="0" cellspacing="0" cellpadding="0" align="center">
  <tr>
    <td width="330" valign="top">
<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="cal">Date Range </span>
						<span class="panel_links"></span>
					</div>
				</div>
					<div class="panel_w">
					  <div class="panel_content">
					    <rich:panel id="date_picker_panel">
						<h:form>
							<table width="320" cellpadding="4" cellspacing="0" class="" id="">
							  <tbody>
							  <tr>
								<td width="73">Start Date </td>
								<td width="178">
									<a4j:outputPanel id="calendarStart" layout="block">
				                    	<rich:calendar value="#{vehicleTripsBean.startDate}"
				                        	locale="en/US"
				                        	popup="true"
				                        	datePattern="MMMMM d, yyyy"
				                        	showApplyButton="false" cellWidth="24px" cellHeight="22px"/>
				           			</a4j:outputPanel> 
								</td>
								<td width="51">to</td>
							  </tr>
							  <tr>
								<td>End Date </td>
								<td>
								  <a4j:outputPanel id="calendarEnd" layout="block">
				                    	<rich:calendar value="#{vehicleTripsBean.endDate}"
				                        	locale="en/US"
				                        	popup="true"
				                        	datePattern="MMMMM d, yyyy"
				                        	showApplyButton="false" cellWidth="24px" cellHeight="22px"/>
				           			</a4j:outputPanel>
								</td>
								<td></td>
							  </tr>
							  <tr>
							    <td> </td>
							    <td> <h:commandButton value="Apply Date Range" /></td>
							    <td> </td>
							    </tr>
							  </tbody>
						  </table>
						 </h:form>
						</rich:panel>
					  </div>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
		
		<div class="spacer"></div>
		
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class=""><h:outputText>Stats:&#160;</h:outputText>
						<h:outputText value="#{vehicleTripsBean.startDate}">
							<f:convertDateTime pattern="MMM dd, yyyy" />
						</h:outputText>&#160;to&#160; 
						<h:outputText value="#{vehicleTripsBean.endDate}">
							<f:convertDateTime pattern="MMM dd, yyyy" />
						</h:outputText>
						</span>
						<span class="panel_links"></span>
					</div>
				</div>
					<div class="panel_w">
					  <div class="panel_content">
					    <div class="" id="">
								<table width="320" id="" cellpadding="4" cellspacing="0" class="">
								  <tbody>
								  <tr>
									<td width="240">Total Miles Driven:</td>
									<td width="70"><h:outputText>#{vehicleTripsBean.milesDriven}</h:outputText></td>
								  </tr>
								  <tr>
								    <td>Total Idle Time: </td>
								    <td><h:outputText>#{vehicleTripsBean.idleTime}</h:outputText></td>
								    </tr>
								  <tr>
								    <td>Total Trips:</td>
								    <td><h:outputText>#{vehicleTripsBean.numTrips}</h:outputText></td>
								    </tr>
								  <tr>
								    <td>Total Drive Time:</td>
								    <td><h:outputText>#{vehicleTripsBean.totalDriveTime}</h:outputText></td>
								    </tr>
								  </tbody>
						  </table>
						</div>
					  </div>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
		
		<div class="spacer"></div>
		
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="">Events</span>
						<span class="panel_links"></span>
					</div>
				</div>
					<div class="panel_w">
					  <div class="panel_content">
				<!-- Start Trip table --> 
				<rich:panel id="selectedTrip">
					
						<rich:dataTable 
						value="#{vehicleTripsBean.selectedTrips[0].trip.events}" 
						id="selectedTripTable"
						var="item" styleClass="datagrid"
						rowClasses="tableOdd,tableEven" cellspacing="1" rows="10"  
						width="100%">  <!-- //TODO: Make generic Odd Even CSS -->

							<!-- Data -->
							
							<rich:column sortBy="#{item.addressStr}">
								<img src="../images/ico_violation.png" width="20" height="20" />
							</rich:column>

							<rich:column sortBy="#{item.addressStr}">
								<f:facet name="header">
									<h:outputText value="Address" />
								</f:facet>
								<h:outputText value="#{item.addressStr}" />
							</rich:column>
							
							<rich:column sortBy="#{item.time}">
								<f:facet name="header">
									<h:outputText value="Time" />
								</f:facet>
								<h:outputText value="#{item.time}">
									<f:convertDateTime pattern="MMM dd, yyyy hh:mm" />
								</h:outputText>
							</rich:column>
						</rich:dataTable>
					 </rich:panel>
				<!-- End Trip table -->
					    
					  </div>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
		
		<div class="spacer"></div>
		
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="">Settings </span>
						<span class="panel_links"></span>
					</div>
				</div>
					<div class="panel_w">
					  <div class="panel_content">
					    <div class="" id="">
					    <a4j:region id="optionsRegion">
							<table width="320" cellpadding="4" cellspacing="0" class="" id="settings">
								  <tbody>
								  <tr>
									<td width="290">Show last 10 Trips on map.</td>
								    <td width="25">
									    <a4j:status id="showLastTenStatus" for="optionsRegion">
											<f:facet name="start">
												<h:outputText><img src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif" align="top" />&#160;</h:outputText>
											</f:facet>
										</a4j:status>
									</td>
									<td width="20">
									    <a4j:form id="showAllForm" reRender="selectedTripMap">
										    <h:selectBooleanCheckbox id="showAllCheckBox" value="#{vehicleTripsBean.showAllTrips}">
										    	<a4j:support event="onchange" reRender="selectedTripMap" />
										    </h:selectBooleanCheckbox>
										</a4j:form>
								    </td>
								    </tr>
								  <tr>
									<td>Show idle markers</td>
									<td></td>
								    <td>
								      <h:selectBooleanCheckbox id="showIdleCheckBox" value="#{vehicleTripsBean.showIdleMarkers}" onchange="showIdleChanged();"/>
								    </td>
								    </tr>
								  <tr>
								    <td>Show warnings</td>
								    <td></td>
								    <td>
								      <h:selectBooleanCheckbox id="showWarningsCheckBox" value="#{vehicleTripsBean.showWarnings}" onchange="showWarningsChanged();"/>
								    </td>
								    </tr>
								  </tbody>
								</table>
							</a4j:region>
						</div>
					  </div>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
		
		<div class="spacer"></div>
		
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="">Legend</span>
						<span class="panel_links"></span>
					</div>
				</div>
					<div class="panel_w">
					  <div class="panel_content">
					    <div class="" id="">
							<div class="" id="">
								<table width="320" id="legend" cellpadding="4" cellspacing="0" class="sortable-onload-show no-arrow colstyle-alt paginate-15 max-pages-4">
								  <tbody>
								  <tr>
									<td width="25"><img src="../images/ico_start.png" width="21" height="20" /></td>
									<td width="120">Start</td>
								    <td width="30"><img src="../images/ico_idle.png" width="20" height="20" /></td>
								    <td width="119">Engine Idle</td>
								  </tr>
								  <tr>
									<td><img src="../images/ico_violation.png" width="20" height="20" /></td>
									<td>Violation</td>
								    <td><img src="../images/ico_end_trip.png" width="21" height="20" /></td>
								    <td>End</td>
								  </tr>
								  </tbody>
								</table>
							</div>
						</div>
					  </div>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
	</td>
    <td width="10"><img src="images/x.gif" width="10" /></td>
    <td width="600" valign="top">
		<!-- START PANEL -->
		<div class="" style="width:600px; margin: 0 auto 0 auto;">
			<div class="panel_nw">
				<div class="panel_title">
					<span class="vehicle">Trips by #{vehicleBean.vehicleName}</span>
					<span class="panel_links"></span></div>
			</div>
			<div class="panel_w">
			  <div class="panel_content" align="center">
				<!-- Start Trip table --> 
					<a4j:form id="trendTable">
						<rich:dataTable 
						value="#{vehicleTripsBean.trips}" id="items"
						var="item" styleClass="datagrid"
						rowClasses="trendTableOdd,trendTableEven" cellspacing="1" rows="5"  
						width="100%">  <!-- //TODO: Make generic Odd Even CSS -->

							<!-- Data -->
										
							<rich:column sortBy="#{item.dateShort}">
								<f:facet name="header">
									<h:outputText value="Date" />
								</f:facet>
									<a4j:commandLink value="#{item.dateShort}" reRender="selectedTripTable,selectedTripMap">
										<f:setPropertyActionListener value="#{item}" target="#{vehicleTripsBean.selectedTrip}" />
									</a4j:commandLink>
							</rich:column>
							
							<rich:column sortBy="#{item.timeShort}">
								<f:facet name="header">
									<h:outputText value="Time" />
								</f:facet>
									<h:outputText value="#{item.timeShort}" />
							</rich:column>
							
							<rich:column sortBy="#{item.distance}">
								<f:facet name="header">
									<h:outputText value="Dist" />
								</f:facet>
								<h:outputText value="#{item.distance}" />		
							</rich:column>
							
							<rich:column sortBy="#{item.startAddress}">
								<f:facet name="header">
									<h:outputText value="Start" />
								</f:facet>
								<h:outputText value="#{item.startAddress}" />
							</rich:column>
							
							<rich:column sortBy="#{item.endAddress}">
								<f:facet name="header">
									<h:outputText value="End" />
								</f:facet>
								<h:outputText value="#{item.endAddress}" />
							</rich:column>
							
							<rich:column sortBy="#{item.duration}">
								<f:facet name="header">
									<h:outputText value="Dur" />
								</f:facet>
								<h:outputText value="#{item.duration}" />
							</rich:column>
						</rich:dataTable>
						<div class="spacer"></div>
						<rich:datascroller align="center" for="items" maxPages="20"
           				 page="#{vehicleTripsBean.tripsPager}" id="scroller" reRender="items" />
					</a4j:form> 
				<!-- End Trip table -->
			  </div>
			</div>
			<div class="panel_sw">
				<div class="panel_statusbar"></div>
			</div>
		</div>
		<!-- END PANEL -->
		
		<div class="spacer"></div>
		
		<!-- START PANEL -->
		<div class="" style="width:600px; margin: 0 auto 0 auto;">
			<div class="panel_nw">
				<div class="panel_title">
					<span class="map">Map</span>
					<span class="panel_links"></span></div>
			</div>
			<div class="panel_w">
			  <rich:panel bodyClass="panel_content" id="selectedTripMap">
			  <h:panelGroup styleClass="map-border" layout="block">
				<div id="map-canvas" style="width:588px;height:400px;border:0"></div>
				</h:panelGroup>
			   		<script type="text/javascript">
			   		
					var showWarnings = new Boolean(true);
					var showIdleMarkers = new Boolean(true);
					
					var baseIcon = new GIcon();
						baseIcon.iconSize = new GSize(21, 20);
						baseIcon.iconAnchor = new GPoint(6, 20);
						baseIcon.infoWindowAnchor = new GPoint(5, 1);

					var bounds = new GLatLngBounds();

				 		map = new GMap2(document.getElementById("map-canvas"));
  						map.addControl(new GLargeMapControl());
  						map.addControl(new GMapTypeControl());
  						map.addControl(new GOverviewMapControl()); 
  						map.setCenter(new GLatLng(#{vehicleTripsBean.selectedTrips[0].routeLastStep.lat}, #{vehicleTripsBean.selectedTrips[0].routeLastStep.lng}), 14);
  						map.setMapType(G_NORMAL_MAP);
						
				    function createMarker(point, message, iconImage)
				        {
				          var markerIcon = new GIcon(baseIcon);
				          markerIcon.image = iconImage;
	
				          // Set up our GMarkerOptions object
				          markerOptions = { icon:markerIcon };
				          var marker = new GMarker(point, markerOptions);
	
				          GEvent.addListener(marker, "click", function() {
				            marker.openInfoWindowHtml("<b>" + message + "</b>");
				          });
				          return marker;
				        }

			   		function drawSelectedTrips()
			   		{
			   			if (GBrowserIsCompatible()) 
        				{
			   				map.clearOverlays(); 
							var polyline;
							var marker;
							var startlatlng;
							var endlatlng;
							
			   				<ui:repeat value="#{vehicleTripsBean.selectedTrips}" var="trip">
								polyline = new GPolyline([
								<ui:repeat value="#{trip.route}" var="rt">
										new GLatLng(#{rt.lat}, #{rt.lng}),
								</ui:repeat>
		    			  		new GLatLng(#{trip.routeLastStep.lat}, #{trip.routeLastStep.lng})

								], "#0000ff", 6);
								map.addOverlay(polyline);

								//Start of trip marker
								startlatlng = new GLatLng(#{trip.route[0].lat}, #{trip.route[0].lng});
								marker = createMarker(startlatlng, "Start of trip.<br />" + "#{trip.trip.startTime}<br />#{trip.startAddress}",
														"#{facesContext.externalContext.request.contextPath}/images/ico_start.png");
								map.addOverlay(marker);
								bounds.extend(marker.getPoint());

								//End of trip marker
								endlatlng = new GLatLng(#{trip.routeLastStep.lat}, #{trip.routeLastStep.lng});
								marker = createMarker(endlatlng, "End of trip.<br />" + "#{trip.trip.endTime}<br />#{trip.endAddress}",
														"#{facesContext.externalContext.request.contextPath}/images/ico_end_trip.png");
								map.addOverlay(marker);
								bounds.extend(marker.getPoint());

			  				</ui:repeat>

			  				if(showWarnings == true)
							{
				  				var violation;
								<ui:repeat value="#{vehicleTripsBean.violationEvents}" var="violation">
									violation = new GLatLng(#{violation.latitude}, #{violation.longitude});
									map.addOverlay(createMarker(violation, "#{violation.eventType} Violation.<br />#{violation.time}",
													"#{facesContext.externalContext.request.contextPath}/images/ico_violation.png"));
								</ui:repeat>
							}

							var idleMarker;
							if(showIdleMarkers == true)  //TODO Get Idle Events from DAO 
							{
								idleMarker = new GLatLng(32.961299896240234, -117.1980972290039);
								map.addOverlay(createMarker(idleMarker, "Vehicle Idle.<br />Dec 04, 2008 07:06<br />Duration 3.45 minutes.",
								"#{facesContext.externalContext.request.contextPath}/images/ico_idle.png"));

								idleMarker = new GLatLng(32.9817008972168, -117.1593017578125);
								map.addOverlay(createMarker(idleMarker, "Vehicle Idle.<br />Dec 04, 2008 07:01<br />Duration 13.02 minutes.",
								"#{facesContext.externalContext.request.contextPath}/images/ico_idle.png"));
							}	
        				}
			   			
					}

						//Update Map.
				    function updateMap()
				    {
				    	drawSelectedTrips();
					}

				    // Show Warnings Checkbox changed   //TODO: CLEANER WAY TO DO THIS??
				    function showWarningsChanged()
				    {
				    	if(document.getElementById('showWarningsCheckBox').checked == true)
				    	{
							showWarnings = true;
							updateMap();
				    	}
				    	else
				    	{
							showWarnings = false;
				    		updateMap();
				    	}
					}

					// Show Idle Markers Checkbox changed
				    function showIdleChanged()
				    {
				      	if(document.getElementById('showIdleCheckBox').checked == true)
				    	{
				      		showIdleMarkers = true;
							updateMap();
				    	}
				    	else
				    	{
				    		showIdleMarkers = false;
				    		updateMap();
				    	}
					}

					//On page load and A4J Re-render
				    updateMap();
				    map.setZoom(map.getBoundsZoomLevel(bounds));
				    map.setCenter(bounds.getCenter());
    				
  					</script> 
			  </rich:panel>
			</div>
			<div class="panel_sw">
				<div class="panel_statusbar"></div>
			</div>
		</div>
		<!-- END PANEL -->
	</td>
  </tr>
</table>
</div>
</ui:define>

</ui:composition>

<ui:composition template="/layout/layout.xhtml" 
				xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
	  			xmlns:h="http://java.sun.com/jsf/html" 
	  			xmlns:f="http://java.sun.com/jsf/core"
	  			xmlns:rich="http://richfaces.org/rich"
	  			xmlns:a4j="http://richfaces.org/a4j">

	<ui:param name="liveFleetSelected" value="current" />
	
	<ui:define name="scripts">
		<script src="http://maps.google.com/maps?file=api&amp;v=2.x&amp;key=#{gmBean.key}" type="text/javascript"></script>
		<script type="text/javascript">
	    function createMarker(point, message, iconImage)
        {
          var markerIcon = new GIcon(baseIcon);
          markerIcon.image = iconImage;

          // Set up our GMarkerOptions object
          markerOptions = { icon:markerIcon };
          var marker = new GMarker(point, markerOptions);

          GEvent.addListener(marker, "click", function() {
            marker.openInfoWindowHtml("<b>" + message + "</b>");
          });
          return marker;
        }

   		function showAddress(address) {
   	      if (geocoder) {
   	        geocoder.getLatLng(
   	          address,
   	          function(point) {
   	            if (!point) {
   	              alert(address + " not found");
   	            } else {
   	              //map.setCenter(point, 13);
   	              var marker = new GMarker(point);
   	              map.addOverlay(marker);

   	              marker.openInfoWindowHtml(address);

   	              
   	           	  bounds.extend(marker.getPoint());

				  var loc;
     	          loc = marker.getLatLng();
	              notifyBean(loc.lat(), loc.lng());	
	             
				
     	            }
   	          }
   	        );
   	      }
   	    }
	    
	</script>	
	</ui:define>
	
	<ui:define name="content">
<table width="940" border="0" cellspacing="0" cellpadding="0" align="center">
  <tr>
    <td width="330" valign="top">
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="vehicle">Dispatch</span>

						<span class="panel_links"></span>
					</div>
				</div>
					<div class="panel_w">
					  <div class="panel_content">
							<div class="datagrid">
								<table width="320" id="theTable" cellpadding="0" cellspacing="0" class="sortable-onload-0 no-arrow rowstyle-alt colstyle-alt paginate-15 max-pages-4 paginationcallback-callbackTest-calculateTotalRating sortcompletecallback-callbackTest-calculateTotalRating">
								  <thead>
								  <tr>

									<th width="38" height="27" class="sortable-numeric">#</th>
									<th width="150" class="sortable-text">Driver</th>
									<th width="79" class="sortable-text">Phone</th>
									<th width="51" class="">&#160;</th>
								  </tr>
								  </thead>
								  <tbody>

								  <tr>
									<td>1</td>
									<td>Amy Jones </td>
									<td>562-3255</td>
									<td><a href="#">show</a></td>
								  </tr>
								  <tr>

									<td>2</td>
									<td>Paul Smith </td>
									<td>568-6522</td>
									<td><a href="#">show</a></td>
								  </tr>
								  <tr>
									<td>3</td>

									<td>Dan Lee </td>
									<td>654-6544</td>
									<td><a href="#">show</a></td>
								  </tr>
								  <tr>
									<td>4</td>
									<td>Stan Ferrera </td>

									<td>598-7455</td>
									<td><a href="#">show</a></td>
								  </tr>
								  <tr>
									<td>5</td>
									<td>Jose Sanchez </td>
									<td>788-1022</td>

									<td><a href="#">show</a></td>
								  </tr>
								  </tbody>
								</table>
							</div>
					  </div>
					</div>
				<div class="panel_sw">

					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
	</td>
    <td width="10"><img src="images/x.gif" width="10" /></td>
    <td width="600" valign="top">
		<!-- START PANEL -->
		<div class="" style="width:600px; margin: 0 auto 0 auto;">

			<div class="panel_nw">
				<div class="panel_title">
					<span class="map">Live Fleet</span>
					<span class="panel_links"><a href="#">refresh</a></span>
				</div>
			</div>
			<div class="panel_w">
			  <div class="panel_content" align="center">

			  	<table width="580" border="0" cellpadding="4" cellspacing="0">
				  <tr>
					<td width="90">Find Address: </td>
					<td width="301">
						<input type="text" size="60" id="addressTextBox" value="1600 Amphitheatre Pky, Mountain View, CA" />
						
					</td>
					<td width="165">
						<button value="" class="left" onclick="renderVehicles = true; showAddress(document.getElementById('addressTextBox').value);"><span class="search">Locate</span></button>
					</td>
				  </tr>
				</table>
			  
				<h:panelGroup styleClass="map-border" layout="block">
					<div id="map-canvas" style="width:580px;height:700px;border:0"></div>
		  		</h:panelGroup>
			    <script type="text/javascript">
				var map = null;
			    var geocoder = null;
			    var renderVehicles = new Boolean(false);

			    var baseIcon = new GIcon();
					baseIcon.iconSize = new GSize(21, 20);
					baseIcon.iconAnchor = new GPoint(6, 20);
					baseIcon.infoWindowAnchor = new GPoint(5, 1);

				var bounds = new GLatLngBounds();

		        if (GBrowserIsCompatible()) {
		        	map = new GMap2(document.getElementById("map-canvas"));
						map.addControl(new GLargeMapControl());
						map.addControl(new GMapTypeControl());
						map.addControl(new GOverviewMapControl()); 
						map.setCenter(new GLatLng(37.4419, -122.1419), 14);
						map.setMapType(G_NORMAL_MAP);
		    	    geocoder = new GClientGeocoder();
		        }
			    </script>
	    			<rich:panel id="vehicleScript">
			    		<script type="text/javascript">


	  					//Display Markers on map object.
	  					if(renderVehicles == true)
						{		  			
							//alert('rerender div');
			  					var marker;
			  					var driverLoc;
			  					
			  					<ui:repeat value="#{liveFleetBean.drivers}" var="driver">
			  						driverLoc = new GLatLng(#{driver.lastLocation.lat}, #{driver.lastLocation.lng});
									marker = createMarker(driverLoc,"#{driver.driver.person.first} #{driver.driver.person.last} <br />#{driver.driver.person.workPhone}",
															"#{facesContext.externalContext.request.contextPath}/images/ico_start.png");
									map.addOverlay(marker);
									bounds.extend(marker.getPoint());
									
								</ui:repeat>
	
								map.setZoom(map.getBoundsZoomLevel(bounds));
							    map.setCenter(bounds.getCenter());
							    
						}
		  					 
  							  				
						</script>
					</rich:panel>
					
					<a4j:form>
			        	<a4j:jsFunction name="notifyBean" reRender="vehicleScript">
			            	<a4j:actionparam name="param1" assignTo="#{liveFleetBean.addressLatLng.lat}"  />
			            	<a4j:actionparam name="param2" assignTo="#{liveFleetBean.addressLatLng.lng}"  />                  
			       		</a4j:jsFunction>
			    	</a4j:form>
			  
			  </div>
			</div>
			<div class="panel_sw">
				<div class="panel_statusbar"></div>
			</div>
		</div>

		<!-- END PANEL -->
	</td>
  </tr>
</table>
	
			
<script type="text/javascript">
	//Set up map.
	//initialize();
</script>

</ui:define>
</ui:composition>

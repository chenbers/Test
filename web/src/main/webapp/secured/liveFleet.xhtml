<ui:composition template="/layout/layout.xhtml" 
				xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
	  			xmlns:h="http://java.sun.com/jsf/html" 
	  			xmlns:f="http://java.sun.com/jsf/core"
				xmlns:fn="http://java.sun.com/jsp/jstl/functions"
	  			xmlns:rich="http://richfaces.org/rich"
	  			xmlns:a4j="http://richfaces.org/a4j"
	  			xmlns:t="http://myfaces.apache.org/tomahawk"
	  			xmlns:security="http://pro.tiwi.com/jsf/security"
                xmlns:tiwiprofn="http://pro.tiwi.com/jsffunctions"
                xmlns:pretty="http://ocpsoft.com/prettyfaces">

	<ui:param name="title" value="#{messages.navigation_liveFleet}"/>
	<ui:param name="liveFleetSelected" value="current" />
	<ui:param name="ajaxPanels" value="inputFormPanel"/>
	<ui:define name="scripts">
 		<ui:include src="/includes/map/portalMap3.xhtml"/>
		<a4j:loadScript src="/js/mapv3/markerclusterer_compiled.js"/>
		<a4j:loadScript src="/js/mapv3/mapBubble.js"/>
			
			
		<script type="text/javascript">
		//<![CDATA[

	  	var markerClusterer;
		var markers = [];
	    var addressLatLng = null;
		var mapNeedsInit = true;
		
	    function initMap() {
			if (mapNeedsInit) {
	    		  
				inthincMap.init({
					'center' : {
						'lat' : mapDefaultLoc.lat(),
						'lng' : mapDefaultLoc.lng()
					},
					'zoom' : mapDefaultZoom
				});
				initLayers();

				bounds = new google.maps.LatLngBounds();

				var marker = inthincMap.createMarker({ position: mapDefaultLoc });
				bounds.extend(marker.getPosition());
				
				var node = document.getElementById("defaultMessage").cloneNode(true);
				node.style.display = 'block';
				
				inthincMap.createInfoWindow({content: node, marker : marker});

				mapNeedsInit = false;

			}
		}
		
		function refresh()
		{
			processForm('liveFleetAddressTextBox', 'countComboBox');
		}
	    
   		function processForm(addressId, countId)
   		{
			//Get form elements
   			var address = document.getElementById(addressId).value;
   			var count = document.getElementById(countId).value;

   			// Clear all existing markers and zoom boundary.
   			inthincMap.clearMarkers();
			
			bounds = new google.maps.LatLngBounds();
   			
			//Text field is blank, process form for only number of vehicles dropdown.
	   		if(address.length == 0)  
   			{
	   			notifyBean(mapDefaultLoc.lat(), mapDefaultLoc.lng(), count);
   				return;
   	   		}
		    inthincMap.lookupAddress(address,
		   	          function(result, status) {
		    	  			if (status != google.maps.GeocoderStatus.OK) {
			        		  	console.log(address + " not found");
			        	  } else {
								var loc = result[0].geometry.location;

								var marker = inthincMap.createMarker({position : loc}); 
								inthincMap.createInfoWindow({
									content: "<b>" + address + "</b>", 
									marker : marker
								});

								bounds.extend(marker.getPosition());
								notifyBean(loc.lat(), loc.lng(), count);
						}
				});
   		}

		/* Check if Enter pressed in form.
		 * Process form if user pressed enter in form fields.
		*/
		function checkEnter(e) { 
   			var characterCode;

   			if(e.which) { 
   				e = e;
   				characterCode = e.which; //NN4's which property
   			}
   			else {
   				e = event;
   				characterCode = e.keyCode;//IE's keyCode property
   			}
   			
   			//if generated character code is equal to ascii 13 (if enter key)
   			if(characterCode == 13) {    				
				processForm('liveFleetAddressTextBox', 'countComboBox');
   				return false; 
			}
   			else {	
   				return true;  
   			}
   		}

		    var mapDefaultLoc= new google.maps.LatLng(#{liveFleetBean.addressLatLng.lat}, #{liveFleetBean.addressLatLng.lng})
		    var mapDefaultZoom = #{liveFleetBean.addressZoom};
	
			function bodyLoad()
			{
				initMap();
				addMarkers();
				defaultAddressElement = "liveFleetVehicleBubbles:bubbleAddress";
				bubbleElement = "vehicleBubble";
				errorMessage = "#{messages.sbs_badLatLng}"
				addressLookupAddressFormat = #{liveFleetBean.addressFormat};
			}
	
			function funcToCall(obj) {
				
				jQuery('#dispatchForm\\:foundZoneName').val(obj.name);	
				if (		obj.callFuncID == 0 ) {
					fillBubbleMarker(obj.itemID,obj.subID);
					
				} else if ( obj.callFuncID == 1 ) {
					fillTripBubble(obj.itemID,obj.subID);
					
				} else if ( obj.callFuncID == 2 ) {
					fillEventBubble(obj.itemID,obj.subID);
					
				} else if ( obj.callFuncID == 4 ) {
					fillBubbleMap(obj.noteID);
				}
			} 		 

 
	   		//]]>

		</script>	
	
	</ui:define>
	<ui:define name="content">
	
	<!-- BEGIN GOOGLE MAP POPUPS -->
	<h:form id="liveFleetVehicleBubbles">
		<rich:panel id="mapMarkers">
		<script type="text/javascript">
		//<![CDATA[
		//Pulled out of markerclusterer.js
		  var sizes = [53, 56, 66, 78, 90];
		  var styles = [];

		  var i = 0;
		  for (i = 1; i <= 5; ++i) {
		    styles.push({
		      'url': "#{request.contextPath}/images/markerClusterer/m" + i + ".png",
		      'height': sizes[i - 1],
		      'width': sizes[i - 1]
		    });
		  }
		//]]>
			var marker;
			var driverLoc;
			var bounds;
			
			function addMarkerListener(marker, itemID)
			{
				google.maps.event.addListener(marker, "click", function() {
						var latlng = marker.getPosition();
<!-- TODO: not sure about this currentMarker global type var (filled in by mapbubble.js getAddressforCurrentMarker) -->						
	 					currentMarker = marker;	
						lkFrZnBubble(latlng.lat(),latlng.lng(),0,0,itemID,0,0);
				});
				
			}

			function addMarkers()
			{
				if (markerClusterer != null) {
			          markerClusterer.clearMarkers();
			          inthincMap.clearMarkers();
		        }
				markers = [];
				bounds.extend(new google.maps.LatLng(#{liveFleetBean.addressLatLng.lat}, #{liveFleetBean.addressLatLng.lng}));
				
				<ui:repeat value="#{liveFleetBean.drivers}" var="driver">
					marker = inthincMap.createMarker({
						position: new google.maps.LatLng(#{driver.loc.lat}, #{driver.loc.lng}),
						iconImage : "#{liveFleetBean.mapIconMap.icons[driver.vehicle.groupID]}"
					});
					addMarkerListener(marker, #{driver.vehicle.vehicleID});	
					markers.push(marker);
					bounds.extend(marker.getPosition());
					
				</ui:repeat>

				inthincMap.centerAndZoom(bounds);
				markerClusterer = new MarkerClusterer(inthincMap.getMap(),markers,{styles:styles});
			}
			</script>
		</rich:panel>
		<rich:panel id="mapPopups" rendered="#{liveFleetBean.selectedVehicleID ne null}">
		
			<ui:param name="driverLocation" value="#{liveFleetBean.driverLocationsMap[liveFleetBean.selectedVehicleID]}"/>
			<ui:include src="../includes/vehicleBubble.xhtml">
	            <ui:param name="driver" value="#{driverLocation.driver}" />
	        	<ui:param name="vehicle" value="#{driverLocation.vehicle}" />
	        	<ui:param name="device" value="#{driverLocation.device}" />
	        	<ui:param name="bean" value="#{liveFleetBean}" />
	        	<ui:param name="targetDriverID" value="#{driverLocation.driver.driverID}" />
	        	<ui:param name="messagePriPhone" value="#{messages.livefleet_priPhone}" />
	        	<ui:param name="messageSecPhone" value="#{messages.livefleet_secPhone}" />
	        	<ui:param name="messageDriver" value="#{messages.livefleet_driver}" />
	        	<ui:param name="targetVehicleID" value="#{driverLocation.vehicle.vehicleID}" />
	        	<ui:param name="messageVehicleType" value="#{messages.livefleet_vehicleType}" />
	        	<ui:param name="messageLastUpdated" value="#{messages.livefleet_updated}" />
	        	<ui:param name="vehicleTime" value="#{driverLocation.time}" />
	        	<ui:param name="messageAddress" value="#{messages.livefleet_address}" />
	        	<ui:param name="vehicleAddress" value="#{driverLocation.addressStr}" />
     	        <ui:param name="addressLookupAddressFormat" value="#{liveFleetBean.addressFormat}"/>
	        	<ui:param name="distance" value="#{driverLocation.dist}" />
	        	<ui:param name="messageDistance" value="#{messages.livefleet_distance}" /> 
	        	<ui:param name="messageDevicePhone" value="#{messages.livefleet_devicePhone}" /> 
	        	<ui:param name="messageAddressLatLng" value="#{messages.livefleet_latlng}" />
	        	<ui:param name="lat" value="#{driverLocation.loc.lat}"/>
	        	<ui:param name="lng" value="#{driverLocation.loc.lng}"/>
 		 		<ui:param name="context" value="liveFleet" />
			</ui:include>
	</rich:panel>
	</h:form>
	<!-- END GOOGLE MAP POPUPS -->
	
		<table width="940" border="0" cellspacing="0" cellpadding="0"
			align="center">
			<tr>
				<td width="330" valign="top">
				<!-- START PANEL -->
				<div class="">
					<div class="panel_nw">
						<div class="panel_title"><span class="vehicle">#{messages.livefleet_dispatch}</span>
							<span class="panel_links"></span></div>
						</div>
						<div class="panel_w">
							<div class="panel_content">
							<rich:panel	id="driversDataTablePanel">
								<a4j:form id="dispatchForm">
								
								<h:inputHidden id="foundZoneName" value="#{addressBean.zoneName}"/>
								
								<rich:dataTable value="#{liveFleetBean.drivers}" 
									id="driversDataTable" var="item" styleClass="datagrid" sortMode="single"
									rowClasses="tableOdd,tableEven" cellspacing="1" rows="10" width="100%">
								
								<rich:column id="position" sortBy="#{item.position}" width="10%">
									<f:facet name="header">
										<h:outputText value="#" />
									</f:facet>
									<h:outputText value="#{item.position}"/>
								</rich:column>
								
								<rich:column id="driver" sortBy="#{item.driver.person.fullName}" width="40%">
									<f:facet name="header">
										<h:panelGroup>
											<h:outputText value="#{messages.livefleet_driver_part1}" />
											<h:panelGroup rendered="#{messages.livefleet_driver_part2 ne ''}">
												<f:verbatim><br/></f:verbatim>
												<h:outputText value="#{messages.livefleet_driver_part2}" />
											</h:panelGroup>
										</h:panelGroup>
									</f:facet>
                                    <ui:include src="/includes/driverLink.xhtml">
				   						<ui:param name="context" value="liveFleet" />
				   						<ui:param name="driverID" value="#{item.driver.driverID}" />
				   						<ui:param name="unknownDriverID" value="#{liveFleetBean.unknownDriverID}" />
				   						<ui:param name="driverName" value="#{item.driver.person.fullName}" />
									</ui:include>
                                    
								</rich:column>
	
								<rich:column id="vehicle" sortBy="#{item.vehicle.name}" width="40%">
									<f:facet name="header">
										<h:panelGroup>
											<h:outputText value="#{messages.livefleet_vehicle_part1}" />
											<h:panelGroup rendered="#{messages.livefleet_vehicle_part2 ne ''}">
												<f:verbatim><br/></f:verbatim>									
												<h:outputText value="#{messages.livefleet_vehicle_part2}" />
											</h:panelGroup>
										</h:panelGroup>												
									</f:facet>
                           
                                    <pretty:link id="liveFleetsVehiclePerformance" mappingId="vehiclePerformance">
                                       <h:outputText value="#{item.vehicle.name}"/>
                                       <f:param value="#{item.vehicle.vehicleID}"/>
                                    </pretty:link>
								</rich:column>
	
								<rich:column id="group" sortBy="#{item.vehicle.groupID}" width="10%">
									<f:facet name="header">
									
									</f:facet>
									<a href="#" id="showGroup" onclick="lkFrZnBubble(#{item.loc.lat},#{item.loc.lng},0,#{item.vehicle.vehicleID},null,null,4);">
										<img src="#{liveFleetBean.legendIconMap.icons[item.vehicle.groupID]}" style="cursor: pointer;" border="0" />
									</a>
								</rich:column>
	
								</rich:dataTable>
									<div class="spacer"></div>
								<rich:datascroller align="center" for="driversDataTable" id="driverScroller" reRender="driversDataTable" renderIfSinglePage="false" />
							
							</a4j:form>
						</rich:panel> 
						
	
						<!-- End Trip table -->
							</div>
							</div>
						<div class="panel_sw">
						<div class="panel_statusbar"></div>
					</div>
				</div>
				</td>
				
	<!-- END DISPATCH PANEL -->
	
	<!-- START INPUT FORM -->
				<td width="10">
					<h:graphicImage value="/images/x.gif" width="10" />
				</td>
				<td width="600" valign="top">
					
					<div class="" style="width: 600px; margin: 0 auto 0 auto;">

				<div class="panel_nw">
					<div class="panel_title">
						<span class="map">#{messages.livefleet}</span>
						<span class="panel_ico">
							<a4j:status id="JSFormStatus" for="jsFormRegion" >
								<f:facet name="start">
									<h:outputText><img src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif" align="top" />&#160;</h:outputText>
								</f:facet>
							</a4j:status>
							<h:graphicImage value="/images/ico_refresh.png" style="cursor: pointer;" onclick="refresh();" title="#{messages.refresh}" alt="#{messages.refresh}"/>
						</span>
					</div>
				</div>
				<div class="panel_w">
				
			<div class="panel_content" align="center">

				<rich:panel id="inputFormPanel">
				<table width="580" border="0" cellpadding="4" cellspacing="0">
					<tr>
						<td width="90">#{messages.livefleet_find_address}:</td>
						<td width="301">
							<h:inputText id="liveFleetAddressTextBox" size="40" value="" onkeypress="checkEnter(event);" />
						</td>
						<td width="165" rowspan="2">
							<button id="liveFleetSearch" name="locationButton" value="" class="left" onclick="processForm('liveFleetAddressTextBox', 'countComboBox');">
								<span class="search">#{messages.livefleet_locate}</span>
							</button>
						</td>
					</tr>
					<tr>
						<td></td>
						<td><h:outputText value="#{messages.livefleet_display}     " />  
						<select
							id="countComboBox">
							<option value="5">5</option>
							<option value="10" selected="true">10</option>
							<option value="25">25</option>
							<option value="50">50</option>
							<option value="100">100</option>
						</select> <h:outputText value="     #{messages.livefleet_nearest_vehicles}." /></td>
					</tr>
				</table>
				</rich:panel>
				<hr />
	            <!-- END INPUT FORM -->
				<h:form id="liveFleetMapForm" name="mapLinks2">
				<h:panelGroup styleClass="map-border" layout="block">
					 <div id="map-canvas" style="width: 580px; height: 425px; border: 0"></div> 
				</h:panelGroup>
				<div id="defaultMessage" style="display: none">
					<br/>
						<h2>#{messages.livefleet}</h2>
				    			#{messages.livefleet_default_view}.
				    			<security:authorize ifAnyGranted="ROLE_ADMIN,ROLE_ORGANIZATIONACCESS">
				    				[<h:commandLink id="liveFleetGo" action="go_adminOrganization" value="#{messages.livefleet_change}" />]
				    			</security:authorize>
			    	
			    </div>
				</h:form>
				
				<a4j:region id="jsFormRegion">
					<a4j:form id="jsForm">
						<a4j:jsFunction reRender="driversDataTable,mapMarkers,mapPopups,driverScroller,liveFleetLegend" name="notifyBean" oncomplete="bodyLoad()">				
							<a4j:actionparam name="param1" assignTo="#{liveFleetBean.addressLatLng.lat}" />
							<a4j:actionparam name="param2" assignTo="#{liveFleetBean.addressLatLng.lng}" />
							<a4j:actionparam name="param3" assignTo="#{liveFleetBean.maxCount}" />	
						</a4j:jsFunction>
						<a4j:jsFunction name="fillBubbleMarker" reRender="mapPopups" oncomplete="getAddressForCurrentMarker()">
							<a4j:actionparam name="vehicleId" assignTo="#{liveFleetBean.selectedVehicleID}"/>
							<a4j:actionparam name="subId" />
						</a4j:jsFunction>
						<a4j:jsFunction name="fillBubbleMap" reRender="mapPopups"
								 oncomplete="getAddressForPosition(#{liveFleetBean.driverLocationsMap[liveFleetBean.selectedVehicleID].loc.lat},#{liveFleetBean.driverLocationsMap[liveFleetBean.selectedVehicleID].loc.lng})">
							<a4j:actionparam name="vehicleId" assignTo="#{liveFleetBean.selectedVehicleID}"/>
						</a4j:jsFunction>
						<a4j:jsFunction name="lkFrZnBubble" data="#{addressBean.zoneData}" action="#{addressBean.lookForZone}" oncomplete="funcToCall(data);">
							<a4j:actionparam name="latitude" assignTo="#{addressBean.zoneLat}"/>
							<a4j:actionparam name="longitude" assignTo="#{addressBean.zoneLng}"/>
							<a4j:actionparam name="elemIndex" assignTo="#{addressBean.elemIndex}"/>	
							<a4j:actionparam name="noteID" assignTo="#{addressBean.noteID}"/>	
							<a4j:actionparam name="itemID" assignTo="#{addressBean.itemID}"/>
							<a4j:actionparam name="subID" assignTo="#{addressBean.subID}"/>
							<a4j:actionparam name="callFuncID" assignTo="#{addressBean.callFuncID}"/>
						</a4j:jsFunction> 	 					
					</a4j:form>
				</a4j:region>
				</div>
				</div>
				<div class="panel_sw">
				<div class="panel_statusbar"></div>
				</div>
				</div>
		<div class="spacer"></div>		
				<div class="">
					<div class="panel_nw">
						<div class="panel_title">
							<span class="legend">#{messages.livefleetmap_legend}</span>
							<span class="panel_links"></span>
						</div>
					</div>	
	 				<div class="panel_w">
						<div class="panel_content">
						   <rich:dataGrid id="liveFleetLegend" value="#{liveFleetBean.displayedGroups}" var="group" styleClass="carlegend" 
      		  											columns="3" border="0" cellpadding="5" cellspacing="5">
      		  			
                               <pretty:link id="liveFleetsDashboard1" mappingId="dashboard">
                                  <img border="0" src="#{liveFleetBean.legendIconMap.icons[group.groupID]}" style="vertical-align:middle"/>
                                  <f:param value="#{group.groupID}"/>
                               </pretty:link>
                               <h:outputText value=" "/>
                               <pretty:link id="liveFleetsDashboard2" mappingId="dashboard">
                                  <h:outputText value="#{group.name}"/>
                                  <f:param value="#{group.groupID}"/>
                               </pretty:link>
     			  	
      					</rich:dataGrid>
						
						</div>
					</div>
					<div class="panel_sw">
					<div class="panel_statusbar"></div>
					</div>
					</div>

				<!-- END PANEL -->
				</td>
			</tr>
		</table>
			
	</ui:define>
</ui:composition>

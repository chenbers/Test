<ui:composition template="/layout/layout.xhtml" 
				xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
	  			xmlns:h="http://java.sun.com/jsf/html" 
	  			xmlns:f="http://java.sun.com/jsf/core"
	  			xmlns:rich="http://richfaces.org/rich"
	  			xmlns:a4j="http://richfaces.org/a4j"
	  			xmlns:t="http://myfaces.apache.org/tomahawk"
	  			xmlns:security="http://pro.tiwi.com/jsf/security">

	<ui:param name="liveFleetSelected" value="current" />
	<ui:param name="helpFile" value="Live_Fleet.htm" />
	
	<ui:define name="scripts">
		<script src="http://maps.google.com/maps?file=api&amp;v=2.x&amp;key=#{gmBean.key}" type="text/javascript"></script>
		<script type="text/javascript">
		
		/* CreateMarker(GLatLng, divID, GIcon or null)
		 *	
		 * Creates a marker using specified GIcon or default icon if null is passed for iconImage.
		 * divID is the id of a DIV you want displayed in the info window. 
		 */
        function createMarker(point, divID, iconImage) 
        {
        	var markerIcon;
        	var marker;

			//Use passed in image.
        	if(iconImage != null)
        	{
				markerIcon = new GIcon(baseIcon);
	       	    markerIcon.image = iconImage;
	       	 	markerOptions = { icon:markerIcon };
	       	 	marker = new GMarker(point, markerOptions);
        	}
        	//Use default GoogleMap marker image.
        	else
        	{
		      	markerIcon = new GIcon();
				marker = new GMarker(point);
        	}
       
       		GEvent.addListener(marker, "click", function() {
					var node = document.getElementById(divID).cloneNode(true);
          			node.style.display = 'block';
		            marker.openInfoWindow(node);
		 			});

        	return marker;
        }

		function showDriver(lat, lng, divId)
		{
			var point = new GLatLng(lat, lng);
			var node = document.getElementById(divId).cloneNode(true);
  				node.style.display = 'block';
			

			var markerIcon = new GIcon(baseIcon);
	       		markerIcon.image = "";  //TODO: lookup existing marker and show it.

		    var markerOptions = { icon:markerIcon };
			var marker = new GMarker(point, markerOptions);

			GEvent.addListener(marker, "click", function() {
		    	     	marker.openInfoWindowHtml(node);  });
			 
			map.addOverlay(marker);
			
			//Immediately display info window.
			marker.openInfoWindow(node);
		}
	    
   		function processForm(addressId, countId)
   		{
			//Get form elements
   			var address = document.getElementById(addressId).value;
   			var count = document.getElementById(countId).value;

   			// Clear all existing markers and zoom boundary.
			map.clearOverlays();
			bounds = new GLatLngBounds();
   			
			//Text field is blank, process form for only number of vehicles dropdown.
	   		if(address.length == 0)  
   			{
	   			notifyBean(mapDefaultLoc.lat(), mapDefaultLoc.lng(), count);
   				return;
   	   		}

	   	    if (geocoder) {
	   	        geocoder.getLatLng(
	   	          address,
	   	          function(point) {
	   	            if (!point) {
	   	              alert(address + " not found");
	   	         } else {
	  	     
	   				 //Create Marker
					 var marker = new GMarker(point);
					 GEvent.addListener(marker, "click", function() {
				         	marker.openInfoWindowHtml("<b>" + address + "</b>");  });
					 
					 map.addOverlay(marker);
					 bounds.extend(marker.getPoint());
					
					 //Immediately display info window.
					 marker.openInfoWindow("<b>" + address + "</b>");
					         	  
					 //Pass Geocode lookup LatLng and max count to Bean.
					 var loc = marker.getLatLng();
					 notifyBean(loc.lat(), loc.lng(), count);
					 
	    	         }
	   	          }
	   	        );
	   	      }
   	    }

		//Process form if user pressed enter in form fields.
   		function checkEnter(e)
   		{ 
   			var characterCode;

   			if(e.which){ 
   			e = e;
   			characterCode = e.which; //NN4's which property
   			}
   			else{
   			e = event;
   			characterCode = e.keyCode;//IE's keyCode property
   			}

   			//if generated character code is equal to ascii 13 (if enter key)
   			if(characterCode == 13) { 
					alert('enter pressed');
					processForm('addressTextBox', 'countComboBox');
   					return false; }
   			else
   	   			{	return true;  }
   			}

		function bodyUnload()
		{
			GUnload();
		}
	</script>	

	</ui:define>
	<ui:define name="content">
	
	<t:saveState value="#{liveFleetBean}" />

	
	<!-- BEGIN GOOGLE MAP POPUPS -->
	<rich:panel id="mapPopups">
		<ui:repeat value="#{liveFleetBean.drivers}" var="driver">
			<div id="#{driver.driverID}" style="display: none">
				<h:form id="mapLinks_#{driver.driverID}">
					<strong>
						<h:commandLink value="#{driver.name}" action="#{liveFleetBean.driverAction}">
							<f:param name="id" value="#{driver.driverID}" />
						</h:commandLink>
					</strong>
				</h:form>
					<b>Work:</b> <h:outputText value="#{driver.workPhone}" converter="PhoneNumberConverter" /> <br />
					<b>Home:</b> <h:outputText value="#{driver.homePhone}" converter="PhoneNumberConverter" /> <br />
					<b>Vehicle Type:</b> #{driver.vehicleType}
				</div>
		</ui:repeat>
	</rich:panel>
	<!-- END GOOGLE MAP POPUPS -->
	
		<table width="940" border="0" cellspacing="0" cellpadding="0"
			align="center">
			<tr>
				<td width="330" valign="top">
				<!-- START PANEL -->
				<div class="">
					<div class="panel_nw">
						<div class="panel_title"><span class="vehicle">Dispatch</span>
							<span class="panel_links"></span></div>
						</div>
						<div class="panel_w">
							<div class="panel_content">
							<rich:panel	id="driversDataTablePanel">
								<a4j:form>
								
								<rich:dataTable value="#{liveFleetBean.drivers}"
									id="driversDataTable" var="item" styleClass="datagrid"
									rowClasses="tableOdd,tableEven" cellspacing="1" rows="10" width="100%">
								
								<rich:column>
									<img src="#{liveFleetBean.mapIconMap.icons[item.groupID]}"
										width="20" height="20" />
								</rich:column>
	
								<rich:column sortBy="#{item.name}">
									<f:facet name="header">
										<h:outputText value="Driver" />
									</f:facet>
									<h:commandLink value="#{item.name}" action="#{liveFleetBean.driverAction}">
										<f:param name="id" value="#{item.driverID}" />
									</h:commandLink>
								</rich:column>
	
								<rich:column sortBy="#{item.workPhone}">
									<f:facet name="header">
										<h:outputText value="Phone" />
									</f:facet>
									<h:outputText value="#{item.workPhone}" converter="PhoneNumberConverter" />
								</rich:column>
	
								<rich:column>
									<a href="#" onClick="showDriver(#{item.loc.lat}, #{item.loc.lng}, #{item.driverID});">show</a>
								</rich:column>
	
								</rich:dataTable>
									<div class="spacer"></div>
								<rich:datascroller align="center" for="driversDataTable" id="driverScroller" reRender="driversDataTable" />
									
						
							
								<rich:panel id="stats">
									Found #{liveFleetBean.numRecords} drivers.
								</rich:panel>
						
							</a4j:form>
						</rich:panel> 
						
	
						<!-- End Trip table -->
							</div>
							</div>
						<div class="panel_sw">
						<div class="panel_statusbar"></div>
					</div>
				</div>
	
				</td>
				
	<!-- END DISPATCH PANEL -->
	
	<!-- START INPUT FORM -->
				<td width="10">
					<h:graphicImage value="/images/x.gif" width="10" />
				</td>
				<td width="600" valign="top">
					
					<div class="" style="width: 600px; margin: 0 auto 0 auto;">

				<div class="panel_nw">
					<div class="panel_title"><span class="map">Live Fleet</span></div>
				</div>
				<div class="panel_w">
					<div class="panel_content" align="center">

				<table width="580" border="0" cellpadding="4" cellspacing="0">
					<tr>
						<td width="90">Find Address:</td>
						<td width="301">
							<input type="text" size="40" id="addressTextBox" value="" onKeyPress="checkEnter(event);" />
						</td>
						<td width="165" rowspan="2">
							<button name="locationButton" value="" class="left" onclick="processForm('addressTextBox', 'countComboBox');">
								<span class="search">Locate</span>
							</button>
						</td>
					</tr>
					<tr>
						<td></td>
						<td>Display<rich:spacer width="5" />
						<select
							id="countComboBox">
							<option value="5">5</option>
							<option value="10" selected="true">10</option>
							<option value="25">25</option>
							<option value="50">50</option>
							<option value="100">100</option>
						</select> <rich:spacer width="5" /> nearest vehicles.</td>
					</tr>
				</table>
				<hr />
	<!-- END INPUT FORM -->
	
				<h:panelGroup styleClass="map-border" layout="block">
					<div id="map-canvas" style="width: 580px; height: 425px; border: 0"></div>
				</h:panelGroup>
				<div id="defaultMessage" style="display: none">
					<h:form>
						<h2>Live Fleet</h2>
				    			This is the default view for your division.
				    			<security:authorize ifAnyGranted="ROLE_CUSTOMUSER,ROLE_SUPERUSER">
				    				[<h:commandLink action="go_adminOrganization" value="change" />]
				    			</security:authorize>
			    	</h:form>
			    </div>
				<script type="text/javascript">
				var map = null;
			    var geocoder = null;
			    var addressLatLng = null;
			    var mapDefaultLoc = new GLatLng(#{liveFleetBean.addressLatLng.lat}, #{liveFleetBean.addressLatLng.lng});
			    var markerClicked = false;

			    var baseIcon = new GIcon();
					baseIcon.iconSize = new GSize(21, 20);
					baseIcon.iconAnchor = new GPoint(6, 20);
					baseIcon.infoWindowAnchor = new GPoint(5, 1);

				var bounds = new GLatLngBounds();

		        if (GBrowserIsCompatible())
			        {
		   
		        	map = new GMap2(document.getElementById("map-canvas"));
		        	geocoder = new GClientGeocoder();
					map.addControl(new GLargeMapControl());
					map.addControl(new GMapTypeControl());
					map.addControl(new GOverviewMapControl()); 
					map.setMapType(G_NORMAL_MAP);
					map.setCenter(mapDefaultLoc);
		
		    	    var marker = createMarker(mapDefaultLoc, "defaultMessage", null);
					map.addOverlay(marker);
					bounds.extend(marker.getPoint());

					var node = document.getElementById("defaultMessage").cloneNode(true);
          			node.style.display = 'block';
		            marker.openInfoWindow(node);
				
		        }
			    </script>
			    <rich:panel id="vehicleScript">
					<script type="text/javascript">
	 							var marker;
			  					var driverLoc;
								
			  					<ui:repeat value="#{liveFleetBean.drivers}" var="driver">
			  						driverLoc = new GLatLng(#{driver.loc.lat}, #{driver.loc.lng});
	
			  					    var node = document.getElementById(#{driver.driverID}).cloneNode(true);
				  		  			node.style.display = 'block';
	
									marker = createMarker(driverLoc, #{driver.driverID}, "#{liveFleetBean.mapIconMap.icons[driver.groupID]}");
									map.addOverlay(marker);
									bounds.extend(marker.getPoint());
	
								</ui:repeat>
	
								map.setZoom(map.getBoundsZoomLevel(bounds));
							    map.setCenter(bounds.getCenter());
						</script>
				</rich:panel> 
				<a4j:form>
				
					<a4j:jsFunction reRender="vehicleScript,driversDataTable,mapPopups,driverScroller,stats"
									name="notifyBean">				
						<a4j:actionparam name="param1" assignTo="#{liveFleetBean.addressLatLng.lat}" />
						<a4j:actionparam name="param2" assignTo="#{liveFleetBean.addressLatLng.lng}" />
						<a4j:actionparam name="param3" assignTo="#{liveFleetBean.maxCount}" />	
						
					</a4j:jsFunction>
				</a4j:form>
				</div>
				</div>
				<div class="panel_sw">
				<div class="panel_statusbar"></div>
				</div>
				</div>

				<!-- END PANEL -->
				</td>
			</tr>
		</table>

	</ui:define>
</ui:composition>

<ui:composition template="/layout/layout.xhtml" 
				xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
	  			xmlns:h="http://java.sun.com/jsf/html" 
	  			xmlns:f="http://java.sun.com/jsf/core"
	  			xmlns:rich="http://richfaces.org/rich"
	  			xmlns:a4j="http://richfaces.org/a4j">

	<ui:param name="liveFleetSelected" value="current" />
	
	<ui:define name="scripts">
		<script src="http://maps.google.com/maps?file=api&amp;v=2.x&amp;key=#{gmBean.key}" type="text/javascript"></script>
		<script type="text/javascript">
		
	    function createMarker(point, message, iconImage)
        {
	          var markerIcon = new GIcon(baseIcon);
	       	  markerIcon.image = iconImage;
		         
	          markerOptions = { icon:markerIcon };
	          var marker = new GMarker(point, markerOptions);
	
	          GEvent.addListener(marker, "click", function() {
	          marker.openInfoWindowHtml("<b>" + message + "</b>");
	          });
	          return marker;
        }

		function showDriver(lat, lng, name, phone)
		{
			var point = new GLatLng(lat, lng);
			var message = "<b>" + name + "<br />" + phone + "</b>";

			var markerIcon = new GIcon(baseIcon);
	       	  markerIcon.image = "#{facesContext.externalContext.request.contextPath}/images/ico_start.png";
		         
	          markerOptions = { icon:markerIcon };
			
			var marker = new GMarker(point, markerOptions);
			 GEvent.addListener(marker, "click", function() {
		         	marker.openInfoWindowHtml(message);  });
			 
			 map.addOverlay(marker);
			
			 //Immediately display info window.
			 marker.openInfoWindow(message);
		}
	    
   		function processForm(addressId, countId)
   		{
   			var address = document.getElementById(addressId).value
   			var count = document.getElementById(countId).value

	   	      if (geocoder) {
	   	        geocoder.getLatLng(
	   	          address,
	   	          function(point) {
	   	            if (!point) {
	   	              alert(address + " not found");
	   	         } else {
	  	              
					 // Clear all existing markers.
					 map.clearOverlays();

	   				 //Create Marker
					 var marker = new GMarker(point);
					 GEvent.addListener(marker, "click", function() {
				         	marker.openInfoWindowHtml("<b>" + address + "</b>");  });
					 
					 map.addOverlay(marker);
					 bounds.extend(marker.getPoint());
					
					 //Immediately display info window.
					 marker.openInfoWindow("<b>" + address + "</b>");
					         	  
					 //Pass Geocode lookup LatLng and max count to Bean.
					 var loc = marker.getLatLng();
					 notifyBean(loc.lat(), loc.lng(), count);
					 
	    	         }
	   	          }
	   	        );
	   	      }
   	    }
	    
	</script>	
	</ui:define>
	
	<ui:define name="content">
<table width="940" border="0" cellspacing="0" cellpadding="0" align="center">
  <tr>
    <td width="330" valign="top">
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="vehicle">Dispatch</span>

						<span class="panel_links"></span>
					</div>
				</div>
					<div class="panel_w">
					  <div class="panel_content">
						<a4j:form>
			
						<rich:dataTable 
						value="#{liveFleetBean.drivers}" 
						id="driversDataTable"
						var="item" styleClass="datagrid"
						rowClasses="tableOdd,tableEven" cellspacing="1" rows="14"  
						width="100%">
							<!-- Data -->
							<rich:column>
								<img src="../images/ico_start.png" width="20" height="20" />
							</rich:column>

							<rich:column sortBy="#{item.name}">
								<f:facet name="header">
									<h:outputText value="Driver" />
								</f:facet>
								<h:outputText value="#{item.name}" />
							</rich:column>
							
							<rich:column sortBy="#{item.workPhone}">
								<f:facet name="header">
									<h:outputText value="Phone" />
								</f:facet>
								<h:outputText value="#{item.workPhone}" />
							</rich:column>
							
							<rich:column>
								<a href="#" onclick="showDriver(#{item.loc.lat}, #{item.loc.lng}, '#{item.name}', '#{item.workPhone}');">show</a>
							</rich:column>

						</rich:dataTable>
						<div class="spacer"></div>
						<rich:datascroller align="center" for="driversDataTable" id="scroller"
							reRender="driversDataTable" page="#{liveFleetBean.driverPager}" />
					
						</a4j:form>
						<!-- End Trip table -->
					  </div>
					</div>
				<div class="panel_sw">

					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
	</td>
    <td width="10"><img src="images/x.gif" width="10" /></td>
    <td width="600" valign="top">
		<!-- START PANEL -->
		<div class="" style="width:600px; margin: 0 auto 0 auto;">

			<div class="panel_nw">
				<div class="panel_title">
					<span class="map">Live Fleet</span>
				</div>
			</div>
			<div class="panel_w">
			  <div class="panel_content" align="center">

			  	<table width="580" border="0" cellpadding="4" cellspacing="0">
				  <tr>
					<td width="90">Find Address: </td>
					<td width="301">
						<input type="text" size="40" id="addressTextBox" value="1600 Amphitheatre Pky, Mountain View, CA" />
					</td>
					<td width="165" rowspan="2">
						<button value="" class="left" onclick="processForm('addressTextBox', 'countComboBox');"><span class="search">Locate</span></button>
					</td>
				  </tr>
				  <tr>
			  		<td></td>
			  		<td>	
				  		Display<rich:spacer width="5" />
				  		<select id="countComboBox">
						  <option value="5">5</option>
						  <option value="10" selected="true">10</option>
						  <option value="20">100</option>
						</select>
						<rich:spacer width="5" />
						nearest vehicles.
					</td>
				  </tr>
				</table>
				<hr />
				<h:panelGroup styleClass="map-border" layout="block">
					<div id="map-canvas" style="width:580px;height:425px;border:0"></div>
		  		</h:panelGroup>
			    <script type="text/javascript">
				var map = null;
			    var geocoder = null;
			    var addressLatLng = null;

			    var baseIcon = new GIcon();
					baseIcon.iconSize = new GSize(21, 20);
					baseIcon.iconAnchor = new GPoint(6, 20);
					baseIcon.infoWindowAnchor = new GPoint(5, 1);

				var bounds = new GLatLngBounds();

		        if (GBrowserIsCompatible()) {
		        	map = new GMap2(document.getElementById("map-canvas"));
					map.addControl(new GLargeMapControl());
					map.addControl(new GMapTypeControl());
					map.addControl(new GOverviewMapControl()); 
					map.setCenter(new GLatLng(#{liveFleetBean.addressLatLng.lat}, #{liveFleetBean.addressLatLng.lng}), #{liveFleetBean.addressZoom});
					map.setMapType(G_NORMAL_MAP);
		    	    geocoder = new GClientGeocoder();
		        }
			    </script>
	    			<rich:panel id="vehicleScript">
			    		<script type="text/javascript">
 							var marker;
		  					var driverLoc;

		  					

		  					<ui:repeat value="#{liveFleetBean.drivers}" var="driver">
		  						driverLoc = new GLatLng(#{driver.loc.lat}, #{driver.loc.lng});
								marker = createMarker(driverLoc,"#{driver.name} <br />#{driver.workPhone}",
																"#{facesContext.externalContext.request.contextPath}/images/ico_start.png");
								map.addOverlay(marker);
								bounds.extend(marker.getPoint());

								//polyline = new GPolyline([addressPoint, new GLatLng(#{driver.loc.lat}, #{driver.loc.lng})]
								//							, "#0000ee", 3);
								//map.addOverlay(polyline);
								
							</ui:repeat>

							map.setZoom(map.getBoundsZoomLevel(bounds));
						    map.setCenter(bounds.getCenter());
					</script>
					</rich:panel>
					
					<a4j:form>
			        	<a4j:jsFunction name="notifyBean" reRender="vehicleScript,driversDataTable">
			            	<a4j:actionparam name="param1" assignTo="#{liveFleetBean.addressLatLng.lat}"  />
			            	<a4j:actionparam name="param2" assignTo="#{liveFleetBean.addressLatLng.lng}"  />
			            	<a4j:actionparam name="param3" assignTo="#{liveFleetBean.maxCount}"  />                    
			       		</a4j:jsFunction>
			    	</a4j:form>
			  
			  </div>
			</div>
			<div class="panel_sw">
				<div class="panel_statusbar"></div>
			</div>
		</div>

		<!-- END PANEL -->
	</td>
  </tr>
</table>

</ui:define>
</ui:composition>

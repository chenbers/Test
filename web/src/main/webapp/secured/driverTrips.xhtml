<ui:composition template="/layout/layout.xhtml" 
				xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:ui="http://java.sun.com/jsf/facelets" 
				xmlns:h="http://java.sun.com/jsf/html"
			    xmlns:rich="http://richfaces.org/rich" 
			    xmlns:a4j="http://richfaces.org/a4j" 
			    xmlns:f="http://java.sun.com/jsf/core"
			    xmlns:t="http://myfaces.apache.org/tomahawk"
                xmlns:pretty="http://ocpsoft.com/prettyfaces"
                xmlns:c="http://java.sun.com/jstl/core">

    <ui:define name="scripts">
        
        <script src="#{facesContext.externalContext.request.contextPath}/js/FusionCharts.js" type="text/javascript"></script>
        <script src="http://maps.google.com/maps?file=api&amp;v=#{gmBean.version}&amp;key=#{gmBean.key}&amp;hl=#{localeBean.locale.language}" type="text/javascript"></script>
        <script type="text/javascript">
		var map;
		var showWarnings = true;
		var showIdleMarkers = true;
		var showTamperMarkers = true;
		var baseIcon = new GIcon();
			baseIcon.iconSize = new GSize(21, 20);
			baseIcon.iconAnchor = new GPoint(6, 20);
			baseIcon.infoWindowAnchor = new GPoint(5, 1);
		var bounds = new GLatLngBounds();
		
		function initMap(lat,lng,zoom)
		{
   			if (GBrowserIsCompatible()) 
			{
		 	  	map = new GMap2(document.getElementById("map-canvas"));
				map.addControl(new GLargeMapControl());
				map.addControl(new GMapTypeControl());
				map.addControl(new GOverviewMapControl()); 
				map.setCenter(new GLatLng(lat, lng), zoom);
				map.setMapType(G_NORMAL_MAP);
				bounds = new GLatLngBounds();
			}
		}	

	    function orderOfCreation(marker,b) 
	    {
	          return 1;
	    }	
		
		function createMarker(point, divID, iconImage) 
        {
        	var markerIcon;
        	var marker;

			//Use passed in image.
        	if(iconImage != null)
        	{
				markerIcon = new GIcon(baseIcon);
	       	    markerIcon.image = iconImage;
	       	 	markerOptions = { icon:markerIcon,zIndexProcess:orderOfCreation };
	       	 	marker = new GMarker(point, markerOptions);
        	}
        	//Use default GoogleMap marker image.
        	else
        	{
		      	markerIcon = new GIcon();
				marker = new GMarker(point);
        	}
       
       		GEvent.addListener(marker, "click", function() {
					var node = document.getElementById(divID).cloneNode(true);
          			node.style.display = 'block';
		            marker.openInfoWindow(node);
		 			});

        	return marker;
        }

        function showInfoWindow(noteID, latLng)
        {
        	var node = document.getElementById(noteID).cloneNode(true);
  			node.style.display = 'block';

  			map.openInfoWindow(latLng, node);
        }

	    // Show Warnings Checkbox changed   //TODO: CLEANER WAY TO DO THIS??
	    function showWarningsChanged()
	    {
	    	if(document.getElementById('showWarningsCheckBox').checked == true)
	    	{
				showWarnings = true;
				drawSelectedTrips();
	    	}
	    	else
	    	{
				showWarnings = false;
				drawSelectedTrips();
	    	}
		}

		// Show Idle Markers Checkbox changed
	    function showIdleChanged()
	    {
	      	if(document.getElementById('showIdleCheckBox').checked == true)
	    	{
	      		showIdleMarkers = true;
	      		drawSelectedTrips();
	    	}
	    	else
	    	{
	    		showIdleMarkers = false;
	    		drawSelectedTrips();
	    	}
		}

	 	// Show Tampering Markers Checkbox changed
	    function showTamperingChanged(tamperingCheckBox)
	    {
	      	if(tamperingCheckBox.checked == true)
	    	{
	      		showTamperMarkers = true;
	      		drawSelectedTrips();
	    	}
	    	else
	    	{
	    		showTamperMarkers = false;
	    		drawSelectedTrips();
	    	}
		}

		//On page load and A4J Re-render
		function showTrips()
		{
			drawSelectedTrips();

			if ( map != null ) {
		    	map.setZoom(map.getBoundsZoomLevel(bounds));
		    	map.setCenter(bounds.getCenter());
			}
	    }

   		var isReady;
		isReady = false;
		function dynamicTableStyles()
		{
			
			jQuery('#tripsTableForm\\:tripsTable tr').click(function(){
                			jQuery('#tripsTableForm\\:tripsTable tr').each(function() {
								jQuery(this).removeClass('selected-row');
								jQuery(this).children().removeClass('selected-row');
								
							});
							jQuery(this).addClass('selected-row');
							jQuery(this).children().addClass('selected-row');
			});
			
		}
		function onReRender()
		{
			isReady = true;
			dynamicTableStyles();
            jQuery('#tripsTableForm\\:tripsTable tr:eq(1)').click();
		}
		function onReRenderWithSelection()
		{	
			isReady = true;
			dynamicTableStyles();
		}

		</script>

   <rich:panel id="script">
        <script type="text/javascript">
		
	    // Unload Google Map objects
		function bodyUnload()
		{
			GUnload();
		}	

	    // This is called on pageLoad 
		function bodyLoad()
		{
			if ( #{driverTripsBean.selectedTrips[0] ne null} ) {
				initMap(#{driverTripsBean.selectedTrips[0].routeLastStep.lat}0, #{driverTripsBean.selectedTrips[0].routeLastStep.lng}0, 14);
			}
	   		showTrips();
		}

		//alert('script got rendered');
   		function drawSelectedTrips()
   		{
				var polyline;
				var marker;
				var startlatlng;
				var endlatlng;

				if ( map == null ) {
					return;
				}
				
				map.clearOverlays();
				
   				<ui:repeat value="#{driverTripsBean.selectedTrips}" var="trip">
   				//alert('drawing selected trip #{trip.trip.startTime}');
					polyline = new GPolyline([
					<ui:repeat value="#{trip.route}" var="rt">
							new GLatLng(#{rt.lat}, #{rt.lng}),
					</ui:repeat>
			  				new GLatLng(#{trip.routeLastStep.lat}, #{trip.routeLastStep.lng})
					], "#0000ff", 6);
					map.addOverlay(polyline);

					<ui:repeat value="#{trip.route}" var="rt2">
						bounds.extend(new GLatLng(#{rt2.lat}, #{rt2.lng}));
					</ui:repeat>
					
					//Start of trip marker
					startlatlng = new GLatLng(#{trip.beginningPoint.lat}, #{trip.beginningPoint.lng});
					marker = createMarker(startlatlng, "#{trip.trip.startTime}_START", "#{facesContext.externalContext.request.contextPath}/images/ico_start.png");
					map.addOverlay(marker);
					bounds.extend(marker.getPoint());

					//End of trip marker
					endlatlng = new GLatLng(#{trip.routeLastStep.lat}, #{trip.routeLastStep.lng});
					if ("#{trip.inProgress}" == "true")
					{
						marker = createMarker(endlatlng, "#{trip.trip.endTime}_INPROGRESS", "#{facesContext.externalContext.request.contextPath}/images/ico_inprogress_trip.png");
					}
					else
					{
						marker = createMarker(endlatlng, "#{trip.trip.endTime}_END", "#{facesContext.externalContext.request.contextPath}/images/ico_end_trip.png");
					}
					map.addOverlay(marker);
					bounds.extend(marker.getPoint());
  				</ui:repeat>

  				if(showWarnings == true)
				{
	  				var violation;
					<ui:repeat value="#{driverTripsBean.violationEvents}" var="violation">
						violation = new GLatLng(#{violation.latitude}, #{violation.longitude});
						map.addOverlay(createMarker(violation, "#{violation.noteID}", "#{facesContext.externalContext.request.contextPath}/images/ico_violation.png"));
					</ui:repeat>
				}

				var idleMarker;
				if(showIdleMarkers == true)
				{
					var idle;
					<ui:repeat value="#{driverTripsBean.idleEvents}" var="idle">
						idle = new GLatLng(#{idle.latitude}, #{idle.longitude});
						map.addOverlay(createMarker(idle, "#{idle.noteID}", "#{facesContext.externalContext.request.contextPath}/images/ico_idle.png"));
					</ui:repeat>
				}	

				if(showTamperMarkers == true)
				{
					var idle;
					<ui:repeat value="#{driverTripsBean.tamperEvents}" var="tamperEvent">
						idle = new GLatLng(#{tamperEvent.latitude}, #{tamperEvent.longitude});
						map.addOverlay(createMarker(idle, "#{tamperEvent.noteID}", "#{facesContext.externalContext.request.contextPath}/images/ico_tampering.png"));
					</ui:repeat>
				}	
			}
		
		</script>
        </rich:panel>

    </ui:define>
    <ui:param name="homeSelected" value="current" />
    <ui:param name="helpFile" value="Trips.htm" />

    <ui:define name="content">
        <t:saveState value="#{driverTripsBean.trips}" />
        <t:saveState value="#{driverTripsBean.numTrips}" />
        <t:saveState value="#{driverTripsBean.allEvents}" />
        <t:saveState value="#{driverTripsBean.selectedVehicle}" />
        <t:saveState value="#{driverTripsBean.violationEvents}" />
        <t:saveState value="#{driverTripsBean.idleEvents}" />
        <t:saveState value="#{driverTripsBean.identifiableEntityBean}"></t:saveState>
        <t:saveState value="#{driverTripsBean.groupTreeNodeImpl}"></t:saveState>
        <t:saveState value="#{driverTripsBean.selectedTrip}"></t:saveState>
        <t:saveState value="#{driverTripsBean.startDate}"></t:saveState>
        <t:saveState value="#{driverTripsBean.endDate}"></t:saveState>
        <t:saveState value="#{driverTripsBean.startDatePrev}"></t:saveState>
        <t:saveState value="#{driverTripsBean.endDatePrev}"></t:saveState>
        

        <rich:panel id="bubbles">
            <!-- BEGIN GOOGLE BUBBLES -->
            <ui:repeat value="#{driverTripsBean.selectedTrips}" var="trip">
                <ui:include src="/includes/tripBubble.xhtml">
                    <ui:param name="hiddenDivID" value="#{trip.trip.startTime}_START" />
                    <ui:param name="bubbleTitle" value="#{messages.TRIP_START}" />
                    <ui:param name="timeZoneObject" value="#{driverTripsBean.timeZone}" />
                    <ui:param name="eventDateTime" value="#{trip.trip.startTime}" />
                    <ui:param name="eventLocation" value="#{trip.startAddress}" />
                    <ui:param name="datePattern" value="#{messages.dateTimeFormat}" />
 					<ui:param name="context" value="driverTripsStart" />
                </ui:include>
                <ui:include src="/includes/tripBubble.xhtml">
                    <ui:param name="hiddenDivID" value="#{trip.trip.endTime}_END" />
                    <ui:param name="bubbleTitle" value="#{messages.TRIP_END}" />
                    <ui:param name="eventDateTime" value="#{trip.trip.endTime}" />
                    <ui:param name="eventLocation" value="#{trip.endAddress}" />
                    <ui:param name="timeZoneObject" value="#{driverTripsBean.timeZone}" />
                    <ui:param name="datePattern" value="#{messages.dateTimeFormat}" />
  					<ui:param name="context" value="driverTripsEnd" />
                </ui:include>
                <ui:include src="/includes/tripBubble.xhtml">
                    <ui:param name="hiddenDivID" value="#{trip.trip.endTime}_INPROGRESS" />
                    <ui:param name="bubbleTitle" value="#{messages.TRIP_INPROGRESS}" />
                    <ui:param name="eventDateTime" value="#{trip.trip.endTime}" />
                    <ui:param name="eventLocation" value="#{trip.endAddress}" />
                    <ui:param name="timeZoneObject" value="#{driverTripsBean.timeZone}" />
                    <ui:param name="datePattern" value="#{messages.dateTimeFormat}" />
 					<ui:param name="context" value="driverTripsInProgress" />
                </ui:include>
            </ui:repeat>
            <ui:repeat value="#{driverTripsBean.allEvents}" var="violation">
                <ui:include src="/includes/eventBubble.xhtml">
                    <ui:param name="hiddenDivID" value="#{violation.noteID}" />
                    <ui:param name="eventType" value="#{violation.eventType}" />
                    <ui:param name="eventDateTime" value="#{violation.time}" />
                    <ui:param name="eventLocation" value="#{violation.addressStr}" />
                    <ui:param name="timeZoneObject" value="#{driverTripsBean.timeZone}" />
                    <ui:param name="datePattern" value="#{messages.dateTimeFormat}" />
                    <ui:param name="eventSpeedLimit" value="#{violation.speedLimit}" />
                    <ui:param name="eventAvgSpeed" value="#{violation.avgSpeed}" />
                    <ui:param name="eventTopSpeed" value="#{violation.topSpeed}" />
                    <ui:param name="eventDistance" value="#{violation.distance}" />
                    <ui:param name="eventSpeed" value="#{violation.speed}" />
                    <ui:param name="eventSeverity" value="#{violation.severity}" />
                    <ui:param name="eventLowIdle" value="#{violation.lowIdleDuration}" />
                    <ui:param name="eventHighIdle" value="#{violation.highIdleDuration}" />
 					<ui:param name="context" value="driverTrips" />
                </ui:include>
            </ui:repeat>
        </rich:panel>

        <!-- END GOOGLE BUBBLES -->

        <div id="wrapper"><h:form>
            <ul id="grid_nav">
                <li class="l grid_icon"><h:graphicImage value="/images/ico_line.png" /></li>
                <li class="l grid_title">#{messages.drivertrip_title}:
                     <pretty:link id="driverTripsDriverPerformance1" mappingId="driverPerformance">
                        <h:outputText value=" #{driverTripsBean.identifiableEntityBean.name}"/>
                        <f:param value="#{driverTripsBean.identifiableEntityBean.id}"/>
                     </pretty:link>
                        
                </li>
                <li class="l divider"><h:graphicImage value="/images/grid_nav_divider.png" /></li>

                <li class="l">
                  <ui:include src="/includes/breadcrumb.xhtml">
                    <ui:param name="groupTreeNode" value="#{driverTripsBean.groupTreeNodeImpl}" />
                    <ui:param name="lastBreadCrumb" value="true" />
  					<ui:param name="context" value="driverTrips" />
                   </ui:include>
                </li>
               
                <li class="l" style="margin-left: -15px;">
                  <ul id="breadcrumb">
                     <li>
                        <h:graphicImage value="/images/x.gif" width="10" height="10" />
                        <pretty:link id="driverTripsDriverPerformance2" mappingId="driverPerformance">
                           <h:outputText value="#{driverTripsBean.identifiableEntityBean.longName}"/>
                           <f:param value="#{driverTripsBean.identifiableEntityBean.id}"/>
                        </pretty:link>
                     </li>
                     <li class="last">
                           <h:graphicImage value="/images/x.gif" width="10" height="10" />
                           #{messages.drivertrip_trips}
                     </li>
                  </ul>
                </li>
            </ul>
        </h:form>
        <div class="spacer"></div>
        <table width="940" border="0" cellspacing="0" cellpadding="0" align="center">
            <tr>
                <td width="330" valign="top"><!-- START PANEL -->
                <div class=""><rich:panel id="date_picker_panel">
                    <a4j:region id="dateFormRegion">
                        <a4j:form id="dateForm">
                            <div class="panel_nw">
                            <div class="panel_title"><span class="cal">#{messages.drivertrip_date_range}</span> <span class="panel_links"> <a4j:status id="dateFormStatus"
                                for="dateFormRegion">
                                <f:facet name="start">
                                    <h:outputText>
                                        <img src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif" align="top" />&#160;</h:outputText>
                                </f:facet>
                            </a4j:status> </span></div>
                            </div>
                            <div class="panel_w">
                            <div class="panel_content">

                            <table width="320" cellpadding="4" cellspacing="0" class="" id="">
                                <tbody>
                                    <tr>
                                        <td width="80">#{messages.drivertrip_start_date}</td>
                                        <td width="178"><a4j:outputPanel id="calendarStart" layout="block">
                                            <rich:calendar value="#{driverTripsBean.startDate}" locale="en/US" popup="true" immediate="true" datePattern="#{messages.dateFormat}"
                                                showApplyButton="false" cellWidth="24px" cellHeight="22px" />
                                        </a4j:outputPanel></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td>#{messages.drivertrip_end_date}</td>
                                        <td><a4j:outputPanel id="calendarEnd" layout="block">
                                            <rich:calendar value="#{driverTripsBean.endDate}" locale="en/US" popup="true" immediate="true" datePattern="#{messages.dateFormat}"
                                                showApplyButton="false" cellWidth="24px" cellHeight="22px" />
                                        </a4j:outputPanel></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td></td>
                                        <td><a4j:commandButton id="driverTripsDate" action="#{driverTripsBean.DateChangedAction}"
                                            reRender="dateError,script,statsPanel,tripsPanel,bubbles,selectedTrip,selectedTripMap" immediate="false" styleClass="left"
                                            oncomplete="bodyLoad();">
                                            <span class="edit"> <h:outputText value="#{messages.drivertrip_updateDateRange}" /> </span>
                                        </a4j:commandButton></td>
                                        <td></td>
                                    </tr>
                                    <tr>                                    	
                                    	<td colspan="3" align="center">
                                    		<h:outputText id="dateError" value="#{driverTripsBean.dateStatus}" style="color:#FF0000;font-weight:bold"/>
                                    	</td>                                    
                                    </tr>
                                    
                                </tbody>
                            </table>
                            </div>
                            </div>
                        </a4j:form>
                    </a4j:region>
                </rich:panel>

                <div class="panel_sw">
                <div class="panel_statusbar"></div>
                </div>
                </div>
                <!-- END PANEL -->

                <div class="spacer"></div>

                <!-- START PANEL --> <rich:panel id="statsPanel">
                    <div class="panel_nw">
                        <div class="panel_title">
                            <h:outputText style="" value="#{messages.drivertrip_stats}: "/>
                            <h:outputText value="#{driverTripsBean.startDate}">
                                <f:convertDateTime pattern="#{messages.dateFormat}" timeZone="#{driverTripsBean.timeZone}" />
                            </h:outputText>                            
                            <h:outputText value=" #{messages.drivertrip_to} "/>
                            <h:outputText value="#{driverTripsBean.endDate}">
                                <f:convertDateTime pattern="#{messages.dateFormat}" timeZone="#{driverTripsBean.timeZone}" />
                            </h:outputText> 
                            <span class="panel_links"></span>
                        </div>
                    </div>
                    <div class="panel_w">
                    <div class="panel_content">
                    <div class="" id="">
                    <table id="" cellpadding="4" cellspacing="0" class="">
                        <tbody>
                            <tr>
                                <td>#{messages.drivertrip_total_drive_time}:</td>
                                <td><rich:spacer width="4" /></td>
                                <td><h:outputText>#{driverTripsBean.totalDriveTime}</h:outputText></td>
                            </tr>
                            <tr>
                                <td>
                                    <h:outputFormat value="#{messages.drivertrip_total_miles_driven}">
                                        <a4j:actionparam value="Miles" converter="MeasurementTextConverter"/>
                                    </h:outputFormat>
                                </td>
                                <td></td>
                                <td><h:outputText value="#{driverTripsBean.milesDriven}" converter="DistanceConverter" /></td>
                            </tr>
                            <tr>
                                <td>#{messages.drivertrip_total_idle_time}:</td>
                                <td></td>
                                <td><h:outputText>#{driverTripsBean.idleTime}</h:outputText></td>
                            </tr>
                            <tr>
                                <td>#{messages.drivertrip_total_trips}:</td>
                                <td></td>
                                <td><h:outputText>#{driverTripsBean.numTrips}</h:outputText></td>
                            </tr>
                            <tr>
                                <td valign="top">#{messages.drivertrip_driver_timezone}:</td>
                                <td></td>
                                <td><h:outputText>#{driverTripsBean.timeZoneDisplay}</h:outputText></td>
                            </tr>
                        </tbody>
                    </table>
                    </div>
                    </div>
                    </div>
                    <div class="panel_sw">
                    <div class="panel_statusbar"></div>
                    </div>
                </rich:panel> <!-- END PANEL -->

                <div class="spacer"></div>

                <!-- START PANEL -->
                <div class="">
                <div class="panel_nw">
                <div class="panel_title"><span class="">#{messages.drivertrip_events}</span> <span class="panel_links"></span></div>
                </div>
                <div class="panel_w">
                <div class="panel_content"><!-- Start Trip table --> <rich:panel id="selectedTrip">
                    <a4j:form>
                        <rich:dataTable value="#{driverTripsBean.allEvents}" id="selectedTripTable" var="item" styleClass="datatable" rowClasses="tableOdd,tableEven"
                            rows="5" width="100%" onRowClick="showInfoWindow('#{item.noteID}', new GLatLng(#{item.latitude}, #{item.longitude}));">

                            <!-- Data -->
                            <rich:column sortBy="#{item.addressStr}" style="cursor: pointer;">
                                <h:graphicImage value="/images/ico_idle.png" rendered="#{item.type eq 208}" title="#{messages[item.eventType]}" />
                                <h:graphicImage value="/images/ico_tampering.png" rendered="#{item.type eq 202}" title="#{messages[item.eventType]}" />
                                <h:graphicImage value="/images/ico_violation.png" rendered="#{item.type ne 208 and item.type ne 202}" title="#{messages[item.eventType]}" />
                            </rich:column>

                            <rich:column sortBy="#{item.addressStr}" style="cursor: pointer;">
                                <f:facet name="header">
                                    <h:outputText value="#{messages.drivertrip_event_address}" />
                                </f:facet>
                                <h:outputText value="#{item.addressStr}" />
                            </rich:column>

                            <rich:column sortBy="#{item.time}" style="cursor: pointer;">
                                <f:facet name="header">
                                    <h:outputText value="#{messages.drivertrip_event_datetime}" />
                                </f:facet>

                                <h:outputText value="#{item.time}">
                                    <f:convertDateTime pattern="#{messages.dateTimeFormat}" timeZone="#{driverTripsBean.timeZone}" />
                                </h:outputText>

                            </rich:column>
                        </rich:dataTable>
                     
                        <table align="center"><tr><td>
                        <rich:datascroller align="center" for="selectedTripTable" id="eventScroller"  maxPages="5"
                        				   reRender="selectedTripTable"  styleClass="dataScrollerSmall" renderIfSinglePage="false"/>
                        </td></tr></table>
                    </a4j:form>
                </rich:panel> <!-- End Trip table --></div>
                </div>
                <div class="panel_sw">
                <div class="panel_statusbar"></div>
                </div>
                </div>
                <!-- END PANEL -->

                <div class="spacer"></div>

                <!-- START PANEL -->
                <div class="">
                <div class="panel_nw">
                <div class="panel_title"><span class="">#{messages.drivertrip_settings}</span> <span class="panel_links"></span></div>
                </div>
                <div class="panel_w">
                <div class="panel_content">
                <div class="" id=""><a4j:region id="optionsRegion">
                    <table width="320" cellpadding="4" cellspacing="0" class="" id="settings">
                        <tbody>
                            <tr>
                                <td width="290">#{messages.drivertrip_last_ten_trips}</td>
                                <td width="25"><a4j:status id="showLastTenStatus" for="optionsRegion">
                                    <f:facet name="start">
                                        <h:outputText>
                                            <img src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif" align="top" />&#160;</h:outputText>
                                    </f:facet>
                                </a4j:status></td>
                                <td width="20"><a4j:form id="showLastTenForm">
                                    <h:selectBooleanCheckbox id="showAllCheckBox" value="#{driverTripsBean.showLastTenTrips}">
                                        <a4j:support event="onclick" reRender="script,bubbles,selectedTrip" oncomplete="bodyLoad();" />
                                    </h:selectBooleanCheckbox>
                                </a4j:form></td>
                            </tr>
                            <tr>
                                <td>#{messages.drivertrip_show_idle_marker}</td>
                                <td></td>
                                <td><h:selectBooleanCheckbox id="showIdleCheckBox" value="#{driverTripsBean.showIdleMarkers}" onclick="showIdleChanged();" /></td>
                            </tr>
                            <tr>
                                <td>#{messages.drivertrip_show_warnings}</td>
                                <td></td>
                                <td><h:selectBooleanCheckbox id="showWarningsCheckBox" value="#{driverTripsBean.showWarnings}" onclick="showWarningsChanged();" /></td>
                            </tr>
                            <tr>
                                <td>#{messages.drivertrip_show_tampering}</td>
                                <td></td>
                                <td><h:selectBooleanCheckbox id="showTamperingCheckBox" value="#{driverTripsBean.showTampering}" onclick="showTamperingChanged(this);" /></td>
                            </tr>
                        </tbody>
                    </table>
                </a4j:region></div>
                </div>
                </div>
                <div class="panel_sw">
                <div class="panel_statusbar"></div>
                </div>
                </div>
                <!-- END PANEL -->

                <div class="spacer"></div>

                <!-- START PANEL -->
                <div class="">
                <div class="panel_nw">
                <div class="panel_title"><span class="">#{messages.drivertrip_legend}</span> <span class="panel_links"></span></div>
                </div>
                <div class="panel_w">
                <div class="panel_content">
                <div class="" id="">
                <div class="" id="">
                <table width="320" id="legend" cellpadding="4" cellspacing="0">
                    <tbody>
                        <tr>
                            <td width="25"><img src="#{facesContext.externalContext.request.contextPath}/images/ico_start.png" width="21" height="20" /></td>
                            <td width="120">#{messages.drivertrip_legend_start}</td>
                            <td width="30"><img src="#{facesContext.externalContext.request.contextPath}/images/ico_idle.png" width="20" height="20" /></td>
                            <td width="119">#{messages.drivertrip_legend_engine_idle}</td>
                        </tr>
                        <tr>
                            <td><img src="#{facesContext.externalContext.request.contextPath}/images/ico_violation.png" width="20" height="20" /></td>
                            <td>#{messages.drivertrip_legend_violation}</td>
                            <td><img src="#{facesContext.externalContext.request.contextPath}/images/ico_tampering.png" width="21" height="20" /></td>
                            <td>#{messages.drivertrip_tampering}</td>
                        </tr>
                        <tr>
                        	<td><img src="#{facesContext.externalContext.request.contextPath}/images/ico_end_trip.png" width="21" height="20" /></td>
                            <td>#{messages.drivertrip_legend_end}</td>
                        	<td><img src="#{facesContext.externalContext.request.contextPath}/images/ico_inprogress_trip.png" width="21" height="20" /></td>
                            <td>#{messages.drivertrip_legend_inprogress}</td>
                        </tr>
                    </tbody>
                </table>
                </div>
                </div>
                </div>
                </div>
                <div class="panel_sw">
                <div class="panel_statusbar"></div>
                </div>
                </div>
                <!-- END PANEL --></td>
                <td width="10"><h:graphicImage value="/images/x.gif" width="10" /></td>
                <td width="600" valign="top">    
                <!-- START PANEL -->
                <a4j:region>
                <div class="" style="width: 600px; margin: 0 auto 0 auto;">
                    <div class="panel_nw">                            
                    <div class="panel_title">
                        <h:outputText value="#{messages.drivertrip_trips_by} #{driverTripsBean.identifiableEntityBean.name}" styleClass="vehicle" />            
                        <span class="panel_links">
                        <a4j:status onstop="onReRenderWithSelection();">
                            <f:facet name="start">
                                <h:graphicImage value="/images/progress2.gif" style="padding-left: 10px" />
                            </f:facet>
                        </a4j:status> 
                        </span>
                    </div>
                    </div>
                    <a4j:form id="tripsTableForm">
                    <div class="panel_w">
                        <rich:panel id="tripsPanel" bodyClass="panel_content" align="center">
                        <!-- Start Trip table -->
                            <rich:dataTable value="#{driverTripsBean.trips}" id="tripsTable" var="item"
                            styleClass="datatable" rowClasses="tableOdd,tableEven" rows="4" width="100%">
                                
    
                                <a4j:support event="onRowClick" reRender="script,bubbles,selectedTrip,showLastTenForm,selectVehicleForm" oncomplete="bodyLoad();">
                                    <f:setPropertyActionListener value="#{item}" target="#{driverTripsBean.selectedTrip}" />
                                </a4j:support>
    
                                <rich:column id="date_column" sortBy="#{item.trip.startTime}" label="#{messages.drivertrip_date}" style="white-space:nowrap; cursor: pointer;">
                                    <f:facet name="header">
                                        <h:outputText value="#{messages.drivertrip_date}" />
                                    </f:facet>
                                    <h:outputText value="#{item.dateShort}" />
                                </rich:column>
    
                                <rich:column id="time_column" sortBy="#{item.trip.startTime}" label="#{messages.drivertrip_time}" style="white-space:nowrap; cursor: pointer;">
                                    <f:facet name="header">
                                        <h:outputText value="#{messages.drivertrip_time}" />
                                    </f:facet>
                                    <h:outputText value="#{item.timeStartShort}" />
                                    <br />
                                    <h:outputText value="#{item.timeEndShort}" />
                                </rich:column>
    
                                <rich:column id="distance_column" sortBy="#{item.distance}" label="#{messages.drivertrip_distance}" style="white-space:nowrap; cursor: pointer;">
                                    <f:facet name="header">
                                        <h:outputText value="#{messages.drivertrip_distance}" />
                                    </f:facet>
                                    <h:outputText value="#{item.distance}" converter="MilesToKilometersConverter" />#{' '}<h:outputText value="mi" converter="MeasurementTextConverter" />
                                </rich:column>
    
                                <rich:column id="end_column" sortBy="#{item.endAddress}" label="#{messages.drivertrip_end_address}" style="cursor: pointer;">
                                    <f:facet name="header">
                                        <h:outputText value="#{messages.drivertrip_end_address}" />
                                    </f:facet>
                                    <h:outputText value="#{item.endAddress}" />
                                </rich:column>
    
                                <rich:column id="duration_column" sortBy="#{item.duration}" label="#{messages.drivertrip_duration}" style="white-space:nowrap; cursor: pointer;">
                                    <f:facet name="header">
                                        <h:outputText value="#{messages.drivertrip_duration}" />
                                    </f:facet>
                                    <h:outputText value="#{item.duration}" />
                                </rich:column>
                            </rich:dataTable>
                          <rich:datascroller align="center" for="tripsTable" oncomplete="onReRender();" id="scroller" styleClass="dataScrollerSmall"
                          renderIfSinglePage="false"/>
                        
                        <rich:jQuery selector="document" query="ready(function(){onReRender()})" />
                        <!-- End Trip table -->
                    </rich:panel>                    
                    </div>                    
                    </a4j:form>
                <div class="panel_sw">
                <div class="panel_statusbar"></div>
                </div>
                </div>
                </a4j:region>
                <!-- END PANEL -->

                <div class="spacer"></div>

                <!-- START PANEL -->
                <div class="" style="width: 600px; margin: 0 auto 0 auto;">
                <div class="panel_nw">
                <div class="panel_title">
	                  <h:form id="selectVehicleForm">
	                    <span class="map">
		                    <h:outputText value="">#{messages.drivertrip_vehicle}</h:outputText><rich:spacer width="5" />
                            <c:if test="#{driverTripsBean.selectedVehicle ne null}">
                              <pretty:link id="driverTripsVehiclePerformance" mappingId="vehiclePerformance">
                                 <h:outputText value="#{driverTripsBean.selectedVehicle.name}"/>
                                 <f:param value="#{driverTripsBean.selectedVehicle.vehicleID}"/>
                               </pretty:link>
                            </c:if>
                            
	                    </span>
	                    <span class="panel_links"></span>
	                </h:form>
                </div>
                </div>
                <div class="panel_w"><a4j:form id="selectedTripMap">
                    <rich:panel bodyClass="panel_content">
                        <h:outputText rendered="#{driverTripsBean.numTrips gt 0}">
                            <h:panelGroup styleClass="map-border" layout="block">
                                <div id="map-canvas" style="width: 588px; height: 400px; border: 0"></div>
                            </h:panelGroup>
                        </h:outputText>

                        <h:outputText rendered="#{driverTripsBean.numTrips lt 1}">
                            <h2>#{messages.no_trips_found}</h2>
                        </h:outputText>
                    </rich:panel>
                </a4j:form></div>
                <div class="panel_sw">
                <div class="panel_statusbar"></div>
                </div>
                </div>
                <!-- END PANEL --></td>
            </tr>
        </table>
        </div>
    </ui:define>

</ui:composition>

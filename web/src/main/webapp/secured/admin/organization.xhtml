<ui:composition template="/layout/layout.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:security="http://pro.tiwi.com/jsf/security"
	xmlns:t="http://myfaces.apache.org/tomahawk"
	>

	<ui:param name="adminSelected" value="current" />

	<ui:define name="scripts">
		<script
			src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=#{gmBean.key}"
			type="text/javascript"></script>
	</ui:define>

	<ui:define name="content">
		
		
		<t:saveState value="#{organizationBean.topLevelNodes}"/>
		<t:saveState value="#{organizationBean.groupState}"/>
		<t:saveState value="#{organizationBean.selectedGroupNode}"/>
		<t:saveState value="#{organizationBean.inProgressGroupNode}"/>
		<t:saveState value="#{organizationBean.selectedParentGroup}"/>
		
		
		<table width="920" border="0" cellspacing="0" cellpadding="0"
			align="center" style="margin: 0 auto 0 auto;">
			<tr>
				<td valign="top" width="130"><ui:include
					src="/includes/adminSideNav.xhtml">
					<ui:param name="selectedAction" value="go_adminOrganization" />
				</ui:include></td>
				<td valign="top"><!-- START PANEL --> <a4j:form id="display-form">

					<div class="">
					<div class="panel_nw">
					<div class="panel_title"><span class="admin"><h:outputText
						value="#{messages.adminHeader_organization}" /></span> <span
						class="panel_links"></span></div>
					</div>

					<div class="panel_w">

					<div class="panel_content">
					<table>
						<tr>
							<td valign="top">
							<div style="textAlign: top; width: 233px">
							<ul id="grid_nav">
								<li class="l grid_icon"><h:graphicImage
									value="/images/ico_building.png" /></li>
								<li class="l grid_title">#{organizationBean.accountName}</li>
							</ul>
								<!-- Can't seem to set the immediate to true. When doing so, on select, the node is being set
									to a SwingTreeNodeImpl -->
								<a4j:region>
								<h:panelGroup id="organizationTreePanel">
									<rich:tree 
										id="tree"
										switchType="ajax" 
										selectedClass="selectedNode"
										style="overflow: auto;width:210px;height:650px;border-left:1px solid #A1C667;border-right:1px solid #A1C667;border-bottom:1px solid #A1C667; margin-left: 11px"
										value="#{organizationBean.topLevelNodes}" 
										var="item"
										nodeFace="#{item.data.treeNodeType}"
										nodeSelectListener="#{organizationBean.selectNode}"
										reRender="groupPanel,driverPanel,vehiclePanel"
										dragValue="#{item.data}" dropValue="#{item.data}"
										adviseNodeSelected="#{organizationBean.adviseNodeSelected}"
										ajaxSubmitSelection="true"
										ondrop="doRefreshTree()"
										false="true"
										dragIndicator="indicator"
										dropListener="#{organizationBean.processDrop}">
										<rich:treeNode type="FLEET" iconLeaf="/images/ico_truck.png"
											icon="/images/ico_truck.png" acceptedTypes="DIVISION,TEAM"
											dragType="FLEET">
											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
											<h:outputText value="#{item.label}" />
										</rich:treeNode>
										<rich:treeNode type="DIVISION"
											iconLeaf="/images/ico_trucks.png"
											icon="/images/ico_trucks.png" acceptedTypes="DIVISION,TEAM"
											dragType="DIVISION">
											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
											<h:outputText value="#{item.label}" />
										</rich:treeNode>
										<rich:treeNode type="TEAM" iconLeaf="/images/ico_team.png"
											icon="/images/ico_team.png"
											dragType="TEAM">
											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
											<h:outputText value="#{item.label}" />
										</rich:treeNode>
										<rich:treeNode type="DRIVER" iconLeaf="/images/ico_driver.png"
											icon="/images/ico_team.png">
											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
											<h:outputText value="#{item.label}" />
										</rich:treeNode>
										<rich:treeNode type="VEHICLE"
											iconLeaf="/images/ico_vehicle.png"
											icon="/images/ico_team.png">
											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
											<h:outputText value="#{item.label}" />
										</rich:treeNode>
									</rich:tree>
									<!--
										adviseNodeSelected="#{organizationBean.adviseNodeSelected}" 
										adviseNodeOpened="#{organizationBean.adviseNodeExpanded}"
										changeExpandListener="#{organizationBean.changeExpandListent}"
										adviseNodeSelected="#{organizationBean.adviseNodeSelected}"
										dragValue="#{node.data}" dropValue="#{node.data}"
									-->
								</h:panelGroup>
								</a4j:region>
								<rich:dragIndicator id="indicator" />
								<script type="text/javascript">
									function doRefreshTree(){
										setTimeout('refreshTree()', 200)
						
										}
									
								</script>
								 <a4j:jsFunction name="refreshTree"
								reRender="organizationTreePanel,groupPanel">
								</a4j:jsFunction>
							</div>
							</td>
							<td valign="top">
							<a4j:region>
							<div style="text-align: top; width: 550px; height: 100%"><h:panelGroup
								id="contentPanel">
								<!-- 
								The GROUP PANEL, DRIVER PANEL, AND VEHICLE PANEL are all here at the same level. When an action is fired we only want to reRender
								each panel individually. If we reRender a higher level panel, the the map gets reloaded and the page is much slower. To speed up
								performance, we have the map at this level as well
								 -->
								<h:panelGroup id="groupPanel">
									<h:outputText
										rendered="#{organizationBean.selectedGroupNode ne null and organizationBean.selectedGroupNode.group ne null}">
										<h:outputText
											rendered="#{organizationBean.groupState eq 'VIEW'}">
											<ui:include src="/includes/admin/groupView.xhtml">
												<ui:param name="groupTreeNode"
													value="#{organizationBean.selectedGroupNode}" />
											</ui:include>
										</h:outputText>

										<h:outputText
											rendered="#{organizationBean.groupState ne 'VIEW'}">
											<ui:include src="/includes/admin/groupEdit.xhtml">
												<ui:param name="groupTreeNode"
													value="#{organizationBean.inProgressGroupNode}" />
											</ui:include>

										</h:outputText>
									</h:outputText>
									
								</h:panelGroup>

								<h:panelGroup id="driverPanel">
									<h:outputText
										rendered="#{organizationBean.selectedGroupNode.treeNodeType eq 'DRIVER'}">

										<ui:include src="/includes/admin/driverSubview.xhtml">
											<ui:param name="driver"
												value="#{organizationBean.selectedGroupNode.driver}" />
										</ui:include>
									</h:outputText>
								</h:panelGroup>

								<h:panelGroup id="vehiclePanel">

									<h:outputText
										rendered="#{organizationBean.selectedGroupNode.treeNodeType eq 'VEHICLE'}">
										<ui:include src="/includes/admin/vehicleSubview.xhtml">
											<ui:param name="vehicle"
												value="#{organizationBean.selectedGroupNode.vehicle}" />
										</ui:include>
									</h:outputText>
								</h:panelGroup>


							</h:panelGroup></div></a4j:region>
							</td>
						</tr>
					</table>
					</div>
					</div>
					</div>
					<div class="panel_sw">
					<div class="panel_statusbar"></div>
					</div>
				</a4j:form> <!-- END PANEL --></td>
			</tr>

		</table>

	</ui:define>

</ui:composition>
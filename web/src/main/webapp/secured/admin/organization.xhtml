<ui:composition template="/layout/layout.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:c="http://java.sun.com/jstl/core"
	xmlns:security="http://pro.tiwi.com/jsf/security"
	xmlns:t="http://myfaces.apache.org/tomahawk">
   
    <ui:param name="title" value="#{messages.adminHeader_organization}"/>
	<ui:param name="adminSelected" value="current" />
    <ui:param name="helpFile" value="Organization.htm" />
	<ui:define name="scripts">
		<script src="http://maps.google.com/maps?file=api&amp;v=#{gmBean.version}&amp;key=#{gmBean.key}&amp;hl=#{localeBean.locale.language}" type="text/javascript"></script>
        <script src="#{facesContext.externalContext.request.contextPath}/js/mapstraction/mapstraction.js" type="text/javascript"></script>
        <script src="http://dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6"></script>
	</ui:define>

	<ui:define name="content">
		<t:saveState value="#{organizationBean}"/>
		
		<table width="920" border="0" cellspacing="0" cellpadding="0"
			align="center" style="margin: 0 auto 0 auto;">
			<tr>
				<td valign="top" width="130"><ui:include
					src="/includes/adminSideNav.xhtml">
					<ui:param name="selectedAction" value="go_adminOrganization" />
				</ui:include></td>
				<td valign="top">
				  <a4j:form id="display-form">
					<div class="">
					<div class="panel_nw">
					<div class="panel_title"><span class="admin"><h:outputText
						value="#{messages.adminHeader_organization}" /></span> 
					</div>
					</div>

					<div class="panel_w">

					<div class="panel_content">
					<table>
						<tr>
							<td valign="top">
							<div style="textAlign: top; width: 233px">
							<ul id="grid_nav">
								<li class="l grid_icon"><h:graphicImage
									value="/images/ico_building.png" /></li>
								<li class="l grid_title">#{organizationBean.accountName}</li>
								<li class="r grid_icon">
									<a4j:status	id="overview_ajax_status" for="treeViewRegion">
										<f:facet name="start">
											<h:outputText>
											<img
												 src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif"
												align="top" />&#160;</h:outputText>
										</f:facet>
									</a4j:status>
								</li>
							</ul>
								<!-- Can't seem to set the immediate to true. When doing so, on select, the node is being set
									to a SwingTreeNodeImpl -->
								<a4j:region id="treeViewRegion">
      								<h:panelGroup id="organizationTreePanel">
      									<rich:tree 
      										id="tree"
      										switchType="ajax" 
      										selectedClass="selectedNode"
      										style="overflow: auto;width:210px;height:740px;border-left:1px solid #A1C667;border-right:1px solid #A1C667;border-bottom:1px solid #A1C667; margin-left: 11px"
      										value="#{organizationBean.rootGroupNode}" 
      										var="item"
      										nodeFace="#{item.data.treeNodeType}"
      										nodeSelectListener="#{organizationBean.selectNode}"
      										reRender="contentPanel"
      										adviseNodeSelected="#{organizationBean.adviseNodeSelected}"
      										adviseNodeOpened="#{organizationBean.adviseNodeExpanded}"
      										changeExpandListener="#{organizationBean.changeExpandListener}"
      										ajaxSubmitSelection="true">
      										<rich:treeNode type="FLEET" iconLeaf="/images/ico_truck.png"
      											icon="/images/ico_truck.png">
      											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
      											<h:outputText value="#{item.label}" />
      										</rich:treeNode>
      										<rich:treeNode type="DIVISION"
      											iconLeaf="/images/ico_trucks.png"
      											icon="/images/ico_trucks.png">
      											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
      											<h:outputText value="#{item.label}" />
      										</rich:treeNode>
      										<rich:treeNode type="TEAM" iconLeaf="/images/ico_team.png"
      											icon="/images/ico_team.png">
      											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
      											<h:outputText value="#{item.label}" />
      										</rich:treeNode>
      										<rich:treeNode type="DRIVER" iconLeaf="/images/ico_steering_wheel.png"
      											icon="/images/ico_steering_wheel.png">
      											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
      											<h:outputText value="#{item.label}" />
      										</rich:treeNode>
      										<rich:treeNode type="VEHICLE"
      											iconLeaf="/images/ico_vehicle.png"
      											icon="/images/ico_vehicle.png">
      											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
      											<h:outputText value="#{item.label}" />
      										</rich:treeNode>
                                              <rich:treeNode type="DEVICE"
                                                iconLeaf="/images/ico_tiwi.png"
                                                icon="/images/ico_tiwi.png">
                                                <rich:dndParam name="label" type="drag" value="#{item.label}"/>
                                                <h:outputText value="#{item.label}" />
                                              </rich:treeNode>
                                              <rich:treeNode type="USER" iconLeaf="/images/ico_driver.png" 
      											icon="/images/ico_driver.png">
      											<rich:dndParam name="label" type="drag" value="#{item.label}"/>
      											<h:outputText value="#{item.label}" />
      										</rich:treeNode>
      									</rich:tree>
      								</h:panelGroup>
								</a4j:region>
								<rich:dragIndicator id="indicator" />
                                <!-- onDrop of a tree node reRender tree. Also set the deleay to 200 -->
								<script type="text/javascript">
									function doRefreshTree(){
										setTimeout('refreshTree()', 200)
										}
                                    function submitSelection()
                                    {
                                        
                                    }
									
								</script>
							   <a4j:jsFunction name="refreshTree" reRender="organizationTreePanel,groupPanel">
							   </a4j:jsFunction>
                               
							</div>
							</td>
							<td valign="top">
							<a4j:region>
							<div style="text-align: top; width: 550px; height: 100%"><h:panelGroup
								id="contentPanel">
								<!-- 
								The GROUP PANEL, DRIVER PANEL, AND VEHICLE PANEL are all here at the same level. When an action is fired we only want to reRender
								each panel individually. 
								 -->
								
                                
      							<ui:fragment
      								rendered="#{organizationBean.selectedTreeNode.treeNodeType eq 'FLEET' || organizationBean.selectedTreeNode.treeNodeType eq 'DIVISION' || organizationBean.selectedTreeNode.treeNodeType eq 'TEAM'}">
      								<ui:fragment
      									rendered="#{organizationBean.groupState eq 'VIEW'}">
      									<ui:include src="/includes/admin/groupView.xhtml">
      										<ui:param name="groupTreeNode"
      											value="#{organizationBean.selectedGroupNode}" />
      									</ui:include>
      								</ui:fragment>
      
      								<ui:fragment
      									rendered="#{organizationBean.groupState ne 'VIEW'}">
      									<ui:include src="/includes/admin/groupEdit.xhtml">
      										<ui:param name="groupTreeNode"
      											value="#{organizationBean.tempGroupTreeNode}" />
      									</ui:include>
      
      								</ui:fragment>
      							</ui:fragment>
      							
      							<ui:fragment
      								rendered="#{organizationBean.selectedTreeNode.treeNodeType eq 'DRIVER'}">
      
      								<ui:include src="/includes/admin/personSummary.xhtml">
      									<ui:param name="driver"
      										value="#{organizationBean.selectedDriverTreeNode.driver}" />
                                        <ui:param name="person"
                                             value="#{organizationBean.selectedDriverTreeNode.driver.person}" />
                                        <ui:param name="device"
                                             value="#{organizationBean.selectedDriverTreeNode.device}" />
                                        <ui:param name="vehicle"
                                             value="#{organizationBean.selectedDriverTreeNode.vehicle}" />
      								</ui:include>
                                </ui:fragment>
                                
                                <ui:fragment
                                    rendered="#{organizationBean.selectedTreeNode.treeNodeType eq 'USER'}">
      
                                   <ui:include src="/includes/admin/personSummary.xhtml">
                                       <ui:param name="user"
                                             value="#{organizationBean.selectedUserTreeNode.user}" />
                                       <ui:param name="person"
                                             value="#{organizationBean.selectedUserTreeNode.user.person}" />
                                   </ui:include>
                                </ui:fragment>

      							<ui:fragment
      								rendered="#{organizationBean.selectedTreeNode.treeNodeType eq 'VEHICLE'}">
      								<ui:include src="/includes/admin/vehicleSummary.xhtml">
      									<ui:param name="vehicle"
      										value="#{organizationBean.selectedVehicleTreeNode.vehicle}" />
                                        <ui:param name="driver"
                                            value="#{organizationBean.selectedVehicleTreeNode.driver}" />
                                        <ui:param name="device"
                                   	        value="#{organizationBean.selectedVehicleTreeNode.device}" />
      								</ui:include>
      						   </ui:fragment>
                           
                               <ui:fragment
                                    rendered="#{organizationBean.selectedTreeNode.treeNodeType eq 'DEVICE'}">
                                    <ui:include src="/includes/admin/deviceSummary.xhtml">
                                       <ui:param name="device"
                                             value="#{organizationBean.selectedDeviceTreeNode.device}" />
                                       <ui:param name="vehicle"
                                             value="#{organizationBean.selectedDeviceTreeNode.vehicle}" />
                                       <ui:param name="driver"
                                             value="#{organizationBean.selectedDeviceTreeNode.driver}" />
                                    </ui:include>
                               </ui:fragment>
							</h:panelGroup>
                           </div>
                        </a4j:region>
							</td>
						</tr>
					</table>
					</div>
					</div>
					</div>
					<div class="panel_sw">
					<div class="panel_statusbar"></div>
					</div>
				</a4j:form> <!-- END PANEL --></td>
			</tr>

		</table>
		<ui:include src="/includes/confirmDelete.xhtml">
	      <ui:param name="deleteBean" value="#{organizationBean}" />
	      <ui:param name="explanation" value="#{messages.group_delete_confirmation}" />
	      <ui:param name="reRender" value="contentPanel,organizationTreePanel" />
	    </ui:include>
    
	    <script type="text/javascript">	
	    	function bodyLoad()
	    	{
	        	initMap();
	    	}
	    </script>
       
	</ui:define>

</ui:composition>
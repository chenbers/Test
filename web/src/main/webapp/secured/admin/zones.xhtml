<ui:composition template="/layout/layout.xhtml"
              xmlns="http://www.w3.org/1999/xhtml"
              xmlns:ui="http://java.sun.com/jsf/facelets"
              xmlns:h="http://java.sun.com/jsf/html"
              xmlns:rich="http://richfaces.org/rich"
              xmlns:a4j="http://richfaces.org/a4j"
              xmlns:f="http://java.sun.com/jsf/core"
              xmlns:c="http://java.sun.com/jstl/core"
              xmlns:security="http://pro.tiwi.com/jsf/security"
              xmlns:t="http://myfaces.apache.org/tomahawk">

  <ui:param name="adminSelected" value="current" />
  <ui:param name="helpFile" value="#{zonesBean.helpFile}" />
  <ui:param name="title" value="#{messages.adminHeader_zones}"/>
  
  <ui:define name="scripts">
  	<style>
  		.col1 {
  			width: 80%;
  		}
  		.col2 {
  			width: 20%;
  			vertical-align:top;
  		}
  	</style>
    <a4j:loadScript src="#{googleMapURLBean.mapUrl}&amp;hl=#{localeBean.locale.language}" />
    <a4j:loadScript src="/js/mapGeocode.js" />
    <a4j:loadScript src="/js/drawZone.js" />
    
	<ui:include src="/includes/WMSMapLayers.xhtml"/>	
    <script type="text/javascript">    
       var map;
    </script>
  </ui:define>
  
  <ui:define name="content">
    <t:saveState value="#{zonesBean}"></t:saveState>
    <table width="920" border="0" cellspacing="0" cellpadding="0" align="center" style="margin: 0 auto 0 auto;">
      <tr>
        <td valign="top" width="130">
          <ui:include src="/includes/navigation/adminSideNav.xhtml">
            <ui:param name="selectedAction" value="go_adminZones" />
            <ui:param name="parentAction" value="go_adminZones" />
            <ui:param name="context" value="zones"/>
          </ui:include>
        </td>
        <td valign="top">
          <!-- START PANEL -->
          <div class="">
            <div class="panel_nw">
              <div class="panel_title">
                <span class="zones"><h:outputText value="#{messages.adminHeader_zones}" /></span>
                <span class="panel_links">
                  
                </span>
              </div>
            </div>

            <div class="panel_w">
              <div class="panel_content">

                <a4j:form id="zones-form">
                  <h:inputHidden id="points" value="#{zonesBean.pointsString}" />
                  <h:inputHidden id="address" value="#{zonesBean.address}" />

                  <input type="hidden" id="firstPoints" value="#{zonesBean.pointsString}" />

                  <rich:messages globalOnly="true" errorClass="error" fatalClass="error" warnClass="warning" infoClass="info" styleClass="msg" />
					
                  <a4j:outputPanel id="displayZone">
                    <h:panelGroup>

                      <ul id="grid_nav" style="margin: 0;">
                        <li class="l">
                          <table border="0" cellspacing="0" cellpadding="4" id="grid_nav_search_box">
                            <tr>
                              <td>
                                <h:graphicImage value="/images/ico_zone.png" style="vertical-align:-30%" />
                                <strong><h:outputText value="#{messages.zones_zone}" /></strong>
                              </td>
                              <td>
                                <h:selectOneMenu value="#{zonesBean.itemID}" id="zone" style="width: 200px">
                                  <f:selectItems value="#{zonesBean.zoneIDs}" />
                                  <a4j:support event="onchange" reRender="points,address,displayZone,displayZoneOptions" oncomplete="showZone(false)" />
                                </h:selectOneMenu>
                              </td>
                            </tr>
                          </table>
                        </li>
                        <ui:fragment rendered="#{zonesBean.zonesCount gt 0}">
                          <li class="l"><h:commandButton id="zonesEdit" action="#{zonesBean.edit}" reRender="displayZone,zoneName,zoneAddress,headerForm" oncomplete="showZone(true)" styleClass="left"><span class="edit"><h:outputText value="#{messages.button_edit}" /></span></h:commandButton></li>
                          <li class="l"><a4j:commandButton id="zonesClone" action="#{zonesBean.cloneZone}" reRender="displayZone,zoneName,zoneAddress,headerForm" oncomplete="showZone(true)" styleClass="left"><span class="add"><h:outputText value="#{messages.zones_clone}" /></span></a4j:commandButton></li>
                          <li class="l"><button id="zonesSubmit" type="submit" class="left" onclick="Richfaces.showModalPanel('confirmDelete'); return false;"><span class="delete"><h:outputText value="#{messages.button_delete}" /></span></button></li>
                        </ui:fragment>
                        <li class="r">
                          <h:commandButton id="zonesAdd" action="#{zonesBean.add}" oncomplete="clearOutline()" reRender="displayZone,headerForm" styleClass="left"><span class="add"><h:outputText value="#{messages.zones_addZone}" /></span></h:commandButton>
                          <ui:fragment rendered="#{zonesBean.zonesCount gt 0}">
                            <h:outputText value=" " />
                            <h:commandButton id="zoneAlertAdd" action="#{zoneAlertsBean.add}" styleClass="left">
                              <f:param name="zoneID" value="#{zonesBean.item.zoneID}" />
                              <span class="addZoneAlert"><h:outputText value="#{messages.zones_addZoneAlert}" /></span>
                            </h:commandButton>
                          </ui:fragment>
                        </li>
                      </ul>

                    </h:panelGroup>
                  </a4j:outputPanel>

                  <div class="spacer"></div>

				  <h:panelGrid columns="2" width="100%" columnClasses="col1,col2">
                  <h:panelGroup styleClass="map-border" layout="block">
                  
                    <div id="map-canvas" style="height:100%;height:600px;border:0"></div>
                    <div id="map-cover" style="position:absolute; display:none; overflow:hidden; cursor:crosshair; zIndex:101;">
                      <div id="rect-outline" style="position:absolute; display:none; border:2px dotted #0033FF"></div>
                      <div id="circle-outline" style="display:none"></div>
                    </div>
                  </h:panelGroup>
                  <a4j:outputPanel id="displayZoneOptions">
                    <h:panelGroup>
						<rich:dataTable value="#{zonesBean.availableZoneOptions}" var="option" styleClass="datatable"
              				rowClasses="tableOdd,tableEven" width="270">
              				<rich:column>
                				<f:facet name="header">
				                <h:outputText value="#{messages.zoneOption}" />
				                </f:facet>
				                <h:outputText value="#{messages[option.name]}" />
				              </rich:column>
              				<rich:column>
                				<f:facet name="header">
				                <h:outputText value="#{messages.zoneOptionValue}" />
				                </f:facet>
				                <h:outputText value="#{messages[zonesBean.optionsMap[option].name]}"  rendered="#{zonesBean.optionsMap[option].name != null}"/>
				                <h:outputText value="#{zonesBean.optionsMap[option]}"  rendered="#{zonesBean.optionsMap[option].name == null}"/>
				              </rich:column>
              				<rich:column>
                				<f:facet name="header">
				                </f:facet>
				                <h:outputText value="*"  rendered="#{option.waySmartOnly}"/>
				              </rich:column>
                    	</rich:dataTable>
                    	<rich:spacer height="5px"/><br/>
                    	<h:outputText value="#{messages.waysmartOnly}" escape="false"/>
					</h:panelGroup>
				   </a4j:outputPanel>
				   </h:panelGrid>
                </a4j:form>

                <script type="text/javascript">
                  function clearOutline()
                  {
                    document.getElementById("zones-form:points").value = "";
                    map.clearOverlays();
                  }

                  function showZone(editable)
                  {
                    map.clearOverlays();
                    var outline = fromOutlineString(document.getElementById("zones-form:points").value);
                    if (outline)
                    {
                      centerMapAtZone(getLatLngBounds(outline));
                      loadZone(outline, editable);
                      return true;
                    }
                    return false;
                  }

                  function storeOutline()
                  {
                    document.getElementById("zones-form:points").value = toOutlineString(getPolygonOutline());
                  }

                  function cancelEdit()
                  {
                    stopDrawing();
                    map.clearOverlays();
                    var outline = document.getElementById("backupPoints").value;
                    if (outline == "")
                      outline = document.getElementById("firstPoints").value;
                    document.getElementById("zones-form:points").value = outline;
                  }

                  function select(type)
                  {
                    applyImage("hand", type);
                    applyImage("rectangle", type);
                    applyImage("circle", type);
                    applyImage("polygon", type);

                    if (type != "hand")
                      map.clearOverlays();
                  }

                  function applyImage(type, selectedType)
                  {
                    var image = document.getElementById("zones-form:" + type + "_b");
                    if (type == selectedType)
                      image.src = "#{facesContext.externalContext.requestContextPath}/images/btn_" + type + "_on.png";
                    else
                      image.src = "#{facesContext.externalContext.requestContextPath}/images/btn_" + type + ".png";
                  }

                  function bodyLoad()
                  {
                    if (GBrowserIsCompatible())
                    {
                      	map = new GMap2(document.getElementById("map-canvas"));
	          	        addLayers();
	
	        	        map.addControl(new GLargeMapControl());
	        	        map.addControl(new GScaleControl());
	        	        map.addControl(new GMenuMapTypeControl(true));
	
	        	        map.enableScrollWheelZoom();
	
						addListeners();
                      GEvent.addListener(drawZone, "startZone", function(type)
                      {
                        select(type);
                      });
                      GEvent.addListener(drawZone, "endZone", function(type, points)
                      {
                        select("hand");
                        storeOutline();
                      });
                      GEvent.addListener(drawZone, "cancelZone", function(type)
                      {
                        showZone(true);
                        select("hand");
                      });
                      GEvent.addListener(drawZone, "updateZone", function(points)
                      {
                        storeOutline();
                      });

                      if (!showZone(false))
                        showAddress("4225 West Lake Park Blvd. Suite 100 West Valley City UT 84120");
                    }
                  }

                  function bodyUnload()
                  {
                    GUnload();
                  }
                </script>

              </div>
            </div>

            <div class="panel_sw">
              <div class="panel_statusbar"></div>
            </div>

            <ui:include src="../../includes/confirmDelete.xhtml">
              <ui:param name="deleteBean" value="#{zonesBean}" />
              <ui:param name="reRender" value="points,displayZone" />
              <ui:param name="ondelete" value="showZone(false)" />
              <ui:param name="explanation" value="#{messages.zones_confirmDelete}" />
       			<ui:param name="context" value="zones" />
            </ui:include>

          </div>

          <!-- END PANEL -->
        </td>

      </tr>
    </table>

  </ui:define>

</ui:composition>

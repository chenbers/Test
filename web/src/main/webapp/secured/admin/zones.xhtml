<ui:composition template="/layout/layout.xhtml"
              xmlns="http://www.w3.org/1999/xhtml"
              xmlns:ui="http://java.sun.com/jsf/facelets"
              xmlns:h="http://java.sun.com/jsf/html"
              xmlns:rich="http://richfaces.org/rich"
              xmlns:a4j="http://richfaces.org/a4j"
              xmlns:f="http://java.sun.com/jsf/core"
              xmlns:security="http://pro.tiwi.com/jsf/security">

  <ui:param name="adminSelected" value="current" />

  <ui:define name="scripts">
    <script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=#{gmBean.key}" type="text/javascript"></script>
  </ui:define>

  <ui:define name="content">

    <table width="920" border="0" cellspacing="0" cellpadding="0" align="center" style="margin: 0 auto 0 auto;">
      <tr>
        <td valign="top" width="130">
          <ui:include src="/includes/adminSideNav.xhtml">
            <ui:param name="selectedAction" value="go_adminZones" />
            <ui:param name="parentAction" value="go_adminZones" />
          </ui:include>
        </td>
        <td valign="top">
          <!-- START PANEL -->
          <div class="">
            <div class="panel_nw">
              <div class="panel_title">
                <span class="zones"><h:outputText value="#{messages.adminHeader_zones}" /></span>
                <span class="panel_links"></span>
              </div>
            </div>

            <div class="panel_w">
              <div class="panel_content">

                <a4j:form id="zones-table-form">

                  <ul id="grid_nav" style="margin: 0;">
                    <li class="l"><h:commandLink action="#{zonesBean.add}"><button value="submit" class="left"><span class="add"><h:outputText value="#{messages.zones_addZone}" /></span></button></h:commandLink></li>
                    <li class="l">
                      <table border="0" cellspacing="0" cellpadding="4" id="grid_nav_search_box">
                        <tr>
                          <td><h:outputText value="#{messages.button_search}" /></td>
                          <td><h:inputText id="filterTable" value="#{zonesBean.filterValue}" class="text" size="25" /></td>
                        </tr>
                      </table>
                    </li>
                    <li class="l"><a4j:commandLink reRender="dataTable,bottomScroller"><button value="submit" class="left"><span class="search"><h:outputText value="#{messages.button_search}" /></span></button></a4j:commandLink></li>
                  </ul>

                  <rich:messages globalOnly="true" errorClass="error" fatalClass="error" warnClass="warning" infoClass="info" styleClass="msg" />

                  <div class="spacer"></div>

                  <div class="datagrid" id="zones_table-paginationListWrapBottom">

                    <rich:dataTable id="dataTable" value="#{zonesBean.items}" var="item" rowKeyVar="index" styleClass="datagrid"
                      rows="5" rowClasses="tableOdd,tableEven" width="100%">
                      <rich:column>
                        <f:facet name="header">
                          <h:outputText value="#{messages.zonesHeader_name}" />
                        </f:facet>
                        <a4j:commandLink action="#{zonesBean.edit}" value="#{item.name}" reRender="zoneName,zoneAddress" oncomplete="/*update the map*/">
                          <f:param name="editID" value="#{item.zoneID}" />
                        </a4j:commandLink>
                      </rich:column>
                      <rich:column>
                        <f:facet name="header">
                          <h:outputText value="#{messages.zonesHeader_created}" />
                        </f:facet>
                        <h:outputText value="#{item.created}">
                          <f:convertDateTime dateStyle="long" type="both" />
                        </h:outputText>
                      </rich:column>
                      <rich:column>
                        <f:facet name="header">
                          <h:outputText value=" " />
                        </f:facet>
                        <a href="#" onclick="Richfaces.showModalPanel('confirmDelete', {}, {deleteID:#{item.zoneID}}); return false;"><h:outputText value="#{messages.adminTable_delete}" /></a>
                      </rich:column>
                    </rich:dataTable>

                    <rich:datascroller id="bottomScroller" for="dataTable" reRender="dataTable" />

                  </div>

                </a4j:form>

                <a4j:form id="zones-edit-form">

                  <ul id="grid_nav" style="margin: 0;">
                    <li class="l">
                      <table border="0" cellspacing="0" cellpadding="4" id="grid_nav_search_box">
                        <tr>
                          <td><h:outputText value="#{messages.zones_name}" /></td>
                          <td>
                            <h:inputText id="zoneName" value="#{zonesBean.editItem.name}" class="text" size="30" maxlength="30" required="#{not empty zonesBean.editItem}" requiredMessage="#{messages.required}" />
                            <rich:message for="zoneName" errorClass="field-error" fatalClass="field-error" warnClass="field-warning" infoClass="field-info" styleClass="field-msg" />
                          </td>
                        </tr>
                      </table>
                    </li>
                    <li class="l divider"><img src="/images/grid_nav_divider.png" /></li>
                    <li class="l">
                      <table border="0" cellspacing="0" cellpadding="4" id="grid_nav_search_box">
                        <tr>
                          <td><h:outputText value="#{messages.zones_address}" /></td>
                          <td>
                            <h:inputText id="zoneAddress" value="#{zonesBean.editItem.address}" class="text" size="30" maxlength="64" required="#{not empty zonesBean.editItem}" requiredMessage="#{messages.required}" />
                            <rich:message for="zoneAddress" errorClass="field-error" fatalClass="field-error" warnClass="field-warning" infoClass="field-info" styleClass="field-msg" />
                          </td>
                        </tr>
                      </table>
                    </li>
                    <li class="l"><a4j:commandLink><button value="submit" class="left"><span class="search"><h:outputText value="#{messages.zones_locate}" /></span></button></a4j:commandLink></li>
                  </ul>
                  <ul id="grid_nav" style="margin: 0;">
                    <li class="l">
                      <table border="0" cellspacing="0" cellpadding="4" id="grid_nav_search_box">
                        <tr>
                          <td><h:outputText value="#{messages.zones_type}" /></td>
                          <td>
                            [zone type buttons]
                          </td>
                        </tr>
                      </table>
                    </li>
                    <li class="r"><a4j:commandLink action="#{zonesBean.save}" reRender="dataTable"><button value="submit" class="left"><span class="save"><h:outputText value="#{messages.zones_save}" /></span></button></a4j:commandLink></li>
                  </ul>

                  <div class="spacer"></div>

                  <h:panelGroup styleClass="map-border" layout="block">
                    <div id="map-canvas" style="height:100%;height:700px;border:0"></div>
                  </h:panelGroup>

                  <script type="text/javascript">
                    if (GBrowserIsCompatible())
                    {
                      map = new GMap2(document.getElementById("map-canvas"));
                      map.addControl(new GLargeMapControl());
                      map.addControl(new GMapTypeControl());
                      map.addControl(new GOverviewMapControl());
                      map.setCenter(new GLatLng(#{driverLocationBean.center.lat}, #{driverLocationBean.center.lng}), 5);
                      map.setMapType(G_NORMAL_MAP);

                      // Create a base icon for all of our markers that specifies the
                      // shadow, icon dimensions, etc.
                      var baseIcon = new GIcon(G_DEFAULT_ICON);
                      baseIcon.shadow = "http://www.google.com/mapfiles/shadow50.png";
                      baseIcon.iconSize = new GSize(20, 34);
                      baseIcon.shadowSize = new GSize(37, 34);
                      baseIcon.iconAnchor = new GPoint(9, 34);
                      baseIcon.infoWindowAnchor = new GPoint(9, 2);

                      // Creates a marker whose info window displays the letter corresponding
                      // to the given index.
                      function createMarker(point, index, name,link)
                      {
                        // Create a lettered icon for this point using our icon class
                        var letter = String.fromCharCode("A".charCodeAt(0) + index);
                        var letteredIcon = new GIcon(baseIcon);
                        letteredIcon.image = "http://www.google.com/mapfiles/marker" + letter + ".png";

                        // Set up our GMarkerOptions object
                        markerOptions = { icon:letteredIcon };
                        var marker = new GMarker(point, markerOptions);

                        GEvent.addListener(marker, "click", function() {
                              marker.openInfoWindowHtml('Driver &#160;<a href="/tiwipro/secured/driver.faces">'+name+'</a>');
                        });
                        return marker;
                      }
                      var i=0;
                      <ui:repeat value="#{driverLocationBean.driverBeans}" var="driver">
                        var latlng = new GLatLng(#{driver.lastLocation.lat}, #{driver.lastLocation.lng});
                        map.addOverlay(createMarker(latlng, i++,  "#{driver.driverName}"));
                      </ui:repeat>
                    }
                  </script>

                </a4j:form>

              </div>
            </div>

            <div class="panel_sw">
              <div class="panel_statusbar"></div>
            </div>

            <ui:include src="../../includes/confirmDelete.xhtml">
              <ui:param name="deleteBean" value="#{zonesBean}" />
              <ui:param name="reRender" value="dataTable" />
              <ui:param name="explanation" value="#{messages.zones_confirmDelete}" />
            </ui:include>

          </div>

          <!-- END PANEL -->
        </td>

      </tr>
    </table>

  </ui:define>

</ui:composition>

<ui:composition template="/layout/layout.xhtml"
              xmlns="http://www.w3.org/1999/xhtml"
              xmlns:ui="http://java.sun.com/jsf/facelets"
              xmlns:h="http://java.sun.com/jsf/html"
              xmlns:rich="http://richfaces.org/rich"
              xmlns:a4j="http://richfaces.org/a4j"
              xmlns:f="http://java.sun.com/jsf/core"
              xmlns:c="http://java.sun.com/jstl/core"
              xmlns:security="http://pro.tiwi.com/jsf/security">
              
	<ui:define name="scripts">
		<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=#{gmBean.key}" type="text/javascript"></script>				
	<script src="#{facesContext.externalContext.request.contextPath}/js/speedByStreet.js"  type="text/javascript">	
	</script>
	</ui:define>  			

  <ui:param name="adminSelected" value="current" />

  <ui:define name="content">

    <table width="920" border="1" cellspacing="0" cellpadding="0" align="center" style="margin: 0 auto 0 auto;">
      <tr>
        <td valign="top" width="130">
          <ui:include src="/includes/adminSideNav.xhtml">
            <ui:param name="selectedAction" value="go_adminSBSCR" />
            <ui:param name="parentAction" value="go_adminSBSCR" />
          </ui:include>
        </td>
       <td valign="top">
          <!-- START PANEL -->
          <div class="">

            <div class="panel_nw">
              <div class="panel_title">
                <span class="admin"><h:outputText value="#{messages.adminHeader_addSpeedLimitChangeRequest}" /></span>
                <span class="panel_links"></span>
              </div>
            </div>
			<div class="panel_w">

				<div class="panel_content">
     <a4j:form id="speedLimitChangeRequestTable">
          <ul id="grid_nav" style="margin: 0;">
            <li class="l"><a4j:commandLink action="#{speedLimitChangeRequests.delete}" reRender="map-data"><button value="submit" class="left" onclick=""><span class="delete"><h:outputText value="#{messages.button_delete}" /></span></button></a4j:commandLink></li>
            <li class="l"><a4j:commandLink><button value="submit" class="left" onclick=""><span class="cancel"><h:outputText value="Clear All" /></span></button></a4j:commandLink></li>
            <li class="l">
              <table border="0" cellspacing="0" cellpadding="4" id="grid_nav_search_box">
                <tr>
         		<td><h:outputText value="#{messages.button_search}" /></td>
         		<td><h:inputText size="40" name="address" id="address" class="text" onkeypress="if (event &amp;&amp; event.keyCode == 13) { document.getElementById('speedLimitChangeRequestTable:searchButton').onclick(); return false; } return true;"/></td>
                 </tr>
              </table>
            </li>
  		<li class="l"><a4j:commandLink><button value="submit" class="left" onclick="showLocation(document.getElementById('speedLimitChangeRequestTable:address').value);"><span class="search"><h:outputText value="Find Address" /></span></button></a4j:commandLink></li>
            <li class="l"><a4j:commandLink action="#{speedLimitChangeRequests.saveRequests}" reRender="map-data"><button value="submit" class="left" onclick=""><span class="edit"><h:outputText value="Submit Request" /></span></button></a4j:commandLink></li>
            </ul>
 				<div class="spacer"></div>			
			 	<table>
				  <tr style=" width : 100%">
			    	<td  valign="top" width="50%">
		<div class="datagrid"><!-- Start Speed Limit Changer Request table --> 
		<rich:panel id="map-data">
		
		
		<rich:dataTable value="#{speedLimitChangeRequests.changeRequests}" id="items"
			var="item" styleClass="datagrid"
			rowClasses="trendTableOdd,trendTableEven" cellspacing="1" rows="100"
			width="50%" onRowClick="this.style.backgroundColor='#DfDfF8'">

			<!-- Data -->
              <rich:column>
                <f:facet name="header">
                  <h:outputText value=" " />
                </f:facet>
                <h:selectBooleanCheckbox value="#{item.selected}" id="c" />
              </rich:column>
 					<rich:column sortBy="#{item.address}" width="38" height="27" >
						<f:facet name="header">
							<h:outputText value="Address" />
						</f:facet>
						<h:outputText value="#{item.address}"/>

					</rich:column>
					<rich:column width="20">
						<f:facet name="header">
							<h:outputText value="MPH" />
						</f:facet>
						<h:outputText value="#{item.speedLimit}"/>

					</rich:column>
					<rich:column width="20">
						<f:facet name="header">
							<h:outputText value="New MPH" />
						</f:facet>
						<h:inputText value="#{item.newSpeedLimit}" immediate="true" required="true" size="3" id="s"/>

					</rich:column>
					<rich:column width="68">
						<f:facet name="header">
							<h:outputText value="Comment" />
						</f:facet>
						<h:inputText value="#{item.comment}" size="10" id="t"/>
						
						
						</rich:column>

					</rich:dataTable>

<script type="text/javascript">
		if (map != null){
	          var gLatLngArray;
	          var polyline;
	          var hipoly;
	          var seg;

		         map.setCenter(new GLatLng(#{speedLimitChangeRequests.maplat},#{speedLimitChangeRequests.maplng}),16);
		        // Do polyline for segment    
		        gLatLngArray = new Array();
		         
		         <ui:repeat value="#{speedLimitChangeRequests.latestChangeRequest.streetSegment}" var="point">
			           var lat = #{point.x};
			           var lng = #{point.y};
			           gLatLngArray.push(new GLatLng(lat,lng));
			  	 </ui:repeat>
		         
		         polyline = new GPolyline(gLatLngArray, "#666666", 10);
		         hipoly = new GPolyline(gLatLngArray, "#ff0000", 10);
		         seg = new StreetSegment();
		         
		         seg.initialize(#{speedLimitChangeRequests.latestChangeRequest.linkId},"#{speedLimitChangeRequests.latestChangeRequest.address}",
		         				"#{speedLimitChangeRequests.latestChangeRequest.zipCode}",
		         				#{speedLimitChangeRequests.latestChangeRequest.category},
		         				#{speedLimitChangeRequests.latestChangeRequest.speedLimit},polyline,hipoly);
		         streetSegments.unshift(seg);
		        
		     	 map.addOverlay(seg.hipoly);
		     	 seg.hipoly.hide();
		         map.addOverlay(seg.polyline);
		 }
</script>
</rich:panel>

</div>

			
			
			          <!-- END PANEL -->
					 </td>
					    <td width="5" valign="top">
					    
							<!-- START PANEL -->
									
								<!-- START FLEET MAP PANEL -->
	<div class="">
		<rich:panel  id="map">
		<div id="map-canvas" style="height:400px;width:400px;border:0"></div>
		<script  type="text/javascript">
	          
			if (GBrowserIsCompatible()) {
	        		var opts = { onMarkersSetCallback: processMarkers, resultList : G_GOOGLEBAR_RESULT_LIST_SUPPRESS, showOnLoad: true};
					map = new GMap2(document.getElementById("map-canvas"), {googleBarOptions: opts});
					map.setCenter(new GLatLng(#{speedLimitChangeRequests.maplat},#{speedLimitChangeRequests.maplng}), #{speedLimitChangeRequests.mapzoom});
					map.addControl(new GLargeMapControl());
					map.addControl(new GMapTypeControl());
					map.addControl(new GOverviewMapControl()); 
					map.setMapType(G_NORMAL_MAP);					
			       	map.enableScrollWheelZoom();
	        		map.enableGoogleBar();
	        		geocoder =new GClientGeocoder();
	        				       
			     	GEvent.addListener(map, "click", function(overlay, point) {
			
			        if (overlay) {
			          
			          	var segment = whichSegment(overlay);
			          	if (segment != null){
			          	
			 				selectSegment(segment.id);
			 			}	
			          } else {
			          
			            reverseGeocode(point.y,point.x,"");
			            
				      }
			        });
  						
      }
 	</script> 
 	</rich:panel>
 	</div>	

							<!-- END PANEL -->
							</td>
					</tr>
			    </table>
</a4j:form>
				</div>
			</div>
          </div>
           <div class="panel_sw">
              <div class="panel_statusbar"></div>
            </div>
          </td>
		</tr>
    </table>


	<a4j:form id="segment">
		<a4j:jsFunction name="addSegment" reRender="map-data" >
			<a4j:actionparam name="lat" assignTo="#{speedLimitChangeRequests.lat}"/>
			<a4j:actionparam name="lng" assignTo="#{speedLimitChangeRequests.lng}"/>
			<a4j:actionparam name="address" assignTo="#{speedLimitChangeRequests.address}"/>
			<a4j:actionparam name="zoom" assignTo="#{speedLimitChangeRequests.mapzoom}"/>
		</a4j:jsFunction>
	</a4j:form>	
	<a4j:form id="delete">
		<a4j:jsFunction name="deleteSelectedSegment" reRender="map-data" >
			<a4j:actionparam name="deleteMe" assignTo="#{speedLimitChangeRequests.deleteMe}"/>
		</a4j:jsFunction>
			
			
	</a4j:form>
					             
  </ui:define>

</ui:composition>

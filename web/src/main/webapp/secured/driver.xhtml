<ui:composition template="/layout/layout.xhtml" 
				xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
	  			xmlns:h="http://java.sun.com/jsf/html" 
	  			xmlns:rich="http://richfaces.org/rich"
	  			xmlns:a4j="http://richfaces.org/a4j"
	  			xmlns:f="http://java.sun.com/jsf/core"
	  			xmlns:c="http://java.sun.com/jstl/core">

	<ui:define name="scripts">
		<script src="#{facesContext.externalContext.request.contextPath}/js/FusionCharts.js" type="text/javascript"></script>	
		<script src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=#{gmBean.key}" type="text/javascript"></script>	
	  	<script	 type="text/javascript">
	  		var baseIcon = new GIcon();
				baseIcon.iconSize = new GSize(21, 20);
				baseIcon.iconAnchor = new GPoint(6, 20);
				baseIcon.infoWindowAnchor = new GPoint(5, 1);
	
			var bounds = new GLatLngBounds();
	  		var map;
	  		function initMap(lat,lng,zoom){
	  		
 					if (GBrowserIsCompatible())
 	  				{
      					map = new GMap2(document.getElementById("map-canvas"));
      					map.addControl(new GLargeMapControl());
      					map.addControl(new GMapTypeControl());
      					map.addControl(new GOverviewMapControl()); 
						map.setCenter(new GLatLng(lat, lng), zoom);
						map.setMapType(G_NORMAL_MAP);
					}
			}
			function drawTrip(){
				var polyline = new GPolyline([
								
				<ui:repeat value="#{driverBean.lastTrip.route}" var="route">
					new GLatLng(#{route.lat}, #{route.lng}),
			  	</ui:repeat>
			  		  //Repeating the last step to finish JS array.
			  		  new GLatLng(#{driverBean.lastTrip.routeLastStep.lat}, #{driverBean.lastTrip.routeLastStep.lng})
				], "#0000ff", 6);
				map.addOverlay(polyline);
	
				//Start of trip marker
				var startlatlng = new GLatLng(#{driverBean.lastTrip.route[0].lat}, #{driverBean.lastTrip.route[0].lng});
				marker = createMarker(startlatlng, "Start of trip.<br />" + "#{driverBean.lastTrip.trip.startTime}<br />#{driverBean.lastTrip.startAddress}",
										"#{facesContext.externalContext.request.contextPath}/images/ico_start.png");
				map.addOverlay(marker);
				bounds.extend(marker.getPoint());
	
				//End of trip marker
				var endlatlng = new GLatLng(#{driverBean.lastTrip.routeLastStep.lat}, #{driverBean.lastTrip.routeLastStep.lng});
				marker = createMarker(endlatlng, "End of trip.<br />" + "#{driverBean.lastTrip.trip.endTime}<br />#{driverBean.lastTrip.endAddress}",
										"#{facesContext.externalContext.request.contextPath}/images/ico_end_trip.png");
				map.addOverlay(marker);
				bounds.extend(marker.getPoint());
	
				//Create Violation markers.
				var violation;
				<ui:repeat value="#{driverBean.violationEvents}" var="violation">
					violation = new GLatLng(#{violation.latitude}, #{violation.longitude});
					map.addOverlay(createMarker(violation, "#{violation.eventType} Violation.<br />#{violation.time}<br />#{violation.addressStr}",
									"#{facesContext.externalContext.request.contextPath}/images/ico_violation.png"));
					//TODO extend bounds
					</ui:repeat>
	
				//Zoom and Center on trip.
				map.setZoom(map.getBoundsZoomLevel(bounds));
			    map.setCenter(bounds.getCenter());
			}
	
		    function createMarker(point, message, iconImage)
	        {
	          var markerIcon = new GIcon(baseIcon);
	          markerIcon.image = iconImage;

	          // Set up our GMarkerOptions object
	          markerOptions = { icon:markerIcon };
	          var marker = new GMarker(point, markerOptions);

	          GEvent.addListener(marker, "click", function() {
	            marker.openInfoWindowHtml("<b>" + message + "</b>");
	          });
	          return marker;
	        }

			function bodyUnload()
			{
				GUnload();
			}
		</script>
	</ui:define>

	<ui:param name="homeSelected" value="current" />
	<ui:param name="helpFile" value="Overall_Score_Driver.htm" />
	
	<ui:define name="content">
<div id="wrapper">

<h:form>
	<ul id="grid_nav">
		<li class="l grid_icon"><h:graphicImage value="/images/ico_line.png" /></li>
		<li class="l grid_title">Driver Performance:&#160;<h:commandLink action="go_driver" value="#{navigationBean.driver.person.fullName}" /></li>
		<li class="l divider"><h:graphicImage value="/images/grid_nav_divider.png" /></li>
		
		<li class="l">
			<ui:include src="/includes/breadcrumb.xhtml">
				<ui:param name="groupTreeNode" value="#{navigationBean.groupTreeNode}" />
				<ui:param name="lastBreadCrumb" value="true" />
			</ui:include>
		</li>
		<li class="l" style="margin-left: -15px;">
			<ul id="breadcrumb">
				<li class="last"><h:outputText value="#{navigationBean.driver.person.fullName}" /></li>
			</ul>
		</li>
	</ul>
</h:form>

<table width="940" border="0" cellspacing="0" cellpadding="0" align="center" class="dash_table">
  <tr>
    <td colspan="3" valign="top">
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="overall">Overall Score </span>
						<a4j:region id="dateLinksForm_region">
							<a4j:form id="dateLinksForm">
							<span class="panel_links">
								<a4j:status id="dateLinksStatus" for="dateLinksForm_region">
									<f:facet name="start">
										<h:outputText><img src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif" align="top" />&#160;</h:outputText>
									</f:facet>
								</a4j:status>
								<rich:spacer width="10" />
								<a4j:commandLink title="#{messages.duration_days}" immediate="true"
									styleClass="#{(driverBean.duration eq 'DAYS') ? 'on' : ''}"		
									reRender="dateLinksForm,overallPanel,speedPanel,stylePanel,seatBeltPanel,mpgPanel,coachingPanel"
									value="#{messages.duration_days}">
									<a4j:actionparam name="duration" assignTo="#{driverBean.duration}"	value="DAYS" />
									<a4j:actionparam name="duration" assignTo="#{driverSpeedBean.duration}"	value="DAYS" />
									<a4j:actionparam name="duration" assignTo="#{driverStyleBean.duration}"	value="DAYS" />
									<a4j:actionparam name="duration" assignTo="#{driverSeatBeltBean.duration}"	value="DAYS" />
								</a4j:commandLink>
								<rich:spacer width="5"></rich:spacer>
								<a4j:commandLink title="#{messages.duration_three}" immediate="true"
									styleClass="#{(driverBean.duration eq 'THREE') ? 'on' : ''}"	
									reRender="dateLinksForm,overallPanel,speedPanel,stylePanel,seatBeltPanel,mpgPanel,coachingPanel"
									value="#{messages.duration_three}">
									<a4j:actionparam name="duration" assignTo="#{driverBean.duration}" value="THREE" />
									<a4j:actionparam name="duration" assignTo="#{driverSpeedBean.duration}"	value="THREE" />
									<a4j:actionparam name="duration" assignTo="#{driverStyleBean.duration}"	value="THREE" />
									<a4j:actionparam name="duration" assignTo="#{driverSeatBeltBean.duration}"	value="THREE" />
								</a4j:commandLink>
								<rich:spacer width="5"></rich:spacer>
								<a4j:commandLink title="#{messages.duration_six}" immediate="true"
									styleClass="#{(driverBean.duration eq 'SIX') ? 'on' : ''}"	
									reRender="dateLinksForm,overallPanel,speedPanel,stylePanel,seatBeltPanel,mpgPanel,coachingPanel"
									value="#{messages.duration_six}">
									<a4j:actionparam name="duration" assignTo="#{driverBean.duration}" value="SIX" />
									<a4j:actionparam name="duration" assignTo="#{driverSpeedBean.duration}"	value="SIX" />
									<a4j:actionparam name="duration" assignTo="#{driverStyleBean.duration}"	value="SIX" />
									<a4j:actionparam name="duration" assignTo="#{driverSeatBeltBean.duration}"	value="SIX" />
								</a4j:commandLink>
								<rich:spacer width="5"></rich:spacer>
								<a4j:commandLink title="#{messages.duration_twelve}" immediate="true"
									styleClass="#{(driverBean.duration eq 'TWELVE') ? 'on' : ''}"	
									reRender="dateLinksForm,overallPanel,speedPanel,stylePanel,seatBeltPanel,mpgPanel,coachingPanel"
									value="#{messages.duration_twelve}">
									<a4j:actionparam name="duration" assignTo="#{driverBean.duration}" value="TWELVE" />
									<a4j:actionparam name="duration" assignTo="#{driverSpeedBean.duration}"	value="TWELVE" />
									<a4j:actionparam name="duration" assignTo="#{driverStyleBean.duration}"	value="TWELVE" />
									<a4j:actionparam name="duration" assignTo="#{driverSeatBeltBean.duration}"	value="TWELVE" />
								</a4j:commandLink>
								</span>
							</a4j:form>
							</a4j:region>
						</div>
				</div>
				<div class="panel_w">
				  <rich:panel bodyClass="panel_content" id="overallPanel" border="0">
				  <table width="920" border="0" cellspacing="0" cellpadding="0" align="center" style="margin: 10px auto 0 auto;">
					  <tr>
						<td valign="top" width="600">
						   <ui:include src="../includes/lineChart.xhtml">
						            <ui:param name="lineChartDef" value="#{driverBean.overallScoreHistory}" />
						            <ui:param name="hiddenFieldID" value="HiddenField" />
						            <ui:param name="width" value="650" /> 
						            <ui:param name="height" value="200" />  
						            <ui:param name="tartgetElementVar" value="targetElement" />
						            <ui:param name="ChartDivID" value="overall_chart" />
						            <ui:param name="chartVar" value="overallChart" />
							</ui:include>
						</td>
						<td valign="top" align="right">
							<table width="220" border="0" cellspacing="0" cellpadding="0" class="scorebox" style="margin: 20px 20px 0 0;">
							  <tr>
								<td>
									<h4>Overall Score</h4>
								</td>
								<td width="80" align="center">
									<ui:include src="../includes/scoreBox.xhtml">
								            <ui:param name="score" value="#{driverBean.overallScore}" />
								            <ui:param name="scoreStyle" value="#{driverBean.overallScoreStyle}" />
									</ui:include>
								</td>
							  </tr>
							</table>
						</td>
					  </tr>
					</table>
				  </rich:panel>
				</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
			<div class="spacer"></div>
		<!-- END PANEL -->
	</td>
    </tr>
  <tr>
    <td colspan="3" valign="top"><h:graphicImage value="/images/x.gif" width="10" height="10" /></td>
    </tr>
  <tr>
    <td width="465" valign="top">

		<!-- START PANEL -->
		
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="speed">Speed</span>
						<span class="panel_links">
							<h:form id="speed_report_link">
							<h:commandLink action="go_reportDriverSpeed" value="view report" />
							</h:form>
						</span>
					</div>
				</div>
					<div class="panel_w">
					  <rich:panel bodyClass="panel_content" id="speedPanel" border="0">
					    <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">                        
                          <tr>
                            <td width="373">
				            <ui:include src="../includes/lineChart.xhtml">
						            <ui:param name="lineChartDef" value="#{driverSpeedBean.speedScoreHistoryOverall}" />
						            <ui:param name="hiddenFieldID" value="HiddenField1" />
						            <ui:param name="width" value="380" /> 
						            <ui:param name="height" value="200" />  
						            <ui:param name="tartgetElementVar" value="targetElement1" />
						            <ui:param name="ChartDivID" value="speed_chart" />
						            <ui:param name="chartVar" value="speed_chart" />
							</ui:include>
							</td>
                            <td width="80" align="center">
							    <ui:include src="../includes/scoreBox.xhtml">
							            <ui:param name="score" value="#{driverSpeedBean.speedScoreOverall}" />
							            <ui:param name="scoreStyle" value="#{driverSpeedBean.speedScoreOverallStyle}" />
								</ui:include>
							</td>
                          </tr>
                        </table>
					  </rich:panel>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
			
		<!-- END PANEL -->
		
		<div class="spacer"></div>
		
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="vehicle">Driving Style</span>
						<span class="panel_links">
							<h:form id="style_report_link">
							<h:commandLink action="go_reportDriverStyle" value="view report" />
							</h:form>
						</span>
					</div>
				</div>
					<div class="panel_w">
					  <rich:panel bodyClass="panel_content" id="stylePanel" border="0">
					    <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
                          <tr>
                            <td width="373">
                      		<ui:include src="../includes/lineChart.xhtml">
						            <ui:param name="lineChartDef" value="#{driverStyleBean.styleScoreHistoryOverall}" />
						            <ui:param name="hiddenFieldID" value="HiddenField2" />
						            <ui:param name="width" value="380" /> 
						            <ui:param name="height" value="200" />  
						            <ui:param name="tartgetElementVar" value="targetElement2" />
						            <ui:param name="ChartDivID" value="style_chart" />
						            <ui:param name="chartVar" value="style_chart" />
							</ui:include>
                            </td>
                            <td width="80" align="center">
                                <ui:include src="../includes/scoreBox.xhtml">
							            <ui:param name="score" value="#{driverStyleBean.styleScoreOverall}" />
							            <ui:param name="scoreStyle" value="#{driverStyleBean.styleScoreOverallStyle}" />
								</ui:include>
                            </td>
                          </tr>
                        </table>
					  </rich:panel>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
		
		<div class="spacer"></div>
		
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="seatbelt">Seat Belt</span>
						<span class="panel_links"><h:form id="seatBelt_report_link"><h:commandLink value="view report" action="go_reportDriverSeatBelt" /></h:form></span></div>
				</div>
					<div class="panel_w">
					  <rich:panel bodyClass="panel_content" id="seatBeltPanel" border="0">
					    <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
                          <tr>
                            <td width="373">
                              <div id="seatbelt_chart"></div>
                      		<ui:include src="../includes/lineChart.xhtml">
						            <ui:param name="lineChartDef" value="#{driverSeatBeltBean.seatBeltScoreHistoryOverall}" />
						            <ui:param name="hiddenFieldID" value="HiddenField3" />
						            <ui:param name="width" value="380" /> 
						            <ui:param name="height" value="200" />
						            <ui:param name="tartgetElementVar" value="targetElement3" />
						            <ui:param name="ChartDivID" value="seatBelt_chart" />
						            <ui:param name="chartVar" value="seatBelt_chart" />
							</ui:include>
                            </td>
                            <td width="80" align="center">
                       	        <ui:include src="../includes/scoreBox.xhtml">
							            <ui:param name="score" value="#{driverSeatBeltBean.seatBeltScore}" />
							            <ui:param name="scoreStyle" value="#{driverSeatBeltBean.seatBeltScoreStyle}" />
								</ui:include>
                            </td>
                          </tr>
                        </table>
					  </rich:panel>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
	</td>
    <td width="10"><h:graphicImage value="/images/x.gif" width="10" /></td>
    <td width="465" valign="top">
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="map">Last Trip:&#160;
						<c:if test="#{driverBean.lastTrip ne null}">
							<h:outputText value="#{driverBean.lastTrip.trip.endTime}">
								<f:convertDateTime pattern="MMM dd, hh:mm a z" timeZone="#{navigationBean.driver.person.timeZone}" timeStyle="short" dateStyle="short"/>
							</h:outputText>
						</c:if>
						</span>
						<span class="panel_links"><h:form><h:commandLink value="view all trips" action="go_driverTrips">
						</h:commandLink></h:form></span>
					</div>
				</div>
					<div class="panel_w">
					  <div class="panel_content">
					  
					  	<h:panelGroup styleClass="map-border" layout="block">
							<c:if test="#{driverBean.hasLastTrip eq false}">
	  							<h3>#{messages.no_trips_found}</h3>
	  						</c:if>
							<div id="map-canvas" style="width:458px;height:300px;border:0"></div>
					  	</h:panelGroup>
					  	
					  	<c:if test="#{driverBean.hasLastTrip eq true}">
						    <script type="text/JavaScript">
						    	initMap(#{driverBean.lastTrip.routeLastStep.lat}, #{driverBean.lastTrip.routeLastStep.lng}, 14);
						    	drawTrip();
	    					</script>
    					</c:if>
					  </div>
					</div>
					
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
		
		<div class="spacer"></div>
				
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="gas">Miles Per Gallon</span>
					</div>
				</div>
					<div class="panel_w">
					  <rich:panel bodyClass="panel_content" id="mpgPanel" border="0">
					    <table width="450" border="0" align="center" cellpadding="0" cellspacing="0">
                          <tr>
                            <td>
                            <rich:panel id="mpg_chart"></rich:panel>
                            <h:inputHidden value="#{driverBean.mpgHistory}" id="hiddenField5" />
							<script type="text/javascript">
								var targetElement5 = document.getElementById("hiddenField5");
								var chart = new FusionCharts("#{facesContext.externalContext.request.contextPath}/fusioncharts/MSArea.swf", "ChartId", "450", "300", "0", "0");
								chart.setDataXML(targetElement5.value);
								chart.render("mpg_chart");
							</script>
                            </td>
                          </tr>
                        </table>
					  </rich:panel>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
		
		<div class="spacer"></div>
		
		<!-- START PANEL -->
			<div class="">
				<div class="panel_nw">
					<div class="panel_title">
						<span class="coaching">Coaching Events </span>
					</div>
				</div>
					<div class="panel_w">
					  <rich:panel bodyClass="panel_content" id="coachingPanel" border="0">
					    <table width="450" border="0" align="center" cellpadding="0" cellspacing="0">
                          <tr>
                            <td>
                            <ui:include src="../includes/lineChart.xhtml">
						            <ui:param name="lineChartDef" value="#{driverBean.coachingHistory}" />
						            <ui:param name="hiddenFieldID" value="HiddenField4" />
						            <ui:param name="width" value="450" /> 
						            <ui:param name="height" value="200" />
						            <ui:param name="tartgetElementVar" value="targetElement4" />
						            <ui:param name="ChartDivID" value="coaching_chart" />
						            <ui:param name="chartVar" value="coaching_chart" />
							</ui:include>
                            </td>
                          </tr>
                        </table>
					  </rich:panel>
					</div>
				<div class="panel_sw">
					<div class="panel_statusbar"></div>
				</div>
			</div>
		<!-- END PANEL -->
	</td>
  </tr>
</table>
</div>
	<script type="text/JavaScript">
		   initMap(#{driverBean.lastTrip.routeLastStep.lat}, #{driverBean.lastTrip.routeLastStep.lng}, 14);
		   drawTrip();
 	</script>

</ui:define>
</ui:composition>

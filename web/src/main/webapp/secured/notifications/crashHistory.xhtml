<ui:composition	template="notifications.xhtml" 
				xmlns="http://www.w3.org/1999/xhtml" 
				xmlns:ui="http://java.sun.com/jsf/facelets"
  				xmlns:h="http://java.sun.com/jsf/html" 
  				xmlns:rich="http://richfaces.org/rich"
  				xmlns:a4j="http://richfaces.org/a4j"
  				xmlns:iwi="http://pro.tiwi.com/jsf"
  				xmlns:f="http://java.sun.com/jsf/core"
                xmlns:c="http://java.sun.com/jstl/core"
	            xmlns:t="http://myfaces.apache.org/tomahawk"
                xmlns:pretty="http://ocpsoft.com/prettyfaces"
                xmlns:security="http://pro.tiwi.com/jsf/security">
	
	<ui:param name="crashhistorySubSelected" value="current" />
	<ui:param name="helpFile" value="CrashHistory.htm" />
    <ui:param name="ajaxPanels" value="crashHistoryTable,crashHistorySearch"/>
    <ui:param name="context" value="crashHistory"/>
    
    <ui:define name="scripts">
        <script src="http://maps.google.com/maps?file=api&amp;v=#{gmBean.version}&amp;key=#{gmBean.key}" type="text/javascript"></script>
    
        <script type="text/javascript">  
        var map;
    	
        function initializeCrashMap(lat, lng) 
        {            
          if (GBrowserIsCompatible()) {
            map = new GMap2(document.getElementById("address-canvas"));
            var location = new GLatLng(lat, lng)
            map.addControl(new GLargeMapControl());
            map.setCenter(location, 15);
            map.addOverlay(new GMarker(location)); 
          }
        }
        
        function initializeCrashTable()
        {            
            jQuery(".clickable-map-icon").click(function(){
                var address = jQuery(this).siblings("[id$='addressToolTip']").find("[id$='address']").text();
                jQuery('#mapModalHeader').text("#{messages.driver_event_location} " + address);
              });
            jQuery('.dr-table-row:has(a[name*="excluded"]) a').css("color","#cccccc");
            jQuery('.dr-table-row:has(a[name*="excluded"]) td').css("color","#cccccc");
          }

		/* CreateMarker(GLatLng, divID, GIcon or null)
		 *	
		 * Creates a marker using specified GIcon or
		 * default icon if null is passed for iconImage.
		 * divID is the id of a DIV you want displayed in the info window. 
		 */
        function createMarker(point, divID, iconImage) 
        {
        	var markerIcon;
        	var marker;

			//Use passed in image.
        	if(iconImage != null)
        	{
				markerIcon = new GIcon(baseIcon);
	       	    markerIcon.image = iconImage;
	       	 	markerOptions = { icon:markerIcon };
	       	 	marker = new GMarker(point, markerOptions);
        	}
        	//Use default GoogleMap marker image.
        	else
        	{
		      	markerIcon = new GIcon();
				marker = new GMarker(point);
        	}
       
       		GEvent.addListener(marker, "click", function() {
					var node = document.getElementById(divID).cloneNode(true);
          			node.style.display = 'block';
		            marker.openInfoWindow(node);
		 			});

        	return marker;
        }
        function tryThis(crashIndex,tableIndex) {           
            var itemToFind =  "crashHistory-form:crashHistory:"+tableIndex+":crashMenu";
            var crash = document.getElementById(itemToFind);          
			var crashID = crash.options[crash.selectedIndex].value;
                      
            updCrshStat(crashID);
        }
		</script>
    </ui:define>    

	<ui:define name="content">
		<t:saveState value="#{crashHistoryBean}"/>
		<table width="940" border="0" align="center" cellpadding="0" cellspacing="0" style="margin: 0 auto 0 auto;">
		  <tr>
		    <td valign="top">
		      <!-- START PANEL -->
		      <h:panelGroup layout="block" styleClass="">
		        <h:panelGroup layout="block" styleClass="panel_nw">
		          <div id="panel_title" class="panel_title"> <span class="crash">#{messages.notes_crashhistory_title}</span>
		          	<span class="panel_links">
                        #{messages.notes_crashhistory_description}
		          	</span>
		           </div>
		        </h:panelGroup>
		
		        <h:panelGroup layout="block" styleClass="panel_w">
		          <h:panelGroup layout="block" styleClass="panel_content">
		
					<a4j:region id="crashHistorySearch_region">
		
					<a4j:form id="crashHistorySearch">							
		            <ul id="grid_nav" style="margin: 0;">
		              <li class="l">
		                <table border="0" cellspacing="0" cellpadding="4" id="grid_nav_search_box">
		                  <tr>
		                    <td>#{messages.notes_crashhistory_search}</td>
		                    <td>
		                      <h:inputText id="searchText" value="#{eventsSearchCoordinationBean.searchFor}" styleClass="text" size="25" onkeypress="if (event &amp;&amp; event.keyCode == 13) { document.getElementById('crashHistorySearch:crashHistorySearch').onclick(); return false; } return true;" />
		                    </td>
		                  </tr>
		                </table>
		              </li>
					  <li class="l">
							<a4j:commandButton id="crashHistorySearch" action="#{crashHistoryBean.searchAction}" 
		            					reRender="navigation:redirectSearch,header,crashHistory-form:crashHistory,crashHistory-form:crashHistory-bottomScroller" styleClass="left">
		            				<span class="search">
		            					<h:outputText value="#{messages.button_search}" />
		            				</span>
		            		</a4j:commandButton>            								
					   </li>
					  <li class="l text">
						<a4j:commandLink id="crashHistoryEditColumns" styleClass="ls_tab_edit_columns" title="#{messages.button_editColumns}" oncomplete="javascript:Richfaces.showModalPanel('editColumns')" 
							reRender="editColumnsForm:editColumnGrid">
							#{messages.button_editColumns}
						</a4j:commandLink>
					  </li>  
					  <li class="l select">
						<h:selectOneMenu value="#{crashHistoryBean.searchCoordinationBean.groupID}" id="crashHistory_groupID"> 
		  		            	<f:selectItem itemLabel="" />
        					    <f:selectItems value="#{crashHistoryBean.teams}" />
						</h:selectOneMenu>
	  		 		 </li>
					  <li class="l">
						<a4j:commandButton id="crashHistoryRefresh" styleClass="left"
									reRender="header,crashHistory-form:crashHistory,crashHistory-form:crashHistory-bottomScroller" 
									action="#{crashHistoryBean.refreshAction}">
		            				<span class="refresh">
		            					<h:outputText value="#{messages.refresh}" />
		            				</span>
						</a4j:commandButton>
					  </li>  
					  <li class="l text">
						<a4j:status id="crashHistoryStatus" for="crashHistorySearch_region">
							<f:facet name="start">
								<h:outputText><img src="#{facesContext.externalContext.request.contextPath}/images/progress2.gif" align="top" />&#160;</h:outputText>
							</f:facet>
						</a4j:status>
					  </li>
					  
					  <security:authorize ifAnyGranted="ROLE_SUPERUSER,ROLE_INTHINC">
					  	<li class="l text">
							<pretty:link id="crashHistoryAdd" mappingId="addCrashReport" styleClass="ls_tab_add_crash">
								#{messages.notes_crashhistory_addnew}
							</pretty:link>
					  	</li>  					  
					  </security:authorize>
					  <li class="r grid_icon">
						<h:panelGroup id="crashHistoryReportToolImageId">
							<h:graphicImage value="/images/ico_tools.png"/>
						</h:panelGroup>
					  </li>
					  	<li class="r divider"><img src="#{facesContext.externalContext.request.contextPath}/images/grid_nav_divider.png" />
					  </li>
		              </ul>
                    
                      <div align="right" style="width: 100%"> 
                         <h:outputFormat id="header" value="#{messages.notes_crashhistory_recordCountHeader}">
							<a4j:actionparam value="#{crashHistoryBean.start}"/>
							<a4j:actionparam value="#{crashHistoryBean.end}"/>
							<a4j:actionparam value="#{crashHistoryBean.maxCount}"/>
						 </h:outputFormat>
                      </div>    
		               	<ui:include src="/includes/reportsContextMenu.xhtml">	
							<ui:param  name="emailModalPanelID" value="crashHistoryReportEmailModal" />
							<ui:param  name="reportBean" value="#{crashHistoryBean}"/>
							<ui:param  name="attachTo" value="crashHistoryReportToolImageId"/>
							<ui:param  name="exportExcel" value="TRUE"/>
    	 					<ui:param name="context" value="crashHistory" />
						</ui:include>
		    		</a4j:form>
		    		</a4j:region>
		    		        
					<div class="spacer"></div>
		            <h:panelGroup id="crashHistoryTable" layout="block" styleClass="datagrid_panel">
						<ui:include src="/includes/crashHistoryTable.xhtml">	
							<ui:param name="numRowsPerPg" value="#{crashHistoryBean.numRowsPerPg}"/>									
		             		<ui:param name="tableData" value="#{crashHistoryBean.tableData}"/>             						
		             		<ui:param name="tableColumns" value="#{crashHistoryBean.tableColumns}"/>
		             		<ui:param name="bean" value="#{crashHistoryBean}"/>
<!--		             		<ui:param name="formId" value="crashHistory_Table_Form"/>-->
		             		<ui:param name="clearTitle" value="#{messages.notes_crashhistory_clearTitle}"/>
		             		<ui:param name="clearInst" value="#{messages.notes_crashhistory_clearInst}"/>
		             		<ui:param name="clearRerender" value="crashHistorySearch:header,crashHistory-form:crashHistory"/>
    	 					<ui:param name="context" value="crashHistory" />
		    			</ui:include>    							
		            </h:panelGroup>					
		     
		            
		          </h:panelGroup>
				</h:panelGroup>
		
				<ui:include src="/includes/editColumnsPopup.xhtml">
					<ui:param name="bean" value="#{crashHistoryBean}"/>	
					<ui:param name="reRender" value="crashHistory-form:crashHistory" />
    	 			<ui:param name="context" value="crashHistory" />
				</ui:include>    
				
		        <h:panelGroup layout="block" styleClass="panel_sw">
		          <h:panelGroup layout="block" styleClass="panel_statusbar"/>
				</h:panelGroup>
		
		      </h:panelGroup>
		      <!-- END PANEL -->
		    </td>
		  </tr>
		</table>    
	<h:outputText id="crashHistory_email_modalPanel">
		<ui:include src="/includes/emailReportPopup.xhtml">	
			<ui:param  name="id" value="crashHistoryReportEmailModal" />
			<ui:param  name="reportBean" value="#{crashHistoryBean}"/>
    	 	<ui:param name="context" value="crashHistory" />
		</ui:include>
	</h:outputText>
	
	</ui:define>

</ui:composition>
<ui:composition template="/layout/layout.xhtml"
	xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:rich="http://richfaces.org/rich"
	xmlns:a4j="http://richfaces.org/a4j"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:security="http://pro.tiwi.com/jsf/security"
    xmlns:tiwiprofn="http://pro.tiwi.com/jsffunctions"
    xmlns:t="http://myfaces.apache.org/tomahawk">

	<ui:param name="adminSelected" value="current" />
    <ui:param name="title" value="#{reportScheduleBean.add ? messages.adminHeader_addReportSchedule : (reportScheduleBean.batchEdit ? messages.adminHeader_editReportSchedules : messages.adminHeader_editReportSchedule)}"/>
	<ui:param name="helpFile" value="Add_Edit_a_Report.htm" />
   
    <ui:define name="scripts">
		<script src="http://maps.google.com/maps?file=api&amp;v=#{gmBean.version}&amp;key=#{gmBean.key}&amp;hl=#{localeBean.locale.language}" type="text/javascript"></script>
        <script src="#{facesContext.externalContext.request.contextPath}/js/mapstraction/mapstraction.js" type="text/javascript"></script>
        <script src="http://dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=6"></script>
	</ui:define>
    
	<ui:define name="content">
		
		<t:saveState value="#{crashReportBean}"></t:saveState>
		
		<script type="text/javascript">
			var map = null;

			function placeMarker(lat,lng){
                
                var point = new GLatLng(lat,lng);
				var marker = new GMarker(point);
				if(map){
					map.clearOverlays();
					map.addOverlay(marker);
			    }
            }
			function initMap()
             {
				if (GBrowserIsCompatible()) {
					
					 GUnload();
					 map = new GMap2(document.getElementById("map-canvas"));

	
	                 map.addControl(new GMapTypeControl());
					 map.setMapType(G_NORMAL_MAP);
					 map.setCenter(new GLatLng(40,-111),12);
	
					 <ui:fragment rendered="#{crashReportBean.useExistingTrip eq 'true'}">
						 GEvent.addListener(map,"click", function(overlay, latlng) {     
							  if (latlng) { 
								 updateLocation(latLng.lat(),latLng.lng());
							  }
						 });
					 </ui:fragment>
	
					 <ui:fragment rendered="#{crashReportBean.useExistingTrip eq 'false'}">
						 GEvent.addListener(map,"click", function(overlay, latLng) {     
							  if (latLng) { 
							    updateLocation(latLng.lat(),latLng.lng());
							  }
						 });
					 </ui:fragment>
					 
					 placeMarker('#{crashReportBean.crashReport.lat}','#{crashReportBean.crashReport.lng}');
				}
                           
             }

            

			
		</script>
		
		
		<table width="920" border="0" cellspacing="0"
			cellpadding="0" align="center" style="margin: 0 auto 0 auto;">
			<tr>
				<td valign="top">
				<a4j:form id="edit-form">
				<div class="">
					<div class="panel_nw">
					<div class="panel_title">
						<span class="email"><h:outputText value="#{messages.crashReport_add}" /></span>
						<span class="panel_links"></span></div>
					</div>

					<div class="panel_w"><!-- MAIN CONTENT -->
						<div class="panel_content">
		                
						<rich:messages globalOnly="true"
							errorClass="error" fatalClass="error" warnClass="warning"
							infoClass="info" styleClass="msg" />
							
						<ul id="grid_nav" style="margin: 0;">
		                   	<li class="r">
		                      <h:commandButton action="#{reportScheduleBean.save}" styleClass="left"><span class="save"><h:outputText value="#{messages.button_save}" /></span></h:commandButton>
		                      <h:outputText value=" " /><h:commandButton action="#{reportScheduleBean.cancelEdit}" immediate="true" styleClass="left"><span class="cancel"><h:outputText value="#{messages.button_cancel}" /></span></h:commandButton>
		                    </li>
		                </ul>
		                
		                <ui:fragment rendered="${tiwiprofn:messagesAvailable()}">
		                  <dl id="display-form:j_id122" class="rich-messages msg" style="">
		                     <dt class="error">
		                        <h:outputFormat value="#{messages.error_validationMsg}">
		                           <f:param value="${tiwiprofn:getMessageCount()}"/>
		                        </h:outputFormat>
		                     </dt>
		                  </dl>
		                </ui:fragment>
					   
						<table width="900" border="0" cellspacing="0" cellpadding="0">
							<tr>
								<td width="425" valign="top" align="left">
			                        <div class="spacer"></div>
									<div class="add_section_title"><h:outputText
										value="#{messages.crashReport_crashDetails}" /></div>
									
									<table width="415" border="0" cellspacing="2" cellpadding="4" align="center">
										<tr>
											<td width="150" valign="top">
												<h:outputText value="#{messages.crashReport_status}" />
												<h:outputText styleClass="required" value=" *" />
											</td>
											<td>
												<rich:message for="status" errorClass="field-error" fatalClass="field-error" warnClass="field-warning" infoClass="field-info" styleClass="field-msg" />
												<h:selectOneMenu value="#{crashReportBean.crashReport.crashReportStatus}" converter="SimpleBeanConverter" required="true" requiredMessage="#{messages.required}">
													<f:selectItems value="#{crashReportBean.crashReportStatusAsSelectItems}"/>
												</h:selectOneMenu>	
											</td>
										</tr>
										<tr>
											<td width="150" valign="top">
												<h:outputText value="#{messages.crashReport_date}" />
												<h:outputText styleClass="required" value=" *" />
											</td>
											<td>
			      								<rich:message for="date" errorClass="field-error" fatalClass="field-error" warnClass="field-warning" infoClass="field-info" styleClass="field-msg" />
												<rich:calendar id="date" value="#{crashReportBean.crashReport.date}" required="true" requiredMessage="#{messages.required}"/>
											</td>
										</tr>
										<tr>
											<td width="150" valign="top">
			                                    <h:outputText value="#{messages.crashReport_vehicle}" />
			                                    <h:outputText styleClass="required" value=" *" />
											</td>
											<td>
												<rich:message for="vehicle" errorClass="field-error" fatalClass="field-error" warnClass="field-warning" infoClass="field-info" styleClass="field-msg" />
												<h:selectOneMenu id="vehicle" value="#{crashReportBean.crashReport.vehicleID}" required="true" requiredMessage="#{messages.required}">
													<f:selectItems value="#{crashReportBean.vehiclesAsSelectItems}"/>
												</h:selectOneMenu>
											</td>
										</tr>
										<tr>
											<td width="150" valign="top">
			                                    <h:outputText value="#{messages.crashReport_driver}" />
			                                    <h:outputText styleClass="required" value=" *" />
											</td>
											<td>
												<rich:message for="driver" errorClass="field-error" fatalClass="field-error" warnClass="field-warning" infoClass="field-info" styleClass="field-msg" />
												<h:selectOneMenu id="driver" value="#{crashReportBean.crashReport.driverID}" required="true" requiredMessage="#{messages.required}">
													<f:selectItems value="#{crashReportBean.driversAsSelectItems}"/>
												</h:selectOneMenu>
											</td>
										</tr>
										<tr>
											<td width="150" valign="top">
												<h:outputText value="#{messages.crashReport_weather}" />
											</td>
											<td>
			      								<rich:message for="weather" errorClass="field-error" fatalClass="field-error" warnClass="field-warning" infoClass="field-info" styleClass="field-msg" />
												<h:inputText id="weather" value="#{crashReportBean.crashReport.weather}" styleClass="text" size="30" maxlength="30"></h:inputText>	
											</td>
										</tr>
										<tr>
											<td width="150" valign="top">
												<h:outputText value="#{messages.crashReport_occupantCount}" />
											</td>
											<td>
												<rich:inputNumberSpinner minValue="0" maxValue="50" value="#{crashReportBean.crashReport.occupantCount}"/>
											</td>
										</tr>
										
										
			                        </table>
								</td>
								<td width="10"><h:graphicImage value="/images/x.gif" width="10" /></td>
								<td width="425" valign="top" align="left">
									
			                        <div class="spacer"></div>
									<div class="add_section_title"><h:outputText
											value="#{messages.crashReport_description}" /></div>
									
									<table width="420" border="0" cellspacing="2" cellpadding="4"
										align="center">
										<tr>
											<td>
												<div class="instructions"><h:outputText value="#{messages.crashReport_descriptionExplanation}" /></div>
												<h:inputTextarea cols ="50" rows="10" value="#{crashReportBean.crashReport.description}" />
											</td>
										</tr>
									</table>
								</td>
							</tr>
						 </table>
						 
						 <div class="spacer"></div>
						 <rich:message for="crashLocation" errorClass="field-error" fatalClass="field-error" warnClass="field-warning" infoClass="field-info" styleClass="field-msg" />
						 <div class="add_section_title"><h:outputText value="#{messages.crashReport_crashLocation}" /><h:outputText styleClass="required" value=" *" /></div>
						 <table width="850" style="padding:10px">
						 	<tr>
						 		<td width="200">
									<h:outputText value="#{messages.crashReport_existingTrip}"/>
								</td>
								<td align="left">
									<a4j:region>
										<h:selectOneRadio value="#{crashReportBean.useExistingTrip}" layout="lineDirection">
											<f:selectItem itemValue="FALSE" itemLabel="No"/>
											<f:selectItem itemValue="TRUE" itemLabel="Yes"/>
											<a4j:support event="onchange" reRender="mapPanel" limitToList="true"/>
										</h:selectOneRadio>
									</a4j:region>
								</td>
						   </tr>
						   <tr>
						   		<td colspan="2">
						   			<rich:panel id="mapPanel">
										<table width="870">
											<tr>
												<ui:fragment rendered="#{crashReportBean.useExistingTrip eq 'true'}">
													<td width="400" valign="top">
														<h:panelGrid columns="2" width="400x">
															<h:outputText value="Vehicle/Driver Search:"></h:outputText>
															<a4j:region>
																<h:selectOneMenu value="#{crashReportBean.entityID}">
																	<f:selectItems value="#{crashReportBean.entitysAsSelectItems}"/>
																	<a4j:support event="onchange" reRender="tripsListPanel" action="#{crashReportBean.loadTrips}"/>
																</h:selectOneMenu>
															</a4j:region>
														</h:panelGrid>
														<rich:spacer height="10px"/>
														<rich:panel id="tripsListPanel">
																<div class="datagrid_panel" style="width: 400px">
																	<h:outputText value="Trips: "/>
																	<rich:spacer height="5px"/>
																	<rich:extendedDataTable value="#{crashReportBean.tripList}"
																	        rowClasses="tableOdd,tableEven"
																	        styleClass="datagrid"
																	        selectionMode="single"
																	        selectedClass="selected-row"
																			var="trip" width="390px" height="450px">
																		<a4j:support event="onRowClick" reRender="script,bubbles,selectedTrip,showLastTenForm,selectVehicleForm" oncomplete="bodyLoad();">
										                                    <f:setPropertyActionListener value="#{trip}" target="#{crashReportBean.selectedTrip}" />
										                                </a4j:support>
																		<rich:column sortBy="#{trip.startTime}" sortOrder="ASCENDING" sortable="false">
																			<f:facet name="header"><h:outputText value="Start"></h:outputText></f:facet>
																			<h:outputText value="#{trip.startTime}">
																				<f:convertDateTime pattern="MMM dd yyyy hh:mm:ss"/>
																			</h:outputText>
																		</rich:column>
																		<rich:column>
																			<f:facet name="header"><h:outputText value="End"></h:outputText></f:facet>
																			<h:outputText value="#{trip.endTime}">
																				<f:convertDateTime pattern="MMM dd yyyy hh:mm:ss"/>
																			</h:outputText>
																		</rich:column>
																	</rich:extendedDataTable> 
																</div>
														</rich:panel>
													</td>	
												</ui:fragment>
												<td>
													
													<div id="map-canvas" style="width: 100%; height: 500px; border: 0"></div>
													
													<script type="text/javascript">
														initMap();
													</script>
													
													<a4j:region>
														<a4j:jsFunction data="#{crashReportBean.crashReport}" name="updateLocation" oncomplete="placeMarker(data.lat,data.lng)" requestDelay="100" limitToList="true">
															<a4j:actionparam name="latitude" assignTo="#{crashReportBean.crashReport.lat}"/>
															<a4j:actionparam name="longitude" assignTo="#{crashReportBean.crashReport.lng}"/>
														</a4j:jsFunction>
													</a4j:region>
												</td>
											</tr>
										</table>
									</rich:panel>
						 		</td>
						 	</tr>
						 </table>
						
						 <div class="required-key"><h:outputText value="#{messages.requiredKey}" /></div>
						 
						 <rich:spacer height="10px"/>
						 
						 <ul id="grid_nav" style="margin: 0;">
		                   	<li class="r">
		                      <h:commandButton action="#{reportScheduleBean.save}" styleClass="left"><span class="save"><h:outputText value="#{messages.button_save}" /></span></h:commandButton>
		                      <h:outputText value=" " /><h:commandButton action="#{reportScheduleBean.cancelEdit}" immediate="true" styleClass="left"><span class="cancel"><h:outputText value="#{messages.button_cancel}" /></span></h:commandButton>
		                    </li>
		                 </ul>
					</div>

				</div>

				<div class="panel_sw">
				<div class="panel_statusbar"></div>
				</div>
				</div>
					</a4j:form>
				</td>
			</tr>
		</table>
	</ui:define>

</ui:composition>
